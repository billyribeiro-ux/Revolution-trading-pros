# Authentication "Stuck After Login" - Root Cause Analysis

**Date:** December 18, 2025  
**Severity:** CRITICAL  
**Status:** FIXED

---

## Executive Summary

Login appeared to succeed (success message shown) but the application didn't proceed because **API requests were being sent to a non-existent Cloudflare Workers URL** instead of the actual Fly.io backend.

---

## Root Cause

### Wrong Hardcoded API URLs

Multiple frontend files had hardcoded URLs pointing to:
```
https://revolution-trading-pros-api.billy-ribeiro.workers.dev
```

This URL returns **404** because the Cloudflare Workers backend was never deployed. The actual backend is on **Fly.io**:
```
https://revolution-trading-pros.fly.dev
```

### Why This Happened

1. Cloudflare Pages doesn't expose `VITE_*` environment variables at runtime
2. The code has fallback hardcoded URLs for when env vars aren't available
3. These fallback URLs were incorrect (pointing to a planned but never-deployed Workers API)

### Affected Files

| File | Issue |
|------|-------|
| `src/lib/api/auth.ts:49` | Wrong PRODUCTION_API_URL |
| `src/routes/+page.server.ts:5` | Wrong PRODUCTION_API_URL |
| `src/routes/+page.svelte:22` | Wrong API_URL |
| `src/lib/api/config.ts:18` | Typo: `-api.fly.dev` instead of `.fly.dev` |

---

## Fixes Applied

All four files updated to use the correct URL:
```typescript
const PRODUCTION_API_URL = 'https://revolution-trading-pros.fly.dev';
```

---

## Additional Issues Found During Audit

### 1. `/api/me` Returns Data Without Authentication (VULNERABILITY)

**Severity:** HIGH

```bash
curl https://revolution-trading-pros.fly.dev/api/me
# Returns full user object without Authorization header!
```

**Fix Required:** Add `auth:sanctum` middleware to the `/api/me` route in Laravel.

### 2. Bearer Token Rejected on `/api/me`

**Severity:** MEDIUM

Tokens returned from login are rejected with 401 when used on `/api/me`, even though the endpoint returns data without auth.

**Investigation Needed:** Check Laravel Sanctum token validation configuration.

### 3. Logout Returns 401

**Severity:** LOW

`POST /api/logout` returns 401 even with a valid token.

---

## What Was Working Correctly

| Component | Status |
|-----------|--------|
| Registration | ✅ Returns 201 with token |
| Login | ✅ Returns 200 with token |
| Input Validation | ✅ Proper 422 errors |
| Rate Limiting | ✅ 5 req/min, returns 429 |
| CORS | ✅ Credentials: true, specific origin |
| Security Headers | ✅ All present (CSP, HSTS, X-Frame-Options, etc.) |
| User Enumeration Prevention | ✅ Identical error messages |

---

## Verification Steps

After deploying the fixes:

1. **Clear browser cache and localStorage**
2. **Test login flow:**
   ```bash
   # Should return 200 with token
   curl -X POST https://revolution-trading-pros.fly.dev/api/login \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com","password":"password"}'
   ```

3. **Verify frontend makes correct API calls:**
   - Open browser DevTools → Network tab
   - Perform login
   - Confirm requests go to `revolution-trading-pros.fly.dev`, NOT `billy-ribeiro.workers.dev`

4. **Test protected routes after login**

---

## Deployment Checklist

- [ ] Deploy frontend changes to Cloudflare Pages
- [ ] Clear Cloudflare cache if needed
- [ ] Test login in production
- [ ] Fix `/api/me` authentication middleware (separate issue)
- [ ] Fix logout endpoint (separate issue)

---

## Lessons Learned

1. **Never hardcode production URLs** — Use environment variables with proper fallbacks
2. **Verify fallback URLs actually work** before deploying
3. **Add health checks** to CI/CD that verify API connectivity
4. **Document which backend is actually deployed** (Fly.io vs Workers vs Laravel)

---

*Report generated by Principal Engineer ICT L11+ Authentication Audit*
