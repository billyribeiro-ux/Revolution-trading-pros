################################################################################
# REVOLUTION TRADING PROS - FLY.IO CONFIGURATION
#
# Stack: Laravel 12 + Octane + FrankenPHP (December 2025)
# Docs: https://fly.io/docs/laravel/
#
# First deploy:
#   fly launch --no-deploy
#   fly postgres create --name revolution-trading-db
#   fly redis create --name revolution-trading-redis
#   fly secrets set APP_KEY=base64:$(openssl rand -base64 32)
#   fly deploy
#
# Commands:
#   fly deploy          - Deploy changes
#   fly logs            - View logs
#   fly ssh console     - SSH into container
#   fly status          - Check status
################################################################################

app = "revolution-trading-pros"
primary_region = "iad"  # US East (Virginia)

[build]
  dockerfile = "Dockerfile"
  target = "production"

[deploy]
  strategy = "rolling"

#------------------------------------------------------------------------------
# Environment Variables (non-secrets)
#------------------------------------------------------------------------------
[env]
  APP_NAME = "Revolution Trading Pros"
  APP_ENV = "production"
  APP_DEBUG = "false"
  APP_URL = "https://revolution-trading-pros.fly.dev"
  LOG_CHANNEL = "stderr"
  LOG_LEVEL = "error"

  # Octane + FrankenPHP
  OCTANE_SERVER = "frankenphp"
  OCTANE_WORKERS = "auto"
  OCTANE_TASK_WORKERS = "auto"
  OCTANE_MAX_REQUESTS = "1000"
  OCTANE_HTTPS = "false"
  OCTANE_CACHE_ENABLED = "true"

  # Database (Fly Postgres - attached automatically)
  DB_CONNECTION = "pgsql"

  # Cache & Session (Fly Redis)
  CACHE_STORE = "redis"
  SESSION_DRIVER = "redis"
  QUEUE_CONNECTION = "redis"
  REDIS_CLIENT = "predis"

  # Storage (Cloudflare R2)
  FILESYSTEM_DISK = "r2"
  MEDIA_DISK = "r2"
  R2_BUCKET = "revolution-trading-media"
  R2_PUBLIC_URL = "https://pub-a6d59af18a9645e6a7b38dca4d53f2af.r2.dev"

  # Security
  BCRYPT_ROUNDS = "12"
  SESSION_ENCRYPT = "true"
  SESSION_SECURE_COOKIE = "true"
  SESSION_SAME_SITE = "lax"
  CORS_ALLOWED_ORIGINS = "https://revolution-trading-pros.pages.dev,https://revolutiontradingpros.com"
  SANCTUM_STATEFUL_DOMAINS = "revolution-trading-pros.pages.dev,revolutiontradingpros.com"

  # Email (Postmark)
  MAIL_MAILER = "postmark"
  MAIL_FROM_ADDRESS = "noreply@revolutiontradingpros.com"
  MAIL_FROM_NAME = "Revolution Trading Pros"

  # Monitoring
  PULSE_ENABLED = "true"
  PULSE_PATH = "pulse"
  HORIZON_PATH = "horizon"

  # Reverb WebSocket
  BROADCAST_CONNECTION = "reverb"
  REVERB_APP_ID = "revolution-trading"
  REVERB_HOST = "revolution-trading-pros.fly.dev"
  REVERB_PORT = "443"
  REVERB_SCHEME = "https"

#------------------------------------------------------------------------------
# HTTP Service Configuration
#------------------------------------------------------------------------------
[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = false   # Keep running for fast response
  auto_start_machines = true
  min_machines_running = 1
  processes = ["app"]

  [http_service.concurrency]
    type = "requests"
    hard_limit = 250
    soft_limit = 200

  [http_service.http_options]
    h2_backend = true

  [[http_service.checks]]
    grace_period = "30s"
    interval = "30s"
    method = "GET"
    path = "/health/live"
    timeout = "10s"

#------------------------------------------------------------------------------
# VM Configuration
#------------------------------------------------------------------------------
[[vm]]
  size = "shared-cpu-1x"
  memory = "1gb"
  cpus = 1

#------------------------------------------------------------------------------
# Process Groups
#------------------------------------------------------------------------------
[processes]
  app = "php artisan octane:start --server=frankenphp --host=0.0.0.0 --port=8080 --workers=auto --task-workers=auto --max-requests=1000"
  worker = "php artisan horizon"
  scheduler = "sh -c 'while true; do php artisan schedule:run --no-interaction; sleep 60; done'"

#------------------------------------------------------------------------------
# Persistent Storage
#------------------------------------------------------------------------------
[[mounts]]
  source = "storage_volume"
  destination = "/app/storage/app"
  initial_size = "1gb"

#------------------------------------------------------------------------------
# Statics (optional - for serving assets from Fly)
#------------------------------------------------------------------------------
[[statics]]
  guest_path = "/app/public"
  url_prefix = "/build"
