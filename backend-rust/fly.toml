# Revolution Trading Pros - Rust API
# Fly.io Deployment Configuration
# ICT 11+ Principal Engineer Grade

app = "revolution-trading-pros-api"
primary_region = "iad"

[build]
dockerfile = "Dockerfile"

[env]
RUST_LOG = "info,sqlx=warn,tower_http=debug"
RUST_BACKTRACE = "1"
HOST = "0.0.0.0"
PORT = "8080"

[http_service]
internal_port = 8080
force_https = true
auto_stop_machines = false
auto_start_machines = true
min_machines_running = 2

[http_service.concurrency]
type = "requests"
hard_limit = 1000
soft_limit = 800

[[services]]
internal_port = 8080
protocol = "tcp"

[[services.ports]]
handlers = ["http"]
port = 80
force_https = true

[[services.ports]]
handlers = ["tls", "http"]
port = 443

[[services.http_checks]]
interval = "10s"
timeout = "2s"
grace_period = "5s"
method = "GET"
path = "/api/health/live"

[[services.tcp_checks]]
interval = "15s"
timeout = "2s"
grace_period = "5s"

[checks]
[checks.health]
port = 8080
type = "http"
interval = "10s"
timeout = "2s"
grace_period = "5s"
method = "GET"
path = "/api/health/ready"

[metrics]
port = 9091
path = "/metrics"

[[vm]]
size = "shared-cpu-2x"
memory = "512mb"
cpus = 2

[deploy]
release_command = "echo 'Deployment starting...'"
strategy = "rolling"

# Secrets (set via fly secrets set)
# DATABASE_URL
# JWT_SECRET
# STRIPE_SECRET_KEY
# STRIPE_WEBHOOK_SECRET
# REDIS_URL
