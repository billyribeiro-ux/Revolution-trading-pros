import{an as f}from"./vendor-svelte.js";import{authStore as o}from"./auth.js";const R={},k=R.VITE_API_URL||"http://localhost:8000/api",E="v1",T=3e4,m=3,S=1e3,g=3e5,v={"X-Requested-With":"XMLHttpRequest","X-Client-Version":"2.0.0","X-Client-Platform":"web"};class c extends Error{constructor(e,t,s){super(e),this.code=t,this.errors=s,this.name="AuthError",Object.setPrototypeOf(this,c.prototype)}}class d extends c{constructor(e,t){super(e,"VALIDATION_ERROR",t),this.name="ValidationError"}}class h extends c{constructor(e="Unauthorized"){super(e,"UNAUTHORIZED"),this.name="UnauthorizedError"}}class _ extends c{constructor(e="MFA verification required"){super(e,"MFA_REQUIRED"),this.name="MFARequiredError"}}class w extends c{constructor(e="Rate limit exceeded",t){super(e,"RATE_LIMITED"),this.retryAfter=t,this.name="RateLimitError"}}class p extends c{constructor(e="Your session has been invalidated"){super(e,"SESSION_INVALIDATED"),this.name="SessionInvalidatedError"}}class u{static instance;tokenRefreshTimeout;sessionCheckInterval;pendingRefresh=null;requestQueue=new Map;sessionFingerprint;abortController;securityObserver;visibilityChangeHandler;onlineHandler;constructor(){this.initialize()}static getInstance(){return u.instance||(u.instance=new u),u.instance}initialize(){}generateSessionFingerprint(){return""}async apiRequest(e,t={}){const{skipAuth:s=!1,retries:n=m,...r}=t,i=`${r.method||"GET"}:${e}`;if(this.requestQueue.has(i)&&r.method==="GET")return this.requestQueue.get(i);const a=this.executeRequest(e,r,s,n);return r.method==="GET"&&(this.requestQueue.set(i,a),a.finally(()=>this.requestQueue.delete(i))),a}async executeRequest(e,t,s,n){this.abortController=new AbortController;const r=setTimeout(()=>this.abortController?.abort(),T);try{const i=await this.buildHeaders(s,t.headers);Object.assign(i,v),this.sessionFingerprint&&(i["X-Session-Fingerprint"]=this.sessionFingerprint);const a=await fetch(`${k}${e}`,{...t,headers:i,signal:this.abortController.signal,credentials:"include"});return clearTimeout(r),await this.handleResponse(a,e,t,s,n)}catch(i){if(clearTimeout(r),n>0&&this.shouldRetry(i)){const a=S*Math.pow(2,m-n);return await new Promise(y=>setTimeout(y,a)),this.executeRequest(e,t,s,n-1)}throw this.transformError(i)}}async buildHeaders(e,t){const s={"Content-Type":"application/json",Accept:"application/json","X-API-Version":E};if(t&&Object.assign(s,t),!e){const r=await this.getValidToken();r&&(s.Authorization=`Bearer ${r}`);const i=o.getSessionId();i&&(s["X-Session-ID"]=i)}const n=this.getCSRFToken();return n&&(s["X-CSRF-Token"]=n),s}async getValidToken(){const e=o.getToken(),t=f(o);if(!e)return null;if(this.isTokenExpiringSoon(t.tokenExpiry??void 0))try{return await this.refreshToken(),o.getToken()}catch{return null}return e}async handleResponse(e,t,s,n,r){if(e.status===429){const i=parseInt(e.headers.get("Retry-After")||"60",10);throw new w("Rate limit exceeded",i)}if(e.status===401&&!n){try{const i=await e.clone().json();if(i.code==="SESSION_INVALIDATED")throw o.setSessionInvalidated(i.message),o.clearAuth(),new p(i.message)}catch(i){if(i instanceof p)throw i}if(r===m)try{return await this.refreshToken(),this.executeRequest(t,s,n,r-1)}catch(i){throw i instanceof p?i:(o.clearAuth(),new h)}throw o.clearAuth(),new h}if(e.status===422){const i=await e.json();throw new d(i.message||"Validation failed",i.errors||{})}if(!e.ok){const i=await e.json().catch(()=>({message:"Request failed"}));throw new c(i.message||`Request failed with status ${e.status}`,i.code)}return e.json()}shouldRetry(e){return e instanceof w||e instanceof d||e instanceof h?!1:e.name==="AbortError"||e.name==="NetworkError"||e instanceof c&&!!e.code?.startsWith("5")}transformError(e){return e instanceof c?e:e.name==="AbortError"?new c("Request timeout","TIMEOUT"):e.name==="NetworkError"?new c("Network error","NETWORK_ERROR"):new c(e.message||"Unknown error","UNKNOWN")}isTokenExpiringSoon(e){return e?Date.now()>e-g:!1}getCSRFToken(){return null}async register(e){if(e.password!==e.password_confirmation)throw new d("Passwords do not match",{password_confirmation:["Password confirmation does not match"]});this.validatePasswordStrength(e.password);const t=await this.apiRequest("/register",{method:"POST",body:JSON.stringify(e),skipAuth:!0});return this.trackEvent("user_registered",{email:e.email}),t.message||"Registration successful. Please check your email to verify your account."}async login(e){const t={...e,device_name:e.device_name||navigator.userAgent,device_fingerprint:this.sessionFingerprint},s=await this.apiRequest("/login",{method:"POST",body:JSON.stringify(t),skipAuth:!0});if(s.mfa_required)throw new _;o.setAuth(s.user,s.token,s.session_id,s.expires_in),s.expires_in&&this.scheduleTokenRefresh(s.expires_in*1e3);try{const n=await this.getUser();return this.trackEvent("user_logged_in",{email:n.email,method:"password"}),n}catch{return s.user}}async loginWithBiometric(e){const t={credential:e,device_id:this.getDeviceId()},s=await this.apiRequest("/login/biometric",{method:"POST",body:JSON.stringify(t),skipAuth:!0});return o.setAuth(s.user,s.token,s.session_id,s.expires_in),s.expires_in&&this.scheduleTokenRefresh(s.expires_in*1e3),this.trackEvent("user_logged_in",{email:s.user.email,method:"biometric"}),s.user}async logout(){try{await this.apiRequest("/logout",{method:"POST"});const e=f(o).user;e&&this.trackEvent("user_logged_out",{email:e.email})}catch{}finally{this.clearAuth()}}async getUser(){const e=await this.apiRequest("/me");return o.setUser(e),e}async updateProfile(e){const t=new FormData;Object.entries(e).forEach(([n,r])=>{r!==void 0&&!(r instanceof File)&&t.append(n,typeof r=="object"?JSON.stringify(r):String(r))}),e.avatar&&t.append("avatar",e.avatar);const s=await this.apiRequest("/me",{method:"PUT",body:t});return o.setUser(s),this.trackEvent("profile_updated",{email:s.email}),s}async changePassword(e){const t=await this.apiRequest("/me/password",{method:"PUT",body:JSON.stringify(e)});return this.trackEvent("password_changed"),e.revoke_sessions&&this.clearAuth(),t.message}async forgotPassword(e){const t=await this.apiRequest("/forgot-password",{method:"POST",body:JSON.stringify(e),skipAuth:!0});return this.trackEvent("password_reset_requested",{email:e.email}),t.message}async resetPassword(e){this.validatePasswordStrength(e.password);const t=await this.apiRequest("/reset-password",{method:"POST",body:JSON.stringify(e),skipAuth:!0});return this.trackEvent("password_reset_completed",{email:e.email}),t.message}async sendEmailVerification(){return(await this.apiRequest("/email/verification-notification",{method:"POST"})).message}async verifyEmail(e,t,s){const n=await this.apiRequest(`/email/verify/${e}/${t}?signature=${s}`,{method:"GET"});return await this.getUser(),this.trackEvent("email_verified"),n.message}async enableMFA(){const e=await this.apiRequest("/me/mfa/enable",{method:"POST"});return this.trackEvent("mfa_setup_initiated"),e}async verifyMFA(e){const t=await this.apiRequest("/me/mfa/verify",{method:"POST",body:JSON.stringify({code:e})});return this.trackEvent("mfa_enabled"),t.message}async disableMFA(e){const t=await this.apiRequest("/me/mfa/disable",{method:"POST",body:JSON.stringify({password:e})});return this.trackEvent("mfa_disabled"),t.message}async loginWithMFA(e,t,s,n){const r=await this.apiRequest("/login/mfa",{method:"POST",body:JSON.stringify({email:e,password:t,mfa_code:s,backup_code:n}),skipAuth:!0});return o.setAuth(r.user,r.token,r.session_id,r.expires_in),r.expires_in&&this.scheduleTokenRefresh(r.expires_in*1e3),this.trackEvent("mfa_login",{email:e}),r}async getSecurityEvents(){return this.apiRequest("/me/security-events")}async getSessions(){return this.apiRequest("/me/sessions")}async revokeSession(e){return this.apiRequest(`/me/sessions/${e}`,{method:"DELETE"})}async logoutAllDevices(e=!1){return this.apiRequest("/me/sessions/logout-all",{method:"POST",body:JSON.stringify({keep_current:e})})}async refreshToken(){if(this.pendingRefresh)return this.pendingRefresh;this.pendingRefresh=this.performTokenRefresh();try{return await this.pendingRefresh}finally{this.pendingRefresh=null}}async performTokenRefresh(){if(!o.getSessionId())throw new h("No session available for refresh");if(!await o.refreshToken())throw new h("Token refresh failed");const s=o.getToken(),n=f(o);if(n.tokenExpiry){const r=n.tokenExpiry-Date.now();r>0&&this.scheduleTokenRefresh(r)}return{token:s||"",refresh_token:"",expires_in:n.tokenExpiry?Math.floor((n.tokenExpiry-Date.now())/1e3):3600}}scheduleTokenRefresh(e){if(this.tokenRefreshTimeout&&clearTimeout(this.tokenRefreshTimeout),!o.getToken())return;const s=e?e-g:g;this.tokenRefreshTimeout=window.setTimeout(()=>{this.refreshToken().catch(n=>{this.clearAuth()})},s)}startSessionMonitoring(){}stopSessionMonitoring(){this.sessionCheckInterval!==void 0&&(clearInterval(this.sessionCheckInterval),delete this.sessionCheckInterval),this.visibilityChangeHandler&&(document.removeEventListener("visibilitychange",this.visibilityChangeHandler),delete this.visibilityChangeHandler),this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),delete this.onlineHandler)}async checkSession(){if(o.getToken())try{await this.apiRequest("/auth/check")}catch(t){t instanceof h&&this.clearAuth()}}clearAuth(){o.clearAuth(),this.tokenRefreshTimeout!==void 0&&(clearTimeout(this.tokenRefreshTimeout),delete this.tokenRefreshTimeout),this.stopSessionMonitoring(),this.abortController?.abort(),this.requestQueue.clear()}setupSecurityMonitoring(){}isTrustedScript(e){return[window.location.origin,"https://cdn.jsdelivr.net","https://unpkg.com","https://www.google-analytics.com","https://www.googletagmanager.com"].some(s=>e.startsWith(s))}validatePasswordStrength(e){const s=/[A-Z]/.test(e),n=/[a-z]/.test(e),r=/\d/.test(e),i=/[!@#$%^&*]/.test(e),a=[];if(e.length<8&&a.push("Password must be at least 8 characters"),s||a.push("Password must contain at least one uppercase letter"),n||a.push("Password must contain at least one lowercase letter"),r||a.push("Password must contain at least one number"),i||a.push("Password must contain at least one special character"),a.length>0)throw new d("Password does not meet requirements",{password:a})}getDeviceId(){return""}trackEvent(e,t){}trackSecurityEvent(e,t){this.apiRequest("/security/events",{method:"POST",body:JSON.stringify({type:e,data:t,timestamp:new Date().toISOString()})}).catch(s=>{})}}u.getInstance();
