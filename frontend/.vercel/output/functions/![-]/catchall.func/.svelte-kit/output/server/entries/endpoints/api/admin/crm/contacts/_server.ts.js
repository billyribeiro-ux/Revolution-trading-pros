import{json as c,error as i}from"@sveltejs/kit";const f="http://localhost:8000/api";function _(e){const t=e.headers.get("Authorization"),a={"Content-Type":"application/json",Accept:"application/json"};return t&&(a.Authorization=t),a}const P=async({url:e,request:t})=>{try{const a=new URLSearchParams,r=e.searchParams.get("status"),s=e.searchParams.get("search"),m=e.searchParams.get("page"),l=e.searchParams.get("limit")||e.searchParams.get("per_page"),h=e.searchParams.get("lifecycle_stage"),d=e.searchParams.get("owner_id"),g=e.searchParams.get("sort_by"),p=e.searchParams.get("sort_order");r&&r!=="all"&&a.set("status",r),s&&a.set("search",s),m&&a.set("page",m),l&&a.set("per_page",l),h&&a.set("lifecycle_stage",h),d&&a.set("owner_id",d),g&&a.set("sort_by",g),p&&a.set("sort_order",p);const u=`${f}/admin/crm/contacts${a.toString()?"?"+a.toString():""}`,n=await fetch(u,{method:"GET",headers:_(t)});if(!n.ok){const w=await n.json().catch(()=>({message:"Failed to fetch contacts"}));return c({success:!1,error:w.message||"Failed to fetch contacts",data:[],meta:{page:1,limit:20,total:0,total_pages:0}},{status:n.status})}const o=await n.json();return c({success:!0,data:o.data||[],meta:{page:o.current_page||1,limit:o.per_page||20,total:o.total||0,total_pages:o.last_page||0}})}catch{return c({success:!1,error:"Failed to connect to backend",data:[],meta:{page:1,limit:20,total:0,total_pages:0}},{status:503})}},j=async({request:e})=>{try{const t=await e.json();if(!t.email)throw i(400,"Email is required");const a=await fetch(`${f}/admin/crm/contacts`,{method:"POST",headers:_(e),body:JSON.stringify({email:t.email,first_name:t.first_name||t.name?.split(" ")[0]||"",last_name:t.last_name||t.name?.split(" ").slice(1).join(" ")||"",phone:t.phone,job_title:t.job_title,source:t.source||"manual",owner_id:t.owner_id,status:t.status||"lead"})});if(!a.ok){const s=await a.json().catch(()=>({message:"Failed to create contact"}));if(a.status===422&&s.errors?.email)throw i(409,"Contact with this email already exists");return c({success:!1,error:s.message||"Failed to create contact",errors:s.errors},{status:a.status})}const r=await a.json();return c({success:!0,data:r},{status:201})}catch(t){throw t instanceof Error&&"status"in t?t:i(500,"Failed to create contact")}};export{P as GET,j as POST};
