import{A as l,z as y}from"./vendor-svelte.js";import{getAuthToken as k}from"./auth.js";const m="http://localhost:8000/api",R="ws://localhost:8000",b=3e4,S=3,v=1e3,C=3e5,E=10,q=100,M=100,P=5,A=3e4;class p{static instance;token=null;refreshToken=null;wsConnection;sseConnection;requestQueue=[];activeRequests=new Map;requestCache=new Map;rateLimiter=new _(M);circuitBreaker=new D;batchQueue=new Map;batchTimer;metrics={totalRequests:0,successfulRequests:0,failedRequests:0,averageResponseTime:0,cacheHitRate:0,errorRate:0,requestsPerMinute:0};loading=l(!1);error=l(null);online=l(!0);performance=l(this.metrics);user=l(null);memberships=l([]);products=l([]);isAuthenticated=y(this.user,e=>e!==null);activeMembership=y(this.memberships,e=>e.find(t=>t.status==="active"));hasActiveSubscription=y(this.activeMembership,e=>e!==void 0);constructor(){this.initialize()}static getInstance(){return p.instance||(p.instance=new p),p.instance}async initialize(){this.loadTokens(),this.setupNetworkMonitoring(),this.setupWebSocket(),this.setupSSE(),this.startRequestProcessor(),this.token&&await this.loadUser(),this.startPerformanceMonitoring()}loadTokens(){if(typeof window<"u"){const e=k();e?this.token=e:this.token=localStorage.getItem("rtp_auth_token"),this.refreshToken=localStorage.getItem("rtp_refresh_token")}}setToken(e,t){this.token=e,this.refreshToken=t||null,typeof window<"u"&&(e?(localStorage.setItem("rtp_auth_token",e),t&&localStorage.setItem("rtp_refresh_token",t)):(localStorage.removeItem("rtp_auth_token"),localStorage.removeItem("rtp_refresh_token"))),this.wsConnection&&this.wsConnection.readyState===WebSocket.OPEN&&this.authenticateWebSocket()}getToken(){const e=k();return e&&(this.token=e),this.token}async request(e,t={}){const s=this.generateRequestId(),a=t.cache?.key||this.getCacheKey(e,t);if(t.cache?.enabled!==!1&&t.method==="GET"){const n=this.getFromCache(a);if(n)return this.updateMetrics({cached:!0}),n}const c=this.activeRequests.get(a);if(c)return c;if(this.circuitBreaker.isOpen())throw{message:"Service temporarily unavailable",status:503,retryAfter:this.circuitBreaker.getTimeUntilReset()};await this.rateLimiter.acquire();const o=this.executeRequest(e,t,s);this.activeRequests.set(a,o);try{const n=await o;return this.activeRequests.delete(a),(t.method==="GET"||!t.method)&&this.setCache(a,n,t.cache?.ttl),t.cache?.invalidate&&this.invalidateCaches(t.cache.invalidate),n}catch(n){throw this.activeRequests.delete(a),n}}async executeRequest(e,t,s){const a=Date.now(),c=this.buildUrl(e,t.params),o={"Content-Type":"application/json",Accept:"application/json","X-Request-ID":s,...t.headers};this.token&&(o.Authorization=`Bearer ${this.token}`);const n={method:t.method||"GET",headers:o,signal:this.createAbortSignal(t.timeout)};t.body&&["POST","PUT","PATCH"].includes(n.method)&&(n.body=JSON.stringify(t.body));let d;const f=t.retry?.attempts||S;for(let h=0;h<f;h++)try{this.loading.set(!0),this.error.set(null);const u=await fetch(c,n);if(!u.ok){const w=await this.handleErrorResponse(u,s);if(this.shouldRetry(w,t.retry)){d=w,await this.delay(this.getRetryDelay(h,t.retry));continue}throw w}const g=await u.json();this.updateMetrics({responseTime:Date.now()-a,success:!0});const T=t.transform?t.transform(g):g;return this.circuitBreaker.recordSuccess(),T}catch(u){if(d=u,!navigator.onLine&&(this.online.set(!1),t.method==="GET"))return this.getOfflineData(e);this.circuitBreaker.recordFailure(),this.updateMetrics({responseTime:Date.now()-a,success:!1})}finally{this.loading.set(!1)}throw d}async handleErrorResponse(e,t){let s={};try{s=await e.json()}catch{}const a={message:s.message||this.getDefaultErrorMessage(e.status),errors:s.errors,status:e.status,code:s.code,timestamp:new Date().toISOString(),requestId:t};switch(e.status){case 401:this.refreshToken?await this.refreshAccessToken():this.handleUnauthenticated();break;case 429:a.retryAfter=parseInt(e.headers.get("Retry-After")||"60");break;case 503:a.retryAfter=30;break}return this.error.set(a),a}async get(e,t){return this.request(e,{...t,method:"GET"})}async post(e,t,s){return this.request(e,{...s,method:"POST",body:t})}async put(e,t,s){return this.request(e,{...s,method:"PUT",body:t})}async patch(e,t,s){return this.request(e,{...s,method:"PATCH",body:t})}async delete(e,t){return this.request(e,{...t,method:"DELETE"})}async register(e){const t=await this.post("/register",e);return this.setToken(t.token,t.refresh_token),this.user.set(t.user),await this.loadUserData(),t}async login(e){const t=this.getDeviceInfo(),s=await this.post("/login",{...e,device_name:e.device_name||t.name});return this.setToken(s.token,s.refresh_token),this.user.set(s.user),await this.loadUserData(),this.setupWebSocket(),s}async logout(){try{await this.post("/logout")}finally{this.setToken(null),this.user.set(null),this.memberships.set([]),this.products.set([]),this.clearCache(),this.wsConnection?.close(),this.sseConnection?.close()}}async refreshAccessToken(){if(!this.refreshToken)throw new Error("No refresh token available");try{const e=await this.post("/auth/refresh",{refresh_token:this.refreshToken});this.setToken(e.token,e.refresh_token)}catch(e){throw this.handleUnauthenticated(),e}}async getMe(){const e=await this.get("/me",{cache:{ttl:6e4}});return this.user.set(e),e}async updateProfile(e){const t=await this.patch("/me",e,{cache:{invalidate:["/me"]}});return this.user.set(t),t}async getMyMemberships(){const e=await this.get("/me/memberships",{cache:{ttl:3e5}});return this.memberships.set(e),e}async getMyProducts(){const e=await this.get("/me/products",{cache:{ttl:3e5}});return this.products.set(e),e}async getIndicators(e){return this.get("/indicators",{params:e,cache:{ttl:6e5}})}async getIndicator(e){return this.get(`/indicators/${e}`,{cache:{ttl:6e5}})}async purchaseProduct(e,t){return this.post("/products/purchase",{product_id:e,payment_method:t},{cache:{invalidate:["/me/products","/me/memberships"]}})}async getPosts(e){return this.get("/posts",{params:e,cache:{ttl:3e5}})}async getPost(e){return this.get(`/posts/${e}`,{cache:{ttl:6e5}})}async createPost(e){return this.post("/posts",e,{cache:{invalidate:["/posts"]}})}async updatePost(e,t){return this.patch(`/posts/${e}`,t,{cache:{invalidate:["/posts",`/posts/${e}`]}})}async uploadFile(e,t){const s=new FormData;s.append("file",e),s.append("type",t);const a=await fetch(`${m}/upload`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`},body:s});if(!a.ok)throw new Error("Upload failed");return a.json()}async batch(e){return this.post("/batch",{operations:e})}async download(e,t){const s=await fetch(`${m}${e}`,{headers:{Authorization:`Bearer ${this.token}`}});if(!s.ok)throw new Error("Download failed");const a=s.body?.getReader(),c=+(s.headers.get("Content-Length")??"0");if(!a)return s.blob();let o=0;const n=[];for(;;){const{done:h,value:u}=await a.read();if(h)break;n.push(u),o+=u.length,t&&c&&t(o/c*100)}const d=new Uint8Array(o);let f=0;for(const h of n)d.set(h,f),f+=h.length;return new Blob([d])}setupWebSocket(){if(!(!this.token||this.wsConnection))try{this.wsConnection=new WebSocket(`${R}/ws`),this.wsConnection.onopen=()=>{this.authenticateWebSocket()},this.wsConnection.onmessage=e=>{this.handleWebSocketMessage(e)},this.wsConnection.onerror=e=>{},this.wsConnection.onclose=()=>{this.wsConnection=void 0,this.token&&setTimeout(()=>this.setupWebSocket(),5e3)}}catch{}}authenticateWebSocket(){this.wsConnection&&this.token&&this.wsConnection.send(JSON.stringify({type:"auth",token:this.token}))}handleWebSocketMessage(e){try{const t=JSON.parse(e.data);switch(t.type){case"user_update":this.user.set(t.data);break;case"membership_update":this.handleMembershipUpdate(t.data);break;case"product_update":this.handleProductUpdate(t.data);break;case"notification":this.handleNotification(t.data);break;case"cache_invalidate":this.invalidateCaches(t.data);break}}catch{}}handleMembershipUpdate(e){this.memberships.update(t=>{const s=t.findIndex(a=>a.id===e.id);return s>=0?t[s]=e:t.push(e),t})}handleProductUpdate(e){this.products.update(t=>{const s=t.findIndex(a=>a.id===e.id);return s>=0?t[s]=e:t.push(e),t})}handleNotification(e){typeof window<"u"&&window.dispatchEvent(new CustomEvent("api:notification",{detail:e}))}setupSSE(){if(this.token)try{this.sseConnection=new EventSource(`${m}/sse`,{withCredentials:!0}),this.sseConnection.onmessage=e=>{this.handleSSEMessage(e)},this.sseConnection.onerror=e=>{this.sseConnection?.close(),this.sseConnection=void 0,this.scheduleSSEReconnect()},this.sseConnection.onopen=()=>{this.sseReconnectAttempts=0}}catch{}}sseReconnectAttempts=0;MAX_SSE_RECONNECT_ATTEMPTS=5;scheduleSSEReconnect(){if(this.sseReconnectAttempts>=this.MAX_SSE_RECONNECT_ATTEMPTS)return;const t=1e3*Math.pow(2,this.sseReconnectAttempts)+Math.random()*1e3;this.sseReconnectAttempts++,setTimeout(()=>{this.token&&this.setupSSE()},t)}handleSSEMessage(e){try{const t=JSON.parse(e.data)}catch{}}buildUrl(e,t){const s=`${m}${e}`;if(!t||Object.keys(t).length===0)return s;const a=new URLSearchParams(Object.entries(t).filter(([c,o])=>o!=null)).toString();return`${s}?${a}`}getCacheKey(e,t){const s=t.params?JSON.stringify(t.params):"";return`${t.method||"GET"}_${e}_${s}`}getFromCache(e){const t=this.requestCache.get(e);return t&&Date.now()<t.expiry?t.data:null}setCache(e,t,s=C){this.requestCache.set(e,{data:t,expiry:Date.now()+s})}invalidateCaches(e){e.forEach(t=>{const s=new RegExp(t);for(const[a]of this.requestCache)s.test(a)&&this.requestCache.delete(a)})}clearCache(){this.requestCache.clear()}createAbortSignal(e=b){const t=new AbortController;return setTimeout(()=>t.abort(),e),t.signal}shouldRetry(e,t){return e.status>=400&&e.status<500&&e.status!==429?!1:t?.condition?t.condition(e):e.status===0||e.status>=500}getRetryDelay(e,t){const s=t?.delay||v;return t?.backoff==="exponential"?s*Math.pow(2,e):s}delay(e){return new Promise(t=>setTimeout(t,e))}generateRequestId(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getDefaultErrorMessage(e){return{400:"Bad request",401:"Unauthorized",403:"Forbidden",404:"Not found",429:"Too many requests",500:"Internal server error",502:"Bad gateway",503:"Service unavailable"}[e]||"An error occurred"}getDeviceInfo(){if(typeof window>"u")return{name:"Server",type:"server"};const e=navigator.userAgent;let t="Unknown Device",s="desktop";return/iPhone|iPad|iPod/.test(e)?(t="iOS Device",s="mobile"):/Android/.test(e)?(t="Android Device",s="mobile"):/Windows/.test(e)?t="Windows PC":/Mac/.test(e)?t="Mac":/Linux/.test(e)&&(t="Linux PC"),{name:t,type:s}}handleUnauthenticated(){this.setToken(null),this.user.set(null),this.memberships.set([]),this.products.set([]),typeof window<"u"&&window.dispatchEvent(new CustomEvent("auth:required"))}async loadUser(){try{await this.getMe()}catch{}}async loadUserData(){try{await Promise.all([this.getMyMemberships(),this.getMyProducts()])}catch{}}async getOfflineData(e){throw new Error("Offline data not available")}setupNetworkMonitoring(){typeof window>"u"||(window.addEventListener("online",()=>{this.online.set(!0),this.processQueuedRequests()}),window.addEventListener("offline",()=>{this.online.set(!1)}))}async processQueuedRequests(){for(;this.requestQueue.length>0;){const e=this.requestQueue.shift();if(e)try{const t=await this.request(e.endpoint,e.config);e.resolve(t)}catch(t){e.reject(t)}}}startRequestProcessor(){setInterval(()=>{this.processBatchRequests()},q)}async processBatchRequests(){if(this.batchQueue.size===0)return;const e=Array.from(this.batchQueue.entries());this.batchQueue.clear();for(const[t,s]of e)s.length>=E&&await this.batch(s)}updateMetrics(e){if(e.responseTime!==void 0){const t=this.metrics.totalRequests+1;this.metrics.averageResponseTime=(this.metrics.averageResponseTime*this.metrics.totalRequests+e.responseTime)/t,this.metrics.totalRequests=t}if(e.success!==void 0&&(e.success?this.metrics.successfulRequests++:this.metrics.failedRequests++,this.metrics.errorRate=this.metrics.failedRequests/this.metrics.totalRequests),e.cached){const t=this.metrics.cacheHitRate*this.metrics.totalRequests;this.metrics.cacheHitRate=(t+1)/(this.metrics.totalRequests+1)}this.performance.set(this.metrics)}startPerformanceMonitoring(){setInterval(()=>{const e=Date.now(),t=this.requestQueue.filter(s=>e-s.timestamp<6e4).length;this.metrics.requestsPerMinute=t,this.performance.set(this.metrics)},1e4)}}class _{tokens;lastRefill;maxTokens;refillRate;constructor(e){this.maxTokens=e,this.tokens=e,this.lastRefill=Date.now(),this.refillRate=6e4/e}async acquire(){if(this.refill(),this.tokens<=0){const e=this.refillRate-(Date.now()-this.lastRefill);return await new Promise(t=>setTimeout(t,e)),this.acquire()}this.tokens--}refill(){const e=Date.now(),t=e-this.lastRefill,s=Math.floor(t/this.refillRate);s>0&&(this.tokens=Math.min(this.tokens+s,this.maxTokens),this.lastRefill=e)}}class D{failures=0;lastFailureTime;state="closed";threshold=P;timeout=A;isOpen(){return this.checkState(),this.state==="open"}recordSuccess(){this.state==="half-open"&&this.reset()}recordFailure(){this.failures++,this.lastFailureTime=Date.now(),this.failures>=this.threshold&&(this.state="open")}getTimeUntilReset(){return this.lastFailureTime?Math.max(0,this.timeout-(Date.now()-this.lastFailureTime)):0}checkState(){this.state==="open"&&this.lastFailureTime&&Date.now()-this.lastFailureTime>=this.timeout&&(this.state="half-open")}reset(){this.failures=0,this.lastFailureTime=void 0,this.state="closed"}}const r=p.getInstance();r.loading;r.error;r.online;r.performance;r.user;r.memberships;r.products;r.isAuthenticated;r.activeMembership;r.hasActiveSubscription;const O={get:(i,e)=>r.get(i,e),post:(i,e,t)=>r.post(i,e,t),put:(i,e,t)=>r.put(i,e,t),patch:(i,e,t)=>r.patch(i,e,t),delete:(i,e)=>r.delete(i,e),register:i=>r.register(i),login:i=>r.login(i),logout:()=>r.logout(),refreshToken:()=>r.refreshAccessToken(),getMe:()=>r.getMe(),updateProfile:i=>r.updateProfile(i),getMyMemberships:()=>r.getMyMemberships(),getMyProducts:()=>r.getMyProducts(),getIndicators:i=>r.getIndicators(i),getIndicator:i=>r.getIndicator(i),purchaseProduct:(i,e)=>r.purchaseProduct(i,e),getPosts:i=>r.getPosts(i),getPost:i=>r.getPost(i),createPost:i=>r.createPost(i),updatePost:(i,e)=>r.updatePost(i,e),uploadFile:(i,e)=>r.uploadFile(i,e),download:(i,e)=>r.download(i,e),batch:i=>r.batch(i),setToken:(i,e)=>r.setToken(i,e),getToken:()=>r.getToken()};export{r as a,O as b};
