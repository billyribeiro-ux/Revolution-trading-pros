import{json as n,error as g}from"@sveltejs/kit";const h="http://localhost:8000/api";function f(r){const s=r.headers.get("Authorization"),t={"Content-Type":"application/json",Accept:"application/json"};return s&&(t.Authorization=s),t}const y=async({url:r,request:s})=>{try{const t=r.searchParams.get("admin")==="true",p=r.searchParams.get("user_id"),a=new URLSearchParams,o=r.searchParams.get("page"),d=r.searchParams.get("limit")||r.searchParams.get("per_page"),c=r.searchParams.get("status"),m=r.searchParams.get("type");o&&a.set("page",o),d&&a.set("per_page",d),c&&a.set("status",c),m&&a.set("type",m);let l;t?(a.set("type","membership"),l=`${h}/admin/products${a.toString()?"?"+a.toString():""}`):l=`${h}/me/memberships${a.toString()?"?"+a.toString():""}`;const u=await fetch(l,{method:"GET",headers:f(s)});if(!u.ok){const _=await u.json().catch(()=>({message:"Failed to fetch memberships"}));return n({success:!1,error:_.message||"Failed to fetch memberships",data:{memberships:[],user_memberships:[],pagination:{page:1,limit:12,total:0,total_pages:0}}},{status:u.status})}const i=await u.json();if(t){const _=(i.data||[]).map(e=>({id:e.id,slug:e.slug,name:e.name,description:e.description||"",short_description:e.short_description||"",thumbnail_url:e.thumbnail_url||e.image_url||"",banner_url:e.banner_url,tier:e.tier||"basic",category:e.category||"membership",features:e.features||[],price_monthly:e.price_monthly,price_annual:e.price_annual,price_lifetime:e.price_lifetime,has_trading_room:e.has_trading_room??!1,has_alerts:e.has_alerts??!1,has_learning_center:e.has_learning_center??!1,has_daily_videos:e.has_daily_videos??!1,instructor:e.instructor,trading_room_schedule:e.trading_room_schedule,is_active:e.is_active??!0,is_featured:e.is_featured??!1,sort_order:e.sort_order||0,created_at:e.created_at,updated_at:e.updated_at}));return n({success:!0,data:{memberships:_,pagination:{page:i.current_page||1,limit:i.per_page||12,total:i.total||0,total_pages:i.last_page||0}}})}else{const _=Array.isArray(i)?i:i.data||[];return n({success:!0,data:{user_memberships:_.map(e=>({id:e.id,user_id:e.user_id,membership_id:e.membership_id||e.product_id,membership:e.membership||e.product||{},status:e.status||"active",subscription_type:e.subscription_type||e.billing_cycle||"monthly",started_at:e.started_at||e.created_at,expires_at:e.expires_at||e.end_date,cancelled_at:e.cancelled_at,auto_renew:e.auto_renew??!0,payment_method:e.payment_method}))}})}}catch{return n({success:!1,error:"Failed to connect to backend",data:{memberships:[],user_memberships:[],pagination:{page:1,limit:12,total:0,total_pages:0}}},{status:503})}},w=async({request:r})=>{try{const s=await r.json(),t=s.user_id&&s.membership_id;let p,a;if(t)p=`${h}/admin/products/${s.membership_id}/assign-user`,a={user_id:s.user_id,subscription_type:s.subscription_type||"monthly",auto_renew:s.auto_renew??!0};else{if(!s.name)throw g(400,"Membership name is required");p=`${h}/admin/products`,a={name:s.name,slug:s.slug||s.name.toLowerCase().replace(/[^a-z0-9]+/g,"-"),type:"membership",description:s.description||"",short_description:s.short_description||"",thumbnail_url:s.thumbnail_url||"",tier:s.tier||"basic",category:s.category||"membership",features:s.features||[],price_monthly:s.price_monthly,price_annual:s.price_annual,price_lifetime:s.price_lifetime,has_trading_room:s.has_trading_room??!1,has_alerts:s.has_alerts??!1,has_learning_center:s.has_learning_center??!1,has_daily_videos:s.has_daily_videos??!1,instructor_id:s.instructor_id,is_active:s.is_active??!0,is_featured:s.is_featured??!1,sort_order:s.sort_order??0}}const o=await fetch(p,{method:"POST",headers:f(r),body:JSON.stringify(a)});if(!o.ok){const c=await o.json().catch(()=>({message:"Failed to process membership request"}));return n({success:!1,error:c.message||"Failed to process membership request",errors:c.errors},{status:o.status})}const d=await o.json();return n({success:!0,data:d},{status:201})}catch(s){throw s instanceof Error&&"status"in s?s:g(500,"Failed to process membership request")}};export{y as GET,w as POST};
