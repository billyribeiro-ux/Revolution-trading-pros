import{A as a,z as h,c5 as p,an as r}from"./vendor-svelte.js";import{getAuthToken as d}from"./auth.js";const n="/api",l="",f=3e4,y=3e5,m=150,w=15e3;class c{static instance;wsConnection;cache=new Map;eventBuffer=[];impressionTimers=new Map;exitIntentListener;scrollListener;inactivityTimer;sessionId;viewedPopups=new Set;convertedPopups=new Set;popups=a([]);activePopup=a(null);queuedPopups=a([]);analytics=a({});isLoading=a(!1);error=a(null);hasActivePopup=h(this.activePopup,e=>e!==null);popupQueue=h(this.queuedPopups,e=>e);nextPopup=h(this.queuedPopups,e=>e[0]||null);constructor(){this.sessionId=this.generateSessionId(),this.initialize()}static getInstance(){return c.instance||(c.instance=new c),c.instance}initialize(){}generateSessionId(){return`popup_session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}setupWebSocket(){}sendSessionInfo(){this.wsConnection&&this.wsConnection.send(JSON.stringify({type:"session",sessionId:this.sessionId,page:window.location.pathname,userAgent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight}}))}handleWebSocketMessage(e){try{const t=JSON.parse(e.data);switch(t.type){case"popup_update":this.handlePopupUpdate(t.data);break;case"show_popup":this.handleShowPopup(t.data);break;case"analytics_update":this.handleAnalyticsUpdate(t.data);break;case"ab_test_result":this.handleABTestResult(t.data);break}}catch{}}handlePopupUpdate(e){this.popups.update(t=>{const s=t.findIndex(i=>i.id===e.id);return s>=0?t[s]=e:t.push(e),t})}handleShowPopup(e){this.queuePopup(e)}handleAnalyticsUpdate(e){this.analytics.update(t=>(t[e.popupId]=e.analytics,t))}handleABTestResult(e){}setupBehavioralTracking(){}setupExitIntentDetection(){this.exitIntentListener=e=>{e.clientY<=m&&this.triggerExitIntentPopups()},document.addEventListener("mousemove",this.exitIntentListener)}setupScrollTracking(){let e=0;this.scrollListener=()=>{const t=document.documentElement.scrollHeight-window.innerHeight,s=Math.round(window.scrollY/t*100);[25,50,75,100].forEach(i=>{s>=i&&e<i&&this.triggerScrollPopups(i)}),e=s},window.addEventListener("scroll",this.scrollListener,{passive:!0})}setupInactivityDetection(){const e=()=>{this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.inactivityTimer=window.setTimeout(()=>{this.triggerInactivityPopups()},w)};["mousedown","mousemove","keypress","scroll","touchstart"].forEach(t=>{document.addEventListener(t,e,!0)}),e()}setupInteractionTracking(){document.addEventListener("click",e=>{const t=e.target,s=t.closest("[data-popup-id]");if(s){const i=s.getAttribute("data-popup-id");i&&this.trackInteraction(i,"click",{element:t.tagName,text:t.textContent})}})}setupEventListeners(){}startAnalyticsProcessing(){}async getAllPopups(){this.isLoading.set(!0),this.error.set(null);try{const e=p?d():null,t=await fetch(`${n}/admin/popups`,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json",...e?{Authorization:`Bearer ${e}`}:{}}});if(!t.ok)throw new Error("Failed to fetch popups");const s=await t.json(),i=s.popups||s.data||s||[];return this.popups.set(i),i}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async loadActivePopups(){}processActivePopups(e){const t=e.filter(s=>this.isEligible(s));t.sort((s,i)=>(i.priority||0)-(s.priority||0)),t.forEach(s=>{this.schedulePopup(s)})}async createPopup(e){this.isLoading.set(!0),this.error.set(null);try{e.personalization?.aiOptimization&&(e=await this.optimizeWithAI(e));const t=await fetch(`${n}/popups`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)});if(!t.ok)throw new Error("Failed to create popup");const s=await t.json();return this.popups.update(i=>[...i,s]),this.trackEvent("popup_created",{popupId:s.id}),s}catch(t){throw this.error.set(t.message),t}finally{this.isLoading.set(!1)}}async updatePopup(e,t){this.isLoading.set(!0),this.error.set(null);try{const s=await fetch(`${n}/popups/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)});if(!s.ok)throw new Error("Failed to update popup");const i=await s.json();return this.handlePopupUpdate(i),this.clearCache(),i}catch(s){throw this.error.set(s.message),s}finally{this.isLoading.set(!1)}}async deletePopup(e){this.isLoading.set(!0),this.error.set(null);try{if(!(await fetch(`${n}/popups/${e}`,{method:"DELETE",credentials:"include"})).ok)throw new Error("Failed to delete popup");this.popups.update(s=>s.filter(i=>i.id!==e)),this.clearCache()}catch(t){throw this.error.set(t.message),t}finally{this.isLoading.set(!1)}}showPopup(e){this.hasReachedFrequencyLimit(e)||(this.activePopup.set(e),this.recordImpression(e.id),this.setDisplayCookie(e),this.startConversionTracking(e),this.applyAnimations(e),this.trackEvent("popup_shown",{popupId:e.id,variant:e.variant?.id}))}closePopup(e){const t=r(this.activePopup);!t||e&&t.id!==e||(this.applyExitAnimation(t),setTimeout(()=>{this.activePopup.set(null),this.showNextInQueue()},300),this.trackEvent("popup_closed",{popupId:t.id,duration:Date.now()-(this.impressionTimers.get(t.id)||Date.now())}))}minimizePopup(e){this.trackEvent("popup_minimized",{popupId:e})}queuePopup(e){this.queuedPopups.update(t=>(t.find(s=>s.id===e.id)||t.push(e),t)),r(this.activePopup)||this.showNextInQueue()}showNextInQueue(){const e=r(this.queuedPopups);if(e.length===0)return;const t=e.shift();t&&(this.queuedPopups.set(e),this.showPopup(t))}schedulePopup(e){if(!e.triggers||e.triggers.length===0){this.queuePopup(e);return}e.triggers.forEach(t=>{if(t.enabled)switch(t.type){case"immediate":this.queuePopup(e);break;case"time_delay":setTimeout(()=>this.queuePopup(e),t.delay||0);break;case"exit_intent":break;case"scroll_depth":break;case"inactivity":break;default:this.setupCustomTrigger(e,t)}})}setupCustomTrigger(e,t){if(t.type==="custom_event"&&t.conditions){const s=t.conditions[0]?.value;s&&document.addEventListener(s,()=>{this.queuePopup(e)},{once:!0})}}async recordImpression(e){if(!this.viewedPopups.has(e)){this.viewedPopups.add(e),this.impressionTimers.set(e,Date.now()),this.eventBuffer.push({type:"impression",popupId:e,timestamp:new Date().toISOString(),sessionId:this.sessionId});try{await fetch(`${n}/popups/${e}/impression`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:this.sessionId,timestamp:new Date().toISOString()})})}catch{}}}async recordConversion(e,t){if(this.convertedPopups.has(e))return;this.convertedPopups.add(e);const s=Date.now()-(this.impressionTimers.get(e)||Date.now());this.eventBuffer.push({type:"conversion",popupId:e,timestamp:new Date().toISOString(),sessionId:this.sessionId,data:{...t,conversionTime:s}});try{await fetch(`${n}/popups/${e}/conversion`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,sessionId:this.sessionId,conversionTime:s})})}catch{}this.closePopup(e)}trackInteraction(e,t,s){this.eventBuffer.push({type:"interaction",popupId:e,timestamp:new Date().toISOString(),sessionId:this.sessionId,data:{action:t,...s}})}async getAnalytics(e){const t=await fetch(`${n}/popups/${e}/analytics`,{credentials:"include"});if(!t.ok)throw new Error("Failed to fetch analytics");const s=await t.json();return this.analytics.update(i=>(i[e]=s,i)),s}async createABTest(e,t){const s=await fetch(`${n}/popups/${e}/ab-test`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({variants:t})});if(!s.ok)throw new Error("Failed to create A/B test");const{testId:i}=await s.json();return i}async getABTestResults(e){const t=await fetch(`${n}/ab-tests/${e}/results`,{credentials:"include"});if(!t.ok)throw new Error("Failed to fetch test results");return t.json()}isEligible(e){return!(!e.isActive||!this.checkTargeting(e)||!this.checkSchedule(e)||this.hasReachedFrequencyLimit(e))}checkTargeting(e){if(!e.targeting)return!0;const t=e.targeting;if(t.devices&&t.devices.length>0){const s=this.getDeviceType();if(!t.devices.includes(s))return!1}if(t.newVisitors!==void 0){const s=!this.getCookie("returning_visitor");if(t.newVisitors!==s)return!1}return!0}checkSchedule(e){if(!e.scheduling)return!0;const t=new Date,s=e.scheduling;return!(s.startDate&&new Date(s.startDate)>t||s.endDate&&new Date(s.endDate)<t||s.daysOfWeek&&s.daysOfWeek.length>0&&!s.daysOfWeek.includes(t.getDay())||s.hoursOfDay&&s.hoursOfDay.length>0&&!s.hoursOfDay.includes(t.getHours()))}hasReachedFrequencyLimit(e){if(!e.behavior?.showFrequency)return!1;const t=e.behavior.showFrequency,s=`popup_${e.id}_shown`,i=this.getCookie(s);if(!i)return!1;switch(t.type){case"once":return!0;case"session":return sessionStorage.getItem(s)!==null;case"daily":const u=new Date(i);return(Date.now()-u.getTime())/(1e3*60*60*24)<1;default:return!1}}setDisplayCookie(e){const t=`popup_${e.id}_shown`,s=e.behavior?.cookieExpiry||30;this.setCookie(t,new Date().toISOString(),s),e.behavior?.showFrequency?.type==="session"&&sessionStorage.setItem(t,"true")}startConversionTracking(e){setTimeout(()=>{r(this.activePopup)?.id===e.id&&this.closePopup(e.id)},f)}applyAnimations(e){e.animations?.entrance,e.animations?.attention&&setTimeout(()=>{},e.animations.attention.delay||3e3)}applyExitAnimation(e){e.animations?.exit}repositionActivePopup(){const e=r(this.activePopup);e&&e.design?.position}pauseActivePopups(){}resumeActivePopups(){}triggerExitIntentPopups(){r(this.popups).filter(t=>t.triggers?.some(s=>s.type==="exit_intent"&&s.enabled)).forEach(t=>{this.isEligible(t)&&this.queuePopup(t)})}triggerScrollPopups(e){r(this.popups).filter(s=>s.triggers?.some(i=>i.type==="scroll_depth"&&i.enabled&&i.conditions?.some(u=>u.value===e))).forEach(s=>{this.isEligible(s)&&this.queuePopup(s)})}triggerInactivityPopups(){r(this.popups).filter(t=>t.triggers?.some(s=>s.type==="inactivity"&&s.enabled)).forEach(t=>{this.isEligible(t)&&this.queuePopup(t)})}async optimizeWithAI(e){try{const t=await fetch(`${l}/popups/optimize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(t.ok){const s=await t.json();return{...e,...s}}}catch{}return e}flushEventBuffer(){if(this.eventBuffer.length===0)return;const e=[...this.eventBuffer];this.eventBuffer=[],fetch(`${n}/popups/events`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:e})}).catch(t=>{this.eventBuffer.unshift(...e)})}trackEvent(e,t){}getDeviceType(){const e=window.innerWidth;return e<768?"mobile":e<1024?"tablet":"desktop"}getCookie(e){const s=`; ${document.cookie}`.split(`; ${e}=`);return s.length===2&&s.pop()?.split(";").shift()||null}setCookie(e,t,s){const i=new Date;i.setTime(i.getTime()+s*24*60*60*1e3),document.cookie=`${e}=${t};expires=${i.toUTCString()};path=/`}getFromCache(e){const t=this.cache.get(e);return t&&Date.now()<t.expiry?t.data:null}setCache(e,t,s=y){this.cache.set(e,{data:t,expiry:Date.now()+s})}clearCache(){this.cache.clear()}destroy(){this.wsConnection&&this.wsConnection.close(),this.exitIntentListener&&document.removeEventListener("mousemove",this.exitIntentListener),this.scrollListener&&window.removeEventListener("scroll",this.scrollListener),this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.flushEventBuffer()}}const o=c.getInstance();o.popups;o.activePopup;o.queuedPopups;o.analytics;o.hasActivePopup;o.popupQueue;o.nextPopup;o.isLoading;o.error;
