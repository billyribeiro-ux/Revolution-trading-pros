import{error as a,json as c}from"@sveltejs/kit";const _=new Map,h=async({params:i,request:n})=>{const{key:s}=i;try{const t=await n.json(),{credentials:e,environment:o="production"}=t;if(!e||Object.keys(e).length===0)throw a(400,"Credentials are required");await d(s,e);const r={id:`conn_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,service_key:s,credentials:l(e),environment:o,status:"connected",health_score:100,health_status:"healthy",connected_at:new Date().toISOString(),last_verified_at:new Date().toISOString(),api_calls_today:0,api_calls_total:0,last_error:null};return _.set(s,r),c({success:!0,data:{id:r.id,status:r.status,connected_at:r.connected_at}})}catch(t){throw t instanceof Error&&"status"in t?t:a(500,"Failed to connect service")}};async function d(i,n){await new Promise(e=>setTimeout(e,500));const t={stripe:["api_key","webhook_secret"],paypal:["client_id","client_secret"],mailchimp:["api_key","server_prefix"],sendgrid:["api_key"],google_analytics:["measurement_id"],openai:["api_key"],anthropic:["api_key"],twilio:["account_sid","auth_token"],aws_s3:["access_key_id","secret_access_key","bucket_name"]}[i]||[];for(const e of t)if(!n[e])throw a(400,`Missing required field: ${e}`);if(i==="stripe"&&!n.api_key?.startsWith("sk_"))throw a(400,"Invalid Stripe API key format. Should start with sk_");if(i==="openai"&&!n.api_key?.startsWith("sk-"))throw a(400,"Invalid OpenAI API key format. Should start with sk-")}function l(i){const n={};for(const[s,t]of Object.entries(i))n[s]=t.substring(0,4)+"****"+t.substring(t.length-4);return n}export{h as POST};
