import{A as l,z as m,an as f}from"./vendor-svelte.js";import{b as n}from"./client.js";const _="http://localhost:8001/api",R=3e5,A=2e3;class h{static instance;cache=new Map;wsConnection;analysisDebounceTimers=new Map;rankCheckInterval;alertCheckInterval;pendingAnalyses=new Map;analyses=l([]);currentAnalysis=l(null);redirects=l([]);errors404=l([]);rankings=l([]);backlinks=l(null);competitors=l([]);alerts=l([]);isLoading=l(!1);error=l(null);criticalIssues=m(this.currentAnalysis,e=>e?.technical_issues?.filter(s=>s.severity==="critical")||[]);topOpportunities=m(this.currentAnalysis,e=>e?.keyword_opportunities?.sort((s,t)=>t.opportunity_score-s.opportunity_score).slice(0,10)||[]);overallScore=m(this.currentAnalysis,e=>e?.overall_score||0);constructor(){this.initialize()}static getInstance(){return h.instance||(h.instance=new h),h.instance}initialize(){}setupWebSocket(){}subscribeToUpdates(){this.wsConnection?.send(JSON.stringify({type:"subscribe",channels:["rankings","crawl","alerts","competitors"]}))}handleWebSocketMessage(e){try{const s=JSON.parse(e.data);switch(s.type){case"ranking_update":this.handleRankingUpdate(s.data);break;case"crawl_complete":this.handleCrawlComplete(s.data);break;case"new_404":this.handleNew404(s.data);break;case"competitor_update":this.handleCompetitorUpdate(s.data);break;case"seo_alert":this.handleSeoAlert(s.data);break}}catch{}}handleRankingUpdate(e){this.rankings.update(s=>{const t=s.findIndex(i=>i.keyword===e.keyword);return t>=0?s[t]=e:s.push(e),s}),Math.abs(e.change)>=5&&this.showNotification(`Ranking ${e.change>0?"improved":"dropped"} for "${e.keyword}": ${e.change>0?"+":""}${e.change}`,e.change>0?"success":"warning")}handleCrawlComplete(e){this.loadTechnicalIssues()}handleNew404(e){this.errors404.update(s=>[...s,e]),this.showNotification(`New 404 error detected: ${e.url}`,"warning")}handleCompetitorUpdate(e){this.competitors.update(s=>{const t=s.findIndex(i=>i.domain===e.domain);return t>=0?s[t]=e:s.push(e),s})}handleSeoAlert(e){this.alerts.update(s=>[e,...s]),this.showNotification(e.message,e.severity)}async loadInitialData(){try{await Promise.all([this.loadRedirects(),this.load404Errors(),this.loadRankings(),this.loadBacklinks()])}catch{}}startRankTracking(){}async checkRankings(){try{const e=await n.get("/seo/rankings/check");this.rankings.set(e.rankings)}catch{}}startAlertMonitoring(){}async checkAlerts(){try{(await n.get("/seo/alerts/check")).alerts.forEach(s=>{s.is_new&&this.handleSeoAlert(s)})}catch{}}async analyze(e,s,t,i={}){this.isLoading.set(!0),this.error.set(null);const o=`${e}_${s}`;return this.analysisDebounceTimers.has(o)&&clearTimeout(this.analysisDebounceTimers.get(o)),new Promise((u,g)=>{const y=window.setTimeout(async()=>{try{if(this.pendingAnalyses.has(o)){const d=await this.pendingAnalyses.get(o);u(d);return}const c=this.performAnalysis(e,s,t,i);this.pendingAnalyses.set(o,c);const p=await c;this.currentAnalysis.set(p),this.analyses.update(d=>{const k=d.findIndex(w=>w.analyzable_type===e&&w.analyzable_id===s);return k>=0?d[k]=p:d.push(p),d}),u(p)}catch(c){this.error.set(c.message),g(c)}finally{this.pendingAnalyses.delete(o),this.isLoading.set(!1)}},i.immediate?0:A);this.analysisDebounceTimers.set(o,y)})}async performAnalysis(e,s,t,i={}){const[o,u,g,y,c,p]=await Promise.all([this.getBasicAnalysis(e,s,t),i.includeCompetitors?this.analyzeCompetitors(t):null,i.includeKeywords?this.findKeywordOpportunities(t):null,i.includeContentGaps?this.analyzeContentGaps(t):null,i.includeTechnical?this.performTechnicalAudit(e,s):null,i.includePerformance?this.getPerformanceMetrics(e,s):null]),d=this.calculateOverallScore({basicAnalysis:o,technicalAudit:c,performanceMetrics:p}),k=await this.generateAISuggestions({basicAnalysis:o,competitorAnalysis:u,keywordOpportunities:g,contentGaps:y});return{...o,overall_score:d,technical_score:c?100-c.issues.length*5:100,content_score:o.seo_score,user_experience_score:p?.pageSpeed.score||100,competitor_comparison:u,keyword_opportunities:g,content_gaps:y,technical_issues:c?.issues,page_speed:p?.pageSpeed,core_web_vitals:p?.coreWebVitals,suggestions:[...o.suggestions,...k]}}async getBasicAnalysis(e,s,t){return(await n.post("/seo/analyze",{content_type:e,content_id:s,focus_keyword:t})).analysis}async analyzeCompetitors(e){return e?(await n.post("/seo/competitors/analyze",{keyword:e})).analysis:null}async findKeywordOpportunities(e){return(await n.post("/seo/keywords/opportunities",{seed_keyword:e})).opportunities}async analyzeContentGaps(e){return e?(await n.post("/seo/content/gaps",{keyword:e})).gaps:null}async performTechnicalAudit(e,s){return{issues:(await n.post("/seo/technical/audit",{content_type:e,content_id:s})).issues}}async getPerformanceMetrics(e,s){return await n.post("/seo/performance/analyze",{content_type:e,content_id:s})}calculateOverallScore(e){const s={technical:.3,content:.3,performance:.2};let t=0;if(e.basicAnalysis&&(t+=e.basicAnalysis.seo_score*s.content),e.technicalAudit){const i=100-e.technicalAudit.issues.length*5;t+=Math.max(0,i)*s.technical}return e.performanceMetrics&&(t+=e.performanceMetrics.pageSpeed.score*s.performance),Math.round(t)}async generateAISuggestions(e){try{return(await n.post(`${_}/seo/suggestions`,e)).suggestions}catch{return[]}}async getAnalysis(e,s){const t=`analysis_${e}_${s}`,i=this.getFromCache(t);if(i)return i;const o=await n.get(`/seo/analyze/${e}/${s}`);return this.setCache(t,o.analysis),o.analysis}async getRecommendations(e,s){return(await n.get(`/seo/analyze/${e}/${s}/recommendations`)).recommendations}async autoFix(e,s,t){const i=await n.post("/seo/auto-fix",{content_type:e,content_id:s,issues:t});return await this.analyze(e,s,void 0,{immediate:!0}),i}async loadRedirects(e){const s=await n.get("/redirects",{params:e});return this.redirects.set(s.data),s.data}async createRedirect(e){const s=await n.post("/redirects",e);return this.redirects.update(t=>[...t,s.redirect]),this.trackEvent("redirect_created",{from:e.from_path,to:e.to_path}),s.redirect}async updateRedirect(e,s){const t=await n.put(`/redirects/${e}`,s);return this.redirects.update(i=>{const o=i.findIndex(u=>u.id===e);return o>=0&&(i[o]=t.redirect),i}),t.redirect}async deleteRedirect(e){await n.delete(`/redirects/${e}`),this.redirects.update(s=>s.filter(t=>t.id!==e))}async detectRedirectChains(){return(await n.get("/redirects/chains")).chains}async importRedirects(e){const s=new FormData;s.append("file",e);const t=await n.post("/redirects/import",s,{headers:{"Content-Type":"multipart/form-data"}});return await this.loadRedirects(),t}async exportRedirects(){return await n.get("/redirects/export")}async load404Errors(e){const s=await n.get("/404-errors",{params:e});return this.errors404.set(s.data),s.data}async resolve404(e,s){s&&await this.createRedirect({from_path:(await this.get404(e)).url,to_path:s,status_code:301,type:"automatic"}),await n.put(`/404-errors/${e}/resolve`),this.errors404.update(t=>t.map(i=>i.id===e?{...i,is_resolved:!0}:i))}async get404(e){const t=f(this.errors404).find(o=>o.id===e);return t||(await n.get(`/404-errors/${e}`)).error}async bulkDelete404s(e,s){const t=await n.post("/404-errors/bulk-delete",{resolved_only:e,older_than_days:s});return await this.load404Errors(),t}async findSimilarPages(e){return(await n.post("/404-errors/find-similar",{url:e})).suggestions}async loadRankings(e){const s=await n.get("/seo/rankings",{params:{keywords:e}});return this.rankings.set(s.rankings),s.rankings}async trackKeyword(e,s,t){const i=await n.post("/seo/rankings/track",{keyword:e,url:s,...t});return this.rankings.update(o=>[...o,i.tracking]),i.tracking}async updateRankings(){const e=await n.post("/seo/rankings/update");return this.rankings.set(e.rankings),e.rankings}async getRankingHistory(e,s=30){return(await n.get(`/seo/rankings/${encodeURIComponent(e)}/history`,{params:{days:s}})).history}async loadBacklinks(){const e=await n.get("/seo/backlinks");return this.backlinks.set(e.profile),e.profile}async checkNewBacklinks(){return(await n.get("/seo/backlinks/new")).backlinks}async analyzeToxicBacklinks(){return(await n.get("/seo/backlinks/toxic")).toxic}async disavowBacklinks(e){await n.post("/seo/backlinks/disavow",{domains:e})}async getSettings(){return await n.get("/seo-settings")}async updateSetting(e,s){await n.put(`/seo-settings/${e}`,{value:s})}async getSitemapConfigs(){return(await n.get("/seo-settings/sitemap-configs")).configs}async updateSitemapConfig(e){await n.put(`/seo-settings/sitemap-configs/${e.id}`,e)}async generateSitemap(){return(await n.post("/seo/sitemap/generate")).url}async getLocalBusiness(){return await n.get("/seo-settings/local-business")}async updateLocalBusiness(e){await n.post("/seo-settings/local-business",e)}async generateSchema(e,s){return(await n.post("/seo/schema/generate",{type:e,data:s})).schema}getFromCache(e){const s=this.cache.get(e);return s&&Date.now()<s.expiry?s.data:null}setCache(e,s,t=R){this.cache.set(e,{data:s,expiry:Date.now()+t})}clearCache(e){if(e)for(const s of this.cache.keys())s.includes(e)&&this.cache.delete(s);else this.cache.clear()}async loadTechnicalIssues(){try{const e=await n.get("/seo/technical/issues");this.currentAnalysis.update(s=>(s&&(s.technical_issues=e.issues),s))}catch{}}showNotification(e,s="info"){}trackEvent(e,s){}destroy(){this.rankCheckInterval&&clearInterval(this.rankCheckInterval),this.alertCheckInterval&&clearInterval(this.alertCheckInterval),this.wsConnection?.close(),this.analysisDebounceTimers.forEach(e=>clearTimeout(e)),this.analysisDebounceTimers.clear()}}const a=h.getInstance();a.analyses;a.currentAnalysis;a.redirects;a.errors404;a.rankings;a.backlinks;a.competitors;a.alerts;a.criticalIssues;a.topOpportunities;a.overallScore;a.isLoading;a.error;const S={analyze:(r,e,s,t)=>a.analyze(r,e,s,t),getAnalysis:(r,e)=>a.getAnalysis(r,e),getRecommendations:(r,e)=>a.getRecommendations(r,e),autoFix:(r,e,s)=>a.autoFix(r,e,s),listRedirects:r=>a.loadRedirects(r),createRedirect:r=>a.createRedirect(r),updateRedirect:(r,e)=>a.updateRedirect(r,e),deleteRedirect:r=>a.deleteRedirect(r),detectRedirectChains:()=>a.detectRedirectChains(),importRedirects:r=>a.importRedirects(r),exportRedirects:()=>a.exportRedirects(),getRedirectStats:()=>n.get("/redirects/statistics"),list404s:r=>a.load404Errors(r),resolve404:(r,e)=>a.resolve404(r,e),bulkDelete404s:(r,e)=>a.bulkDelete404s(r,e),findSimilarPages:r=>a.findSimilarPages(r),get404Stats:()=>n.get("/404-errors/statistics"),loadRankings:r=>a.loadRankings(r),trackKeyword:(r,e,s)=>a.trackKeyword(r,e,s),updateRankings:()=>a.updateRankings(),getRankingHistory:(r,e)=>a.getRankingHistory(r,e),loadBacklinks:()=>a.loadBacklinks(),checkNewBacklinks:()=>a.checkNewBacklinks(),analyzeToxicBacklinks:()=>a.analyzeToxicBacklinks(),disavowBacklinks:r=>a.disavowBacklinks(r),getSettings:()=>a.getSettings(),updateSetting:(r,e)=>a.updateSetting(r,e),getSitemapConfigs:()=>a.getSitemapConfigs(),updateSitemapConfig:r=>a.updateSitemapConfig(r),generateSitemap:()=>a.generateSitemap(),getLocalBusiness:()=>a.getLocalBusiness(),updateLocalBusiness:r=>a.updateLocalBusiness(r),generateSchema:(r,e)=>a.generateSchema(r,e)};export{S as s};
