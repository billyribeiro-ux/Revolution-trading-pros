import{error as o,json as p}from"@sveltejs/kit";import{mkdir as I,writeFile as v}from"fs/promises";import{existsSync as b}from"fs";import h from"path";const z="static/uploads/videos",S="static/uploads/thumbnails",l=500*1024*1024,_=["video/mp4","video/webm","video/quicktime","video/x-msvideo"],g=["image/jpeg","image/png","image/webp","image/gif"],u=new Map,A=async({request:n,url:e})=>{const t=e.searchParams.get("action");return t==="presign"?x(n):t==="init"?E(n):F(n)},B=async({url:n})=>{const e=n.searchParams.get("session_id");if(e){const i=u.get(e);if(!i)throw o(404,"Upload session not found");return p({success:!0,data:i})}const t=Array.from(u.values()).sort((i,s)=>new Date(s.created_at).getTime()-new Date(i.created_at).getTime()).slice(0,20);return p({success:!0,data:t})};async function x(n){try{const e=await n.json(),{filename:t,content_type:i,size:s}=e;if(!t||!i)throw o(400,"Filename and content_type are required");if(s&&s>l)throw o(400,`File size exceeds maximum of ${l/1024/1024}MB`);const r=`upload_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,d=`videos/${r}/${t}`,c={id:r,filename:t,size:s||0,uploaded:0,status:"pending",created_at:new Date().toISOString()};return u.set(r,c),p({success:!0,data:{upload_id:r,presigned_url:`/api/videos/upload?session_id=${r}`,key:d,fields:{"Content-Type":i},expires_in:3600}})}catch(e){throw e instanceof Error&&"status"in e?e:o(500,"Failed to generate presigned URL")}}async function E(n){try{const e=await n.json(),{filename:t,size:i,content_type:s}=e;if(!t)throw o(400,"Filename is required");const r=_.includes(s),d=g.includes(s);if(!r&&!d)throw o(400,"File type not allowed");if(i&&i>l)throw o(400,`File size exceeds maximum of ${l/1024/1024}MB`);const c=`upload_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,f={id:c,filename:t,size:i||0,uploaded:0,status:"pending",created_at:new Date().toISOString()};return u.set(c,f),p({success:!0,data:{upload_id:c,upload_url:`/api/videos/upload?session_id=${c}`,chunk_size:5*1024*1024}})}catch(e){throw e instanceof Error&&"status"in e?e:o(500,"Failed to initialize upload")}}async function F(n){try{const e=await n.formData(),t=e.get("file"),i=e.get("type")||"video",s=e.get("session_id");if(!t)throw o(400,"No file provided");if(!(i==="thumbnail"?g:_).includes(t.type))throw o(400,`Invalid file type: ${t.type}`);if(t.size>l)throw o(400,`File size exceeds maximum of ${l/1024/1024}MB`);const d=i==="thumbnail"?S:z;b(d)||await I(d,{recursive:!0});const c=h.extname(t.name),f=s||`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,m=`${f}${c}`,y=h.join(d,m);if(s){const a=u.get(s);a&&(a.status="uploading",u.set(s,a))}const $=await t.arrayBuffer(),D=Buffer.from($);await v(y,D);const w=`/${d}/${m}`;if(s){const a=u.get(s);a&&(a.status="complete",a.uploaded=t.size,i==="thumbnail"?a.thumbnail_url=w:a.video_url=w,u.set(s,a))}return p({success:!0,data:{upload_id:f,filename:m,size:t.size,type:t.type,url:w,status:"complete"}})}catch(e){throw e instanceof Error&&"status"in e?e:o(500,"Failed to upload file")}}export{B as GET,A as POST};
