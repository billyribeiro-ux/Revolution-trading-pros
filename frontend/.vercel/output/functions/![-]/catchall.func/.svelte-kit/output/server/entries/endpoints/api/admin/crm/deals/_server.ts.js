import{json as i,error as _}from"@sveltejs/kit";const g="http://localhost:8000/api";function h(a){const t=a.headers.get("Authorization"),e={"Content-Type":"application/json",Accept:"application/json"};return t&&(e.Authorization=t),e}const w=async({url:a,request:t})=>{try{const e=new URLSearchParams,s=a.searchParams.get("status"),r=a.searchParams.get("pipeline_id"),n=a.searchParams.get("stage_id"),d=a.searchParams.get("page"),p=a.searchParams.get("limit")||a.searchParams.get("per_page"),l=a.searchParams.get("owner_id"),m=a.searchParams.get("contact_id");s&&s!=="all"&&e.set("status",s),r&&e.set("pipeline_id",r),n&&e.set("stage_id",n),d&&e.set("page",d),p&&e.set("per_page",p),l&&e.set("owner_id",l),m&&e.set("contact_id",m);const u=`${g}/admin/crm/deals${e.toString()?"?"+e.toString():""}`,c=await fetch(u,{method:"GET",headers:h(t)});if(!c.ok){const f=await c.json().catch(()=>({message:"Failed to fetch deals"}));return i({success:!1,error:f.message||"Failed to fetch deals",data:[],meta:{page:1,limit:20,total:0,total_pages:0}},{status:c.status})}const o=await c.json();return i({success:!0,data:o.data||[],meta:{page:o.current_page||1,limit:o.per_page||20,total:o.total||0,total_pages:o.last_page||0}})}catch{return i({success:!1,error:"Failed to connect to backend",data:[],meta:{page:1,limit:20,total:0,total_pages:0}},{status:503})}},P=async({request:a})=>{try{const t=await a.json();if(!t.name)throw _(400,"Deal name is required");const e=await fetch(`${g}/admin/crm/deals`,{method:"POST",headers:h(a),body:JSON.stringify({name:t.name,contact_id:t.contact_id,company_id:t.company_id,pipeline_id:t.pipeline_id||"default",stage_id:t.stage_id,amount:t.amount||0,currency:t.currency||"USD",probability:t.probability||10,status:t.status||"open",priority:t.priority||"normal",expected_close_date:t.expected_close_date,owner_id:t.owner_id,source_channel:t.source_channel,tags:t.tags||[],custom_fields:t.custom_fields||{}})});if(!e.ok){const r=await e.json().catch(()=>({message:"Failed to create deal"}));return i({success:!1,error:r.message||"Failed to create deal",errors:r.errors},{status:e.status})}const s=await e.json();return i({success:!0,data:s},{status:201})}catch(t){throw t instanceof Error&&"status"in t?t:_(500,"Failed to create deal")}};export{w as GET,P as POST};
