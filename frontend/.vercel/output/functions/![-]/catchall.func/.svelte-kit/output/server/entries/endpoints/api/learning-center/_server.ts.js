import{json as i,error as l}from"@sveltejs/kit";const f="http://localhost:8000/api";function m(a){const t=a.headers.get("Authorization"),s={"Content-Type":"application/json",Accept:"application/json"};return t&&(s.Authorization=t),s}const k=async({url:a,request:t})=>{try{const s=new URLSearchParams,n=a.searchParams.get("page"),o=a.searchParams.get("limit")||a.searchParams.get("per_page"),d=a.searchParams.get("membership_id"),u=a.searchParams.get("category_id"),b=a.searchParams.get("type"),p=a.searchParams.get("search"),_=a.searchParams.get("instructor_id"),g=a.searchParams.get("featured"),h=a.searchParams.get("published");n&&s.set("page",n),o&&s.set("per_page",o),d&&s.set("membership_id",d),u&&s.set("category_id",u),p&&s.set("search",p),_&&s.set("instructor_id",_),g&&s.set("featured",g),h&&s.set("is_published",h);const y=b||"course";s.set("type",y);const w=`${f}/admin/products${s.toString()?"?"+s.toString():""}`,c=await fetch(w,{method:"GET",headers:m(t)});if(!c.ok){const e=await c.json().catch(()=>({message:"Failed to fetch learning content"}));return i({success:!1,error:e.message||"Failed to fetch learning content",data:{content:[],categories:[],instructors:[],pagination:{page:1,limit:12,total:0,total_pages:0}}},{status:c.status})}const r=await c.json(),P=(r.data||[]).map(e=>({id:e.id,title:e.name||e.title,slug:e.slug,type:e.type||"course",description:e.description||"",excerpt:e.short_description||e.description?.substring(0,150)||"",thumbnail_url:e.thumbnail_url||e.image_url||"",content_url:e.content_url||"",duration:e.duration,category_id:e.category_id,categories:e.categories||[],tags:e.tags||[],instructor:e.instructor||{id:"",name:"Unknown"},membership_ids:e.membership_ids||[],is_premium:e.is_premium??!0,is_published:e.is_published??!0,is_featured:e.is_featured??!1,sort_order:e.sort_order||0,view_count:e.view_count||0,like_count:e.like_count||0,created_at:e.created_at,updated_at:e.updated_at,published_at:e.published_at}));return i({success:!0,data:{content:P,categories:r.categories||[],instructors:r.instructors||[],pagination:{page:r.current_page||1,limit:r.per_page||12,total:r.total||0,total_pages:r.last_page||0}}})}catch{return i({success:!1,error:"Failed to connect to backend",data:{content:[],categories:[],instructors:[],pagination:{page:1,limit:12,total:0,total_pages:0}}},{status:503})}},T=async({request:a})=>{try{const t=await a.json();if(!t.title||!t.type)throw l(400,"Title and type are required");const s=await fetch(`${f}/admin/products`,{method:"POST",headers:m(a),body:JSON.stringify({name:t.title,slug:t.slug||t.title.toLowerCase().replace(/[^a-z0-9]+/g,"-"),type:t.type,description:t.description||"",short_description:t.excerpt||t.description?.substring(0,150)||"",thumbnail_url:t.thumbnail_url||"",content_url:t.content_url||"",duration:t.duration,category_id:t.category_id,tags:t.tags||[],instructor_id:t.instructor_id,membership_ids:t.membership_ids||[],is_premium:t.is_premium??!0,is_published:t.is_published??!1,is_featured:t.is_featured??!1,sort_order:t.sort_order??0})});if(!s.ok){const o=await s.json().catch(()=>({message:"Failed to create content"}));return i({success:!1,error:o.message||"Failed to create content",errors:o.errors},{status:s.status})}const n=await s.json();return i({success:!0,data:n},{status:201})}catch(t){throw t instanceof Error&&"status"in t?t:l(500,"Failed to create content")}};export{k as GET,T as POST};
