import{z as E,A as f}from"./vendor-svelte.js";import"clsx";import"@sveltejs/kit/internal";import"@sveltejs/kit/internal/server";import"./toast.js";const D=Object.freeze(["welberribeirodrums@gmail.com"]),r=Object.freeze({SUPERADMIN:"super-admin",ADMIN:"admin",MEMBER:"member",USER:"user"}),A=Object.freeze([r.USER,r.MEMBER,r.ADMIN,r.SUPERADMIN]),s=Object.freeze({DASHBOARD_VIEW:"dashboard.view",DASHBOARD_ANALYTICS:"dashboard.analytics",USERS_VIEW:"users.view",USERS_CREATE:"users.create",USERS_EDIT:"users.edit",USERS_DELETE:"users.delete",USERS_IMPERSONATE:"users.impersonate",POSTS_VIEW:"posts.view",POSTS_CREATE:"posts.create",POSTS_EDIT:"posts.edit",POSTS_DELETE:"posts.delete",POSTS_PUBLISH:"posts.publish",PRODUCTS_VIEW:"products.view",PRODUCTS_CREATE:"products.create",PRODUCTS_EDIT:"products.edit",PRODUCTS_DELETE:"products.delete",ORDERS_VIEW:"orders.view",ORDERS_MANAGE:"orders.manage",ORDERS_REFUND:"orders.refund",COUPONS_VIEW:"coupons.view",COUPONS_CREATE:"coupons.create",COUPONS_EDIT:"coupons.edit",COUPONS_DELETE:"coupons.delete",POPUPS_VIEW:"popups.view",POPUPS_CREATE:"popups.create",POPUPS_EDIT:"popups.edit",POPUPS_DELETE:"popups.delete",FORMS_VIEW:"forms.view",FORMS_CREATE:"forms.create",FORMS_EDIT:"forms.edit",FORMS_DELETE:"forms.delete",FORMS_SUBMISSIONS:"forms.submissions",SETTINGS_VIEW:"settings.view",SETTINGS_EDIT:"settings.edit",SETTINGS_SYSTEM:"settings.system",MEMBERSHIPS_VIEW:"memberships.view",MEMBERSHIPS_MANAGE:"memberships.manage",TRADING_ROOMS_ACCESS:"trading_rooms.access",TRADING_ROOMS_MODERATE:"trading_rooms.moderate",TRADING_ROOMS_ADMIN:"trading_rooms.admin",MEDIA_VIEW:"media.view",MEDIA_UPLOAD:"media.upload",MEDIA_DELETE:"media.delete",SYSTEM_LOGS:"system.logs",SYSTEM_CACHE:"system.cache",SYSTEM_MAINTENANCE:"system.maintenance"}),p=Object.freeze({[r.SUPERADMIN]:Object.values(s),[r.ADMIN]:[s.DASHBOARD_VIEW,s.DASHBOARD_ANALYTICS,s.USERS_VIEW,s.USERS_CREATE,s.USERS_EDIT,s.POSTS_VIEW,s.POSTS_CREATE,s.POSTS_EDIT,s.POSTS_DELETE,s.POSTS_PUBLISH,s.PRODUCTS_VIEW,s.PRODUCTS_CREATE,s.PRODUCTS_EDIT,s.ORDERS_VIEW,s.ORDERS_MANAGE,s.COUPONS_VIEW,s.COUPONS_CREATE,s.COUPONS_EDIT,s.POPUPS_VIEW,s.POPUPS_CREATE,s.POPUPS_EDIT,s.FORMS_VIEW,s.FORMS_CREATE,s.FORMS_EDIT,s.FORMS_SUBMISSIONS,s.SETTINGS_VIEW,s.MEMBERSHIPS_VIEW,s.MEMBERSHIPS_MANAGE,s.TRADING_ROOMS_ACCESS,s.TRADING_ROOMS_MODERATE,s.MEDIA_VIEW,s.MEDIA_UPLOAD],[r.MEMBER]:[s.DASHBOARD_VIEW,s.TRADING_ROOMS_ACCESS,s.MEDIA_VIEW],[r.USER]:[s.DASHBOARD_VIEW]});function O(e){return e?D.includes(e.toLowerCase()):!1}function R(e){return e?!!(O(e.email)||e.roles?.some(n=>n.toLowerCase()===r.SUPERADMIN||n.toLowerCase()==="super_admin"||n.toLowerCase()==="superadmin")):!1}function P(e){return e?!!(R(e)||e.is_admin||e.roles?.some(n=>["admin","administrator","super-admin","super_admin","superadmin"].includes(n.toLowerCase()))):!1}function m(e){if(!e)return[];if(R(e))return Object.values(s);const n=new Set;if(e.permissions&&e.permissions.forEach(o=>n.add(o)),e.roles)for(const o of e.roles){const S=o.toLowerCase(),t=p[S];t&&t.forEach(i=>n.add(i))}return Array.from(n)}function M(e){if(!e)return r.USER;if(O(e.email))return r.SUPERADMIN;if(!e.roles||e.roles.length===0)return r.USER;let n=0;for(const o of e.roles){const S=o.toLowerCase().replace("_","-"),t=A.indexOf(S);t>n&&(n=t)}return A[n]??r.USER}const U=()=>{let e=null;return{setAccessToken:n=>{e=n},getAccessToken:()=>e,clearTokens:()=>{e=null}}},c=U(),g="rtp_session_id",_="rtp_token_expiry";function d(e,n,o){return null}function C(){const e=d(),n=d(),o=n?parseInt(n,10):null;return{user:null,sessionId:e,tokenExpiry:o,isAuthenticated:!1,isInitializing:!!e,isLoading:!1,sessionInvalidated:!1,invalidationReason:null}}function N(){const{subscribe:e,set:n,update:o}=f(C());let S=null;return{subscribe:e,setAuth:(t,i,l,u)=>{c.setAccessToken(i);let I=null;u&&(I=Date.now()+u*1e3,d("set",_,I.toString())),o(T=>({...T,user:t,sessionId:l??T.sessionId,tokenExpiry:I,isAuthenticated:!0,isInitializing:!1,isLoading:!1,sessionInvalidated:!1,invalidationReason:null}))},updateToken:(t,i)=>{c.setAccessToken(t);let l=null;i&&(l=Date.now()+i*1e3,d("set",_,l.toString())),o(u=>({...u,tokenExpiry:l}))},setUser:t=>{o(i=>({...i,user:t,isAuthenticated:!0,isInitializing:!1}))},setSessionInvalidated:t=>{o(i=>({...i,sessionInvalidated:!0,invalidationReason:t||"Your session was ended because you signed in from another device."}))},clearSessionInvalidated:()=>{o(t=>({...t,sessionInvalidated:!1,invalidationReason:null}))},clearAuth:()=>{c.clearTokens(),n({user:null,sessionId:null,tokenExpiry:null,isAuthenticated:!1,isInitializing:!1,isLoading:!1,sessionInvalidated:!1,invalidationReason:null})},setLoading:t=>{o(i=>({...i,isLoading:t}))},completeInitialization:t=>{o(i=>({...i,isInitializing:!1,isAuthenticated:t}))},getToken:()=>c.getAccessToken(),getSessionId:()=>d(),isTokenExpired:()=>{const t=d();if(!t)return!0;const i=parseInt(t,10);return Date.now()>=i-3e4},refreshToken:async()=>{if(S)return await S,!!c.getAccessToken();S=(async()=>{try{const t=await fetch("/api/auth/refresh",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json","X-Session-ID":d("get",g)||""}});if(!t.ok)throw new Error("Token refresh failed");const i=await t.json();if(i.token&&(c.setAccessToken(i.token),i.expires_in)){const l=Date.now()+i.expires_in*1e3;d("set",_,l.toString()),o(u=>({...u,tokenExpiry:l}))}}catch(t){throw t}finally{S=null}})();try{return await S,!0}catch{return!1}},logout:async(t="/login")=>{c.clearTokens(),n({user:null,sessionId:null,tokenExpiry:null,isAuthenticated:!1,isInitializing:!1,isLoading:!1,sessionInvalidated:!1,invalidationReason:null})}}}const a=N(),y=E(a,e=>e.user),V=E(a,e=>e.isAuthenticated);E(a,e=>e.isLoading);E(a,e=>e.isInitializing);E(a,e=>e.sessionId);const W=E(a,e=>e.sessionInvalidated);E(a,e=>e.invalidationReason);E(a,e=>R(e.user));E(a,e=>P(e.user));E(a,e=>M(e.user));E(a,e=>m(e.user));const b=()=>a.getToken();export{s as PERMISSIONS,r as ROLES,D as SUPERADMIN_EMAILS,a as authStore,P as checkIsAdmin,b as getAuthToken,V as isAuthenticated,R as isSuperadmin,W as sessionInvalidated,y as user};
