import{A as l,an as g}from"./vendor-svelte.js";import"./auth.js";import"./client.js";const n="",d="",p=3e5,y=3,w=1e3,b=10;class f{static instance;cache=new Map;offlineQueue=[];wsConnection;analyticsQueue=[];pendingRequests=new Map;forms=l([]);currentForm=l(null);submissions=l([]);isLoading=l(!1);error=l(null);offlineMode=l(!1);constructor(){this.initialize()}static getInstance(){return f.instance||(f.instance=new f),f.instance}initialize(){}getAuthToken(){return""}async authFetch(t,e={}){const{skipCache:s=!1,cacheTTL:r=p,retries:a=y,...i}=e,o=`${i.method||"GET"}:${t}`;if(!s&&!i.method||i.method==="GET"){const u=this.getFromCache(o);if(u)return u}if(this.pendingRequests.has(o))return this.pendingRequests.get(o);const c=this.executeRequest(t,i,a);this.pendingRequests.set(o,c);try{const u=await c;return(!i.method||i.method==="GET")&&this.setCache(o,u,r),u}finally{this.pendingRequests.delete(o)}}async executeRequest(t,e,s){const r=this.getAuthToken(),a={"Content-Type":"application/json",Accept:"application/json",...r?{Authorization:`Bearer ${r}`}:{},...e.headers};try{const i=await fetch(t,{...e,headers:a});if(!i.ok){if(i.status===401)try{const{authStore:c}=await import("./auth.js");if(await c.refreshToken()&&s>0)return this.executeRequest(t,e,s-1)}catch{await this.clearAuth()}const o=await i.json().catch(()=>({message:"Request failed"}));throw new Error(o.message||`HTTP ${i.status}`)}return i.json()}catch(i){if(s>0&&this.shouldRetry(i))return await new Promise(o=>setTimeout(o,w)),this.executeRequest(t,e,s-1);throw this.isNetworkError(i)?(this.queueOfflineRequest({url:t,options:e}),new Error("Request queued for offline processing")):i}}getFromCache(t){const e=this.cache.get(t);return e&&Date.now()<e.expiry?e.data:null}setCache(t,e,s){this.cache.set(t,{data:e,expiry:Date.now()+s})}clearCache(t){if(t)for(const e of this.cache.keys())e.includes(t)&&this.cache.delete(e);else this.cache.clear()}setupWebSocket(){}authenticate(){this.wsConnection&&this.wsConnection.send(JSON.stringify({type:"auth",token:this.getAuthToken()}))}handleWebSocketMessage(t){try{const e=JSON.parse(t.data);switch(e.type){case"form_updated":this.handleFormUpdate(e.data);break;case"new_submission":this.handleNewSubmission(e.data);break;case"collaboration":this.handleCollaboration(e.data);break}}catch{}}handleFormUpdate(t){this.forms.update(s=>{const r=s.findIndex(a=>a.id===t.id);return r>=0?s[r]=t:s.push(t),s}),g(this.currentForm)?.id===t.id&&this.currentForm.set(t)}handleNewSubmission(t){this.submissions.update(e=>[...e,t]),this.showNotification(`New submission for form ${t.form_id}`)}handleCollaboration(t){}setupOfflineDetection(){}loadOfflineQueue(){}saveOfflineQueue(){}queueOfflineRequest(t){this.offlineQueue.push({...t,timestamp:Date.now()}),this.saveOfflineQueue()}async processOfflineQueue(){if(this.offlineQueue.length!==0){for(const t of this.offlineQueue)try{await this.executeRequest(t.url,t.options,0)}catch{}this.offlineQueue=[],this.saveOfflineQueue()}}setupAutosave(){}async saveDraft(t){try{await this.updateForm(t.id,{...t,status:"draft"})}catch{}}trackEvent(t,e){this.analyticsQueue.push({event:t,data:e,timestamp:Date.now()}),this.analyticsQueue.length>=b&&this.flushAnalytics()}async flushAnalytics(){if(this.analyticsQueue.length===0)return;const t=[...this.analyticsQueue];this.analyticsQueue=[];try{await this.authFetch(`${n}/forms/analytics/track`,{method:"POST",body:JSON.stringify({events:t}),skipCache:!0})}catch{this.analyticsQueue.unshift(...t)}}processAnalyticsQueue(){setInterval(()=>this.flushAnalytics(),6e4)}shouldRetry(t){return t?.message?.includes("Network")||t?.message?.includes("fetch")}isNetworkError(t){return!navigator.onLine||t?.message?.includes("Network")}async clearAuth(){}showNotification(t){}async getForms(t=1,e=20,s){this.isLoading.set(!0),this.error.set(null);try{const r=new URLSearchParams({page:t.toString(),per_page:e.toString()});s?.status&&r.set("status",s.status);const a=await this.authFetch(`${n}/forms?${r}`);let i=[],o=0,c=e;return a?.data?.data?(i=a.data.data,o=a.data.total||i.length,c=a.data.per_page||e):a?.data&&Array.isArray(a.data)?(i=a.data,o=i.length):a?.forms?(i=a.forms,o=a.total??i.length,c=a.perPage??e):Array.isArray(a)&&(i=a,o=i.length),this.forms.set(i),{forms:i,total:o,perPage:c}}catch(r){throw this.error.set(r.message),r}finally{this.isLoading.set(!1)}}async getForm(t){this.isLoading.set(!0),this.error.set(null);try{const e=await this.authFetch(`${n}/forms/${t}`);return this.currentForm.set(e),this.trackEvent("form_viewed",{form_id:t}),e}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async createForm(t){this.isLoading.set(!0),this.error.set(null);try{const e=await this.authFetch(`${n}/forms`,{method:"POST",body:JSON.stringify(t),skipCache:!0});return this.forms.update(s=>[...s,e]),this.clearCache("/forms"),this.trackEvent("form_created",{form_id:e.id}),e}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async updateForm(t,e){this.isLoading.set(!0),this.error.set(null);try{this.forms.update(r=>{const a=r.findIndex(i=>i.id===t);return a>=0&&(r[a]={...r[a],...e}),r});const s=await this.authFetch(`${n}/forms/${t}`,{method:"PUT",body:JSON.stringify(e),skipCache:!0});return this.clearCache(`/forms/${t}`),this.trackEvent("form_updated",{form_id:t}),s}catch(s){throw await this.getForms(),this.error.set(s.message),s}finally{this.isLoading.set(!1)}}async deleteForm(t){this.isLoading.set(!0),this.error.set(null);try{this.forms.update(e=>e.filter(s=>s.id!==t)),await this.authFetch(`${n}/forms/${t}`,{method:"DELETE",skipCache:!0}),this.clearCache("/forms"),this.trackEvent("form_deleted",{form_id:t})}catch(e){throw await this.getForms(),this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async duplicateForm(t){this.isLoading.set(!0),this.error.set(null);try{const e=await this.authFetch(`${n}/forms/${t}/duplicate`,{method:"POST",skipCache:!0});return this.forms.update(s=>[...s,e]),this.trackEvent("form_duplicated",{original_id:t,new_id:e.id}),e}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async generateFormWithAI(t){this.isLoading.set(!0),this.error.set(null);try{const e=await this.authFetch(`${d}/generate-form`,{method:"POST",body:JSON.stringify({prompt:t}),skipCache:!0});return this.trackEvent("ai_form_generated",{prompt:t}),e.form}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async suggestFields(t){try{return(await this.authFetch(`${d}/suggest-fields`,{method:"POST",body:JSON.stringify({context:t}),skipCache:!0})).fields}catch{return[]}}async optimizeForm(t){this.isLoading.set(!0),this.error.set(null);try{const e=await this.authFetch(`${d}/optimize-form/${t}`,{method:"POST",skipCache:!0});return this.trackEvent("form_optimized",{form_id:t}),e.form}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async submitForm(t,e){try{const r=await(await fetch(`${n}/forms/${t}/submit`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)})).json();return this.trackEvent("form_submitted",{form_slug:t,success:r.success}),r}catch(s){if(this.isNetworkError(s))return this.queueOfflineRequest({url:`${n}/forms/${t}/submit`,options:{method:"POST",body:JSON.stringify(e)}}),{success:!1,message:"Your submission has been queued and will be sent when you're back online."};throw s}}async getSubmissions(t,e=1,s=20,r){this.isLoading.set(!0),this.error.set(null);try{const a=new URLSearchParams({page:e.toString(),perPage:s.toString(),...r}),i=await this.authFetch(`${n}/forms/${t}/submissions?${a}`);return this.submissions.set(i.submissions),i}catch(a){throw this.error.set(a.message),a}finally{this.isLoading.set(!1)}}async exportSubmissions(t,e="csv"){const s=this.getAuthToken(),r=await fetch(`${n}/forms/${t}/submissions/export?format=${e}`,{headers:{Accept:e==="csv"?"text/csv":"application/octet-stream",...s?{Authorization:`Bearer ${s}`}:{}}});if(!r.ok)throw new Error("Export failed");return r.blob()}async getFormAnalytics(t){return this.authFetch(`${n}/forms/${t}/analytics`)}async getConversionFunnel(t){return this.authFetch(`${n}/forms/${t}/analytics/funnel`)}async getFieldHeatmap(t){return this.authFetch(`${n}/forms/${t}/analytics/heatmap`)}async getUserRecording(t){return this.authFetch(`${n}/submissions/${t}/recording`)}async createABTest(t,e){return this.authFetch(`${n}/forms/${t}/ab-test`,{method:"POST",body:JSON.stringify(e),skipCache:!0})}async getABTestResults(t,e){return this.authFetch(`${n}/forms/${t}/ab-test/${e}/results`)}joinCollaboration(t){this.wsConnection&&this.wsConnection.send(JSON.stringify({type:"join_collaboration",form_id:t}))}leaveCollaboration(t){this.wsConnection&&this.wsConnection.send(JSON.stringify({type:"leave_collaboration",form_id:t}))}sendCollaborationUpdate(t,e){this.wsConnection&&this.wsConnection.send(JSON.stringify({type:"collaboration_update",form_id:t,update:e}))}async validateField(t,e){const s=[];if(t.required&&!e&&s.push(`${t.label} is required`),t.validation&&(typeof e=="string"&&(t.validation.min_length&&e.length<t.validation.min_length&&s.push(`${t.label} must be at least ${t.validation.min_length} characters`),t.validation.max_length&&e.length>t.validation.max_length&&s.push(`${t.label} must be no more than ${t.validation.max_length} characters`)),t.validation.pattern&&(new RegExp(t.validation.pattern).test(e)||s.push(t.validation.pattern_message||`${t.label} format is invalid`)),t.validation.async))try{const r=await this.authFetch(`${n}/validate`,{method:"POST",body:JSON.stringify({field:t,value:e}),skipCache:!0});!r.valid&&r.message&&s.push(r.message)}catch{}return{valid:s.length===0,errors:s}}async getFormTemplates(t){const e=t?`?category=${t}`:"";return this.authFetch(`${n}/forms/templates${e}`)}async createFromTemplate(t){const e=await this.authFetch(`${n}/forms/templates/${t}/use`,{method:"POST",skipCache:!0});return this.forms.update(s=>[...s,e]),this.trackEvent("template_used",{template_id:t}),e}}const h=f.getInstance();h.forms;h.currentForm;h.submissions;h.isLoading;h.error;h.offlineMode;const S=(m,t,e)=>h.getForms(m,t,e),C=(m,t,e,s)=>h.getSubmissions(m,t,e,s),_=(m,t)=>h.exportSubmissions(m,t);export{C as a,_ as e,S as g};
