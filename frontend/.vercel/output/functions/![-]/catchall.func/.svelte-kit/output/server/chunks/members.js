import{z as m,A as d,an as c}from"./vendor-svelte.js";import{a as o}from"./client.js";import{getAuthToken as S}from"./auth.js";const l={async getMembers(s){const n=new URLSearchParams;s&&Object.entries(s).forEach(([e,r])=>{r!=null&&r!==""&&n.append(e,String(r))});const a=n.toString(),t=`/admin/members${a?`?${a}`:""}`;return o.get(t,{cache:{ttl:6e4}})},async getStats(){return o.get("/admin/members/stats",{cache:{ttl:3e5}})},async getServices(){return o.get("/admin/members/services",{cache:{ttl:3e5}})},async getMembersByService(s,n){const a=new URLSearchParams;n&&Object.entries(n).forEach(([e,r])=>{r!=null&&r!==""&&a.append(e,String(r))});const t=a.toString();return o.get(`/admin/members/service/${s}${t?`?${t}`:""}`)},async getChurnedMembers(s){const n=new URLSearchParams;s&&Object.entries(s).forEach(([t,e])=>{e!=null&&e!==""&&n.append(t,String(e))});const a=n.toString();return o.get(`/admin/members/churned${a?`?${a}`:""}`)},async getMember(s){return o.get(`/admin/members/${s}`)},async getEmailTemplates(){return o.get("/admin/members/email-templates",{cache:{ttl:3e5}})},async sendEmail(s,n){return o.post(`/admin/members/${s}/send-email`,n)},async sendBulkEmail(s){return o.post("/admin/members/bulk-email",s)},async exportMembers(s){const n=new URLSearchParams;s?.status&&n.append("status",s.status);const a=n.toString(),t=S();return(await fetch(`/api/admin/members/export${a?`?${a}`:""}`,{headers:{Authorization:`Bearer ${t}`}})).blob()}},u={members:[],stats:null,services:[],pagination:null,filters:{per_page:25,page:1,sort_by:"created_at",sort_dir:"desc"},loading:!1,error:null,selectedMember:null,selectedMemberEngagement:0,selectedMemberTimeline:[]},b={members:[],stats:null,pagination:null,filters:{per_page:25,page:1},loading:!1,error:null},p={service:null,stats:null,members:[],pagination:null,loading:!1,error:null},f={templates:[],presetTemplates:[],loading:!1,sending:!1,error:null};function h(){const{subscribe:s,set:n,update:a}=d(u);return{subscribe:s,async loadMembers(t){a(e=>({...e,loading:!0,error:null,filters:t?{...e.filters,...t}:e.filters}));try{const e=c({subscribe:s}),r=await l.getMembers(e.filters);a(i=>({...i,members:r.members,pagination:r.pagination,loading:!1}))}catch(e){a(r=>({...r,error:e instanceof Error?e.message:"Failed to load members",loading:!1}))}},async loadStats(){try{const t=await l.getStats();a(e=>({...e,stats:t}))}catch{}},async loadServices(){try{const t=await l.getServices();a(e=>({...e,services:t.services}))}catch{}},async loadMember(t){a(e=>({...e,loading:!0,error:null}));try{const e=await l.getMember(t);a(r=>({...r,selectedMember:e.member,selectedMemberEngagement:e.engagement_score,selectedMemberTimeline:e.timeline,loading:!1}))}catch(e){a(r=>({...r,error:e instanceof Error?e.message:"Failed to load member",loading:!1}))}},async setFilters(t){const r={...c({subscribe:s}).filters,...t,page:1};await this.loadMembers(r)},async goToPage(t){await this.loadMembers({page:t})},clearSelectedMember(){a(t=>({...t,selectedMember:null,selectedMemberEngagement:0,selectedMemberTimeline:[]}))},reset(){n(u)}}}function y(){const{subscribe:s,set:n,update:a}=d(b);return{subscribe:s,async loadChurnedMembers(t){a(e=>({...e,loading:!0,error:null,filters:t?{...e.filters,...t}:e.filters}));try{const e=c({subscribe:s}),r=await l.getChurnedMembers(e.filters);a(i=>({...i,members:r.members,stats:r.stats,pagination:r.pagination,loading:!1}))}catch(e){a(r=>({...r,error:e instanceof Error?e.message:"Failed to load churned members",loading:!1}))}},async setFilters(t){const r={...c({subscribe:s}).filters,...t,page:1};await this.loadChurnedMembers(r)},async goToPage(t){await this.loadChurnedMembers({page:t})},reset(){n(b)}}}function M(){const{subscribe:s,set:n,update:a}=d(p);return{subscribe:s,async loadServiceMembers(t,e){a(r=>({...r,loading:!0,error:null}));try{const r=await l.getMembersByService(t,e);a(i=>({...i,service:r.service,stats:r.stats,members:r.members,pagination:r.pagination,loading:!1}))}catch(r){a(i=>({...i,error:r instanceof Error?r.message:"Failed to load service members",loading:!1}))}},reset(){n(p)}}}function w(){const{subscribe:s,set:n,update:a}=d(f);return{subscribe:s,async loadTemplates(){a(t=>({...t,loading:!0,error:null}));try{const t=await l.getEmailTemplates();a(e=>({...e,templates:t.templates,presetTemplates:t.preset_templates,loading:!1}))}catch(t){a(e=>({...e,error:t instanceof Error?t.message:"Failed to load templates",loading:!1}))}},async sendEmail(t,e){a(r=>({...r,sending:!0,error:null}));try{const r=await l.sendEmail(t,e);return a(i=>({...i,sending:!1})),r}catch(r){throw a(i=>({...i,error:r instanceof Error?r.message:"Failed to send email",sending:!1})),r}},async sendBulkEmail(t){a(e=>({...e,sending:!0,error:null}));try{const e=await l.sendBulkEmail(t);return a(r=>({...r,sending:!1})),e}catch(e){throw a(r=>({...r,error:e instanceof Error?e.message:"Failed to send emails",sending:!1})),e}},reset(){n(f)}}}const g=h(),T=y(),_=M();w();m(g,s=>s.stats?s.stats.subscriptions.active:0);m(g,s=>s.stats?s.stats.overview.total_members:0);m(g,s=>s.stats?s.stats.revenue.mrr:0);m(g,s=>s.stats?s.stats.subscriptions.churn_rate:0);export{T as c,g as m,_ as s};
