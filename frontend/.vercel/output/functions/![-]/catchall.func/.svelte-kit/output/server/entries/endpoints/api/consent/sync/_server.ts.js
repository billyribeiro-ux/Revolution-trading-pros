import{error as n,json as i}from"@sveltejs/kit";const r=new Map,g=async({request:o})=>{try{const e=await o.json(),{consentId:s,userId:t,sessionId:a,consent:c,metadata:f,auditLog:l}=e;if(!s||!c)throw n(400,"Missing required fields: consentId, consent");const d=new Date().toISOString(),u={consentId:s,userId:t,sessionId:a,consent:{necessary:c.necessary??!0,analytics:c.analytics??!1,marketing:c.marketing??!1,preferences:c.preferences??!1},metadata:f||{},auditLog:l||[],createdAt:r.get(s)?.createdAt||d,updatedAt:d};return r.set(s,u),t&&r.set(`user:${t}`,u),i({success:!0,consentId:s,serverTimestamp:d,message:"Consent saved successfully"})}catch(e){throw e&&typeof e=="object"&&"status"in e?e:n(500,"Internal server error")}},y=async({url:o})=>{try{const e=o.searchParams.get("userId"),s=o.searchParams.get("consentId");let t=null;if(e)t=r.get(`user:${e}`);else if(s)t=r.get(s);else throw n(400,"Missing required parameter: userId or consentId");if(!t)throw n(404,"Consent not found");return i({success:!0,consent:{consentId:t.consentId,necessary:t.consent.necessary,analytics:t.consent.analytics,marketing:t.consent.marketing,preferences:t.consent.preferences,updatedAt:t.updatedAt,...t.metadata}})}catch(e){throw e&&typeof e=="object"&&"status"in e?e:n(500,"Internal server error")}},m=async({url:o})=>{try{const e=o.searchParams.get("userId"),s=o.searchParams.get("consentId");let t=!1;if(e){const a=r.get(`user:${e}`);a&&(r.delete(`user:${e}`),r.delete(a.consentId),t=!0)}else if(s)t=r.delete(s);else throw n(400,"Missing required parameter: userId or consentId");if(!t)throw n(404,"Consent not found");return i({success:!0,message:"Consent deleted successfully"})}catch(e){throw e&&typeof e=="object"&&"status"in e?e:n(500,"Internal server error")}};export{m as DELETE,y as GET,g as POST};
