var v=Object.defineProperty;var T=(o,e,t)=>e in o?v(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var u=(o,e,t)=>T(o,typeof e!="symbol"?e+"":e,t);import{d1 as g}from"./C_QN0JMx.js";import{authStore as a}from"./D3S43Cfl.js";const S={},_=S.VITE_API_URL||"http://localhost:8000/api",b="v1",A=3e4,p=3,I=1e3,w=3e5,O=6e4,q={"X-Requested-With":"XMLHttpRequest","X-Client-Version":"2.0.0","X-Client-Platform":"web"};class h extends Error{constructor(e,t,s){super(e),this.code=t,this.errors=s,this.name="AuthError",Object.setPrototypeOf(this,h.prototype)}}class m extends h{constructor(e,t){super(e,"VALIDATION_ERROR",t),this.name="ValidationError"}}class f extends h{constructor(e="Unauthorized"){super(e,"UNAUTHORIZED"),this.name="UnauthorizedError"}}class P extends h{constructor(e="MFA verification required"){super(e,"MFA_REQUIRED"),this.name="MFARequiredError"}}class E extends h{constructor(e="Rate limit exceeded",t){super(e,"RATE_LIMITED"),this.retryAfter=t,this.name="RateLimitError"}}class y extends h{constructor(e="Your session has been invalidated"){super(e,"SESSION_INVALIDATED"),this.name="SessionInvalidatedError"}}const d=class d{constructor(){u(this,"tokenRefreshTimeout");u(this,"sessionCheckInterval");u(this,"pendingRefresh",null);u(this,"requestQueue",new Map);u(this,"sessionFingerprint");u(this,"abortController");u(this,"securityObserver");u(this,"visibilityChangeHandler");u(this,"onlineHandler");this.initialize()}static getInstance(){return d.instance||(d.instance=new d),d.instance}initialize(){this.sessionFingerprint=this.generateSessionFingerprint(),this.scheduleTokenRefresh(),this.startSessionMonitoring(),this.setupSecurityMonitoring()}generateSessionFingerprint(){const e=[navigator.userAgent,navigator.language,new Date().getTimezoneOffset(),screen.width,screen.height,screen.colorDepth];return btoa(e.join("|"))}async apiRequest(e,t={}){const{skipAuth:s=!1,retries:n=p,...i}=t,r=`${i.method||"GET"}:${e}`;if(this.requestQueue.has(r)&&i.method==="GET")return this.requestQueue.get(r);const c=this.executeRequest(e,i,s,n);return i.method==="GET"&&(this.requestQueue.set(r,c),c.finally(()=>this.requestQueue.delete(r))),c}async executeRequest(e,t,s,n){this.abortController=new AbortController;const i=setTimeout(()=>this.abortController?.abort(),A);try{const r=await this.buildHeaders(s,t.headers);Object.assign(r,q),this.sessionFingerprint&&(r["X-Session-Fingerprint"]=this.sessionFingerprint);const c=await fetch(`${_}${e}`,{...t,headers:r,signal:this.abortController.signal,credentials:"include"});return clearTimeout(i),await this.handleResponse(c,e,t,s,n)}catch(r){if(clearTimeout(i),n>0&&this.shouldRetry(r)){const c=I*Math.pow(2,p-n);return await new Promise(R=>setTimeout(R,c)),this.executeRequest(e,t,s,n-1)}throw this.transformError(r)}}async buildHeaders(e,t){const s={"Content-Type":"application/json",Accept:"application/json","X-API-Version":b};if(t&&Object.assign(s,t),!e){const i=await this.getValidToken();i&&(s.Authorization=`Bearer ${i}`);const r=a.getSessionId();r&&(s["X-Session-ID"]=r)}const n=this.getCSRFToken();return n&&(s["X-CSRF-Token"]=n),s}async getValidToken(){const e=a.getToken(),t=g(a);if(!e)return null;if(this.isTokenExpiringSoon(t.tokenExpiry??void 0))try{return await this.refreshToken(),a.getToken()}catch{return null}return e}async handleResponse(e,t,s,n,i){if(e.status===429){const r=parseInt(e.headers.get("Retry-After")||"60",10);throw new E("Rate limit exceeded",r)}if(e.status===401&&!n){try{const r=await e.clone().json();if(r.code==="SESSION_INVALIDATED")throw a.setSessionInvalidated(r.message),a.clearAuth(),new y(r.message)}catch(r){if(r instanceof y)throw r}if(i===p)try{return await this.refreshToken(),this.executeRequest(t,s,n,i-1)}catch(r){throw r instanceof y?r:(a.clearAuth(),new f)}throw a.clearAuth(),new f}if(e.status===422){const r=await e.json();throw new m(r.message||"Validation failed",r.errors||{})}if(!e.ok){const r=await e.json().catch(()=>({message:"Request failed"}));throw new h(r.message||`Request failed with status ${e.status}`,r.code)}return e.json()}shouldRetry(e){return e instanceof E||e instanceof m||e instanceof f?!1:e.name==="AbortError"||e.name==="NetworkError"||e instanceof h&&!!e.code?.startsWith("5")}transformError(e){return e instanceof h?e:e.name==="AbortError"?new h("Request timeout","TIMEOUT"):e.name==="NetworkError"?new h("Network error","NETWORK_ERROR"):new h(e.message||"Unknown error","UNKNOWN")}isTokenExpiringSoon(e){return e?Date.now()>e-w:!1}getCSRFToken(){const e=document.cookie.split(";");for(const s of e){const[n,i]=s.trim().split("=");if(n==="XSRF-TOKEN"&&i)return decodeURIComponent(i)}return document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||null}async register(e){if(e.password!==e.password_confirmation)throw new m("Passwords do not match",{password_confirmation:["Password confirmation does not match"]});this.validatePasswordStrength(e.password);const t=await this.apiRequest("/register",{method:"POST",body:JSON.stringify(e),skipAuth:!0});return this.trackEvent("user_registered",{email:e.email}),t.message||"Registration successful. Please check your email to verify your account."}async login(e){const t={...e,device_name:e.device_name||navigator.userAgent,device_fingerprint:this.sessionFingerprint},s=await this.apiRequest("/login",{method:"POST",body:JSON.stringify(t),skipAuth:!0});if(s.mfa_required)throw new P;a.setAuth(s.user,s.token,s.session_id,s.expires_in),s.expires_in&&this.scheduleTokenRefresh(s.expires_in*1e3);try{const n=await this.getUser();return this.trackEvent("user_logged_in",{email:n.email,method:"password"}),n}catch{return s.user}}async loginWithBiometric(e){const t={credential:e,device_id:this.getDeviceId()},s=await this.apiRequest("/login/biometric",{method:"POST",body:JSON.stringify(t),skipAuth:!0});return a.setAuth(s.user,s.token,s.session_id,s.expires_in),s.expires_in&&this.scheduleTokenRefresh(s.expires_in*1e3),this.trackEvent("user_logged_in",{email:s.user.email,method:"biometric"}),s.user}async logout(){try{await this.apiRequest("/logout",{method:"POST"});const e=g(a).user;e&&this.trackEvent("user_logged_out",{email:e.email})}catch{}finally{this.clearAuth()}}async getUser(){const e=await this.apiRequest("/me");return a.setUser(e),e}async updateProfile(e){const t=new FormData;Object.entries(e).forEach(([n,i])=>{i!==void 0&&!(i instanceof File)&&t.append(n,typeof i=="object"?JSON.stringify(i):String(i))}),e.avatar&&t.append("avatar",e.avatar);const s=await this.apiRequest("/me",{method:"PUT",body:t});return a.setUser(s),this.trackEvent("profile_updated",{email:s.email}),s}async changePassword(e){const t=await this.apiRequest("/me/password",{method:"PUT",body:JSON.stringify(e)});return this.trackEvent("password_changed"),e.revoke_sessions&&this.clearAuth(),t.message}async forgotPassword(e){const t=await this.apiRequest("/forgot-password",{method:"POST",body:JSON.stringify(e),skipAuth:!0});return this.trackEvent("password_reset_requested",{email:e.email}),t.message}async resetPassword(e){this.validatePasswordStrength(e.password);const t=await this.apiRequest("/reset-password",{method:"POST",body:JSON.stringify(e),skipAuth:!0});return this.trackEvent("password_reset_completed",{email:e.email}),t.message}async sendEmailVerification(){return(await this.apiRequest("/email/verification-notification",{method:"POST"})).message}async verifyEmail(e,t,s){const n=await this.apiRequest(`/email/verify/${e}/${t}?signature=${s}`,{method:"GET"});return await this.getUser(),this.trackEvent("email_verified"),n.message}async enableMFA(){const e=await this.apiRequest("/me/mfa/enable",{method:"POST"});return this.trackEvent("mfa_setup_initiated"),e}async verifyMFA(e){const t=await this.apiRequest("/me/mfa/verify",{method:"POST",body:JSON.stringify({code:e})});return this.trackEvent("mfa_enabled"),t.message}async disableMFA(e){const t=await this.apiRequest("/me/mfa/disable",{method:"POST",body:JSON.stringify({password:e})});return this.trackEvent("mfa_disabled"),t.message}async loginWithMFA(e,t,s,n){const i=await this.apiRequest("/login/mfa",{method:"POST",body:JSON.stringify({email:e,password:t,mfa_code:s,backup_code:n}),skipAuth:!0});return a.setAuth(i.user,i.token,i.session_id,i.expires_in),i.expires_in&&this.scheduleTokenRefresh(i.expires_in*1e3),this.trackEvent("mfa_login",{email:e}),i}async getSecurityEvents(){return this.apiRequest("/me/security-events")}async getSessions(){return this.apiRequest("/me/sessions")}async revokeSession(e){return this.apiRequest(`/me/sessions/${e}`,{method:"DELETE"})}async logoutAllDevices(e=!1){return this.apiRequest("/me/sessions/logout-all",{method:"POST",body:JSON.stringify({keep_current:e})})}async refreshToken(){if(this.pendingRefresh)return this.pendingRefresh;this.pendingRefresh=this.performTokenRefresh();try{return await this.pendingRefresh}finally{this.pendingRefresh=null}}async performTokenRefresh(){if(!a.getSessionId())throw new f("No session available for refresh");if(!await a.refreshToken())throw new f("Token refresh failed");const s=a.getToken(),n=g(a);if(n.tokenExpiry){const i=n.tokenExpiry-Date.now();i>0&&this.scheduleTokenRefresh(i)}return{token:s||"",refresh_token:"",expires_in:n.tokenExpiry?Math.floor((n.tokenExpiry-Date.now())/1e3):3600}}scheduleTokenRefresh(e){if(this.tokenRefreshTimeout&&clearTimeout(this.tokenRefreshTimeout),!a.getToken())return;const s=e?e-w:w;this.tokenRefreshTimeout=window.setTimeout(()=>{this.refreshToken().catch(n=>{this.clearAuth()})},s)}startSessionMonitoring(){this.stopSessionMonitoring(),this.sessionCheckInterval=window.setInterval(()=>{this.checkSession()},O),this.visibilityChangeHandler=()=>{document.hidden||this.checkSession()},this.onlineHandler=()=>{this.checkSession()},document.addEventListener("visibilitychange",this.visibilityChangeHandler),window.addEventListener("online",this.onlineHandler)}stopSessionMonitoring(){this.sessionCheckInterval!==void 0&&(clearInterval(this.sessionCheckInterval),delete this.sessionCheckInterval),this.visibilityChangeHandler&&(document.removeEventListener("visibilitychange",this.visibilityChangeHandler),delete this.visibilityChangeHandler),this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),delete this.onlineHandler)}async checkSession(){if(a.getToken())try{await this.apiRequest("/auth/check")}catch(t){t instanceof f&&this.clearAuth()}}clearAuth(){a.clearAuth(),this.tokenRefreshTimeout!==void 0&&(clearTimeout(this.tokenRefreshTimeout),delete this.tokenRefreshTimeout),this.stopSessionMonitoring(),this.abortController?.abort(),this.requestQueue.clear()}setupSecurityMonitoring(){const e=new MutationObserver(t=>{for(const s of t)if(s.type==="childList"){const n=Array.from(s.addedNodes);for(const i of n)i instanceof HTMLScriptElement&&i.src&&!this.isTrustedScript(i.src)&&(i.remove(),this.trackSecurityEvent("suspicious_script",{src:i.src}))}});this.securityObserver=e,e.observe(document.head,{childList:!0,subtree:!1})}isTrustedScript(e){return[window.location.origin,"https://cdn.jsdelivr.net","https://unpkg.com","https://www.google-analytics.com","https://www.googletagmanager.com"].some(s=>e.startsWith(s))}validatePasswordStrength(e){const s=/[A-Z]/.test(e),n=/[a-z]/.test(e),i=/\d/.test(e),r=/[!@#$%^&*]/.test(e),c=[];if(e.length<8&&c.push("Password must be at least 8 characters"),s||c.push("Password must contain at least one uppercase letter"),n||c.push("Password must contain at least one lowercase letter"),i||c.push("Password must contain at least one number"),r||c.push("Password must contain at least one special character"),c.length>0)throw new m("Password does not meet requirements",{password:c})}getDeviceId(){let e=localStorage.getItem("device_id");return e||(e=crypto.randomUUID(),localStorage.setItem("device_id",e)),e}trackEvent(e,t){"gtag"in window&&window.gtag("event",e,{event_category:"authentication",...t}),"analytics"in window&&window.analytics.track(e,t)}trackSecurityEvent(e,t){this.apiRequest("/security/events",{method:"POST",body:JSON.stringify({type:e,data:t,timestamp:new Date().toISOString()})}).catch(s=>{})}};u(d,"instance");let k=d;const l=k.getInstance(),D=o=>l.register(o),U=o=>l.login(o),M=async o=>(await l.register(o),l.login({email:o.email,password:o.password})),F=()=>l.logout(),H=()=>l.getUser(),L=o=>l.forgotPassword(o),V=o=>l.resetPassword(o),j=()=>l.sendEmailVerification(),J=(o,e,t)=>l.verifyEmail(o,e,t);export{l as a,U as b,V as c,M as d,L as f,H as g,F as l,D as r,j as s,J as v};
