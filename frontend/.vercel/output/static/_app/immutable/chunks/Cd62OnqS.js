var o=Object.defineProperty;var l=(n,e,t)=>e in n?o(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var s=(n,e,t)=>l(n,typeof e!="symbol"?e+"":e,t);function c(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function h(){const n=localStorage.getItem("behavior_visitor_id");if(n)return n;const e=`visitor_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return localStorage.setItem("behavior_visitor_id",e),e}class m{constructor(e={}){s(this,"config");s(this,"sessionId");s(this,"visitorId");s(this,"userId");s(this,"eventBuffer",[]);s(this,"bufferTimer");s(this,"sessionStartTime");s(this,"lastEventTime");s(this,"sequenceNumber",0);s(this,"maxScrollDepth",0);s(this,"clickPositions",[]);s(this,"hoverStartTime");s(this,"hoverElement");s(this,"idleTimer");s(this,"isIdle",!1);s(this,"lastScrollY",0);s(this,"lastScrollTime",0);this.config={apiEndpoint:"/api/behavior/events",bufferSize:20,bufferTimeout:5e3,trackScrollDepth:!0,trackRageClicks:!0,trackHoverIntent:!0,trackFormBehavior:!0,trackCursorMovement:!1,trackIdleTime:!0,rageClickThreshold:3,rageClickWindow:1e3,hoverIntentDuration:1500,idleTimeout:3e4,speedScrollThreshold:3e3,maskPII:!0,respectDNT:!0,anonymizeIP:!0,sampleRate:1,maxEventsPerSession:1e3,...e},this.sessionId=c(),this.visitorId=h(),this.sessionStartTime=Date.now(),this.lastEventTime=Date.now(),this.init()}init(){this.config.respectDNT&&navigator.doNotTrack==="1"||Math.random()>this.config.sampleRate||(this.setupEventListeners(),this.trackPageView())}setupEventListeners(){document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),window.addEventListener("beforeunload",this.handlePageExit.bind(this)),this.config.trackScrollDepth&&window.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),document.addEventListener("click",this.handleClick.bind(this),!0),this.config.trackHoverIntent&&(document.addEventListener("mouseover",this.handleMouseOver.bind(this),!0),document.addEventListener("mouseout",this.handleMouseOut.bind(this),!0)),this.config.trackFormBehavior&&(document.addEventListener("focus",this.handleFocus.bind(this),!0),document.addEventListener("blur",this.handleBlur.bind(this),!0),document.addEventListener("submit",this.handleFormSubmit.bind(this),!0)),this.config.trackIdleTime&&(this.resetIdleTimer(),["mousedown","mousemove","keypress","scroll","touchstart"].forEach(e=>{document.addEventListener(e,this.resetIdleTimer.bind(this),{passive:!0})})),document.addEventListener("mouseout",this.handleExitIntent.bind(this))}trackPageView(){this.trackEvent({event_type:"page_view",timestamp:Date.now(),page_url:window.location.href,event_metadata:{referrer:document.referrer,entry_type:this.getEntryType(),viewport:{width:window.innerWidth,height:window.innerHeight},utm_source:new URLSearchParams(window.location.search).get("utm_source")||void 0,utm_campaign:new URLSearchParams(window.location.search).get("utm_campaign")||void 0,utm_medium:new URLSearchParams(window.location.search).get("utm_medium")||void 0}})}handleScroll(){const e=window.scrollY,t=document.documentElement.scrollHeight-window.innerHeight,i=Math.round(e/t*100);if(i>this.maxScrollDepth&&[25,50,75,90,100].includes(i)){this.maxScrollDepth=i;const a=Date.now()-this.sessionStartTime;this.trackEvent({event_type:"scroll_depth",timestamp:Date.now(),page_url:window.location.href,event_value:i,event_metadata:{depth_percent:i,time_to_depth:a,scroll_speed:this.calculateScrollSpeed(e)}})}const r=this.calculateScrollSpeed(e);r>this.config.speedScrollThreshold&&this.trackEvent({event_type:"speed_scroll",timestamp:Date.now(),page_url:window.location.href,event_metadata:{speed:r,direction:e>this.lastScrollY?"down":"up",scroll_percent:i}}),e<this.lastScrollY-500&&this.trackEvent({event_type:"scroll_backtrack",timestamp:Date.now(),page_url:window.location.href,event_metadata:{distance:this.lastScrollY-e,from_percent:Math.round(this.lastScrollY/t*100),to_percent:i}}),this.lastScrollY=e,this.lastScrollTime=Date.now()}calculateScrollSpeed(e){const t=Date.now()-this.lastScrollTime;return t===0?0:Math.abs(e-this.lastScrollY)/(t/1e3)}handleClick(e){const t=e.target,i=Date.now();this.trackEvent({event_type:"click",timestamp:i,page_url:window.location.href,element:t.tagName,element_selector:this.getSelector(t),coordinates:{x:e.clientX,y:e.clientY}}),this.config.trackRageClicks&&(this.clickPositions.push({x:e.clientX,y:e.clientY,time:i}),this.clickPositions=this.clickPositions.filter(r=>i-r.time<this.config.rageClickWindow),this.clickPositions.length>=this.config.rageClickThreshold&&this.clickPositions.every(a=>Math.abs(a.x-e.clientX)<50&&Math.abs(a.y-e.clientY)<50)&&(this.trackEvent({event_type:"rage_click",timestamp:i,page_url:window.location.href,element:t.tagName,element_selector:this.getSelector(t),coordinates:{x:e.clientX,y:e.clientY},event_metadata:{click_count:this.clickPositions.length,time_window:this.config.rageClickWindow,frustration_score:Math.min(this.clickPositions.length*10,100),element_type:t.tagName}}),this.clickPositions=[])),t.matches('button, a, [role="button"]')&&(t.classList.contains("cta")||t.classList.contains("btn-primary")||t.getAttribute("data-cta")==="true")&&this.trackEvent({event_type:"cta_click",timestamp:i,page_url:window.location.href,element:t.tagName,element_selector:this.getSelector(t)})}handleMouseOver(e){const t=e.target;this.hoverElement=t,this.hoverStartTime=Date.now(),setTimeout(()=>{if(this.hoverElement===t&&this.hoverStartTime){const i=Date.now()-this.hoverStartTime;if(i>=this.config.hoverIntentDuration){const r=i<2500?"weak":i<4e3?"moderate":"strong";this.trackEvent({event_type:"hover_intent",timestamp:Date.now(),page_url:window.location.href,element:t.tagName,element_selector:this.getSelector(t),event_metadata:{hover_duration:i,cursor_stability:.8,element_type:t.tagName,intent_strength:r}})}}},this.config.hoverIntentDuration)}handleMouseOut(){this.hoverElement=void 0,this.hoverStartTime=void 0}handleFocus(e){const t=e.target;t.matches("input, textarea, select")&&this.trackEvent({event_type:"form_focus",timestamp:Date.now(),page_url:window.location.href,element:t.tagName,element_selector:this.getSelector(t),event_metadata:{field_name:t.name,field_type:t.type,form_id:t.closest("form")?.id}})}handleBlur(e){const t=e.target;t.matches("input, textarea, select")&&this.trackEvent({event_type:"form_blur",timestamp:Date.now(),page_url:window.location.href,element:t.tagName,element_selector:this.getSelector(t),event_metadata:{field_name:t.name,filled:!!t.value,value_length:t.value?.length||0}})}handleFormSubmit(e){const t=e.target;this.trackEvent({event_type:"form_submit",timestamp:Date.now(),page_url:window.location.href,element:"FORM",element_selector:this.getSelector(t),event_metadata:{form_id:t.id,fields_count:t.elements.length,action:t.action}},!0)}handleVisibilityChange(){document.hidden?this.trackEvent({event_type:"tab_blur",timestamp:Date.now(),page_url:window.location.href}):this.trackEvent({event_type:"tab_focus",timestamp:Date.now(),page_url:window.location.href})}handlePageExit(){this.trackEvent({event_type:"page_exit",timestamp:Date.now(),page_url:window.location.href,event_metadata:{duration:Date.now()-this.sessionStartTime,max_scroll_depth:this.maxScrollDepth}},!0),this.flush()}handleExitIntent(e){e.clientY<=0&&e.relatedTarget===null&&this.trackEvent({event_type:"exit_intent",timestamp:Date.now(),page_url:window.location.href,event_metadata:{scroll_depth:this.maxScrollDepth,time_on_page:Date.now()-this.sessionStartTime}})}resetIdleTimer(){this.isIdle&&(this.trackEvent({event_type:"idle_end",timestamp:Date.now(),page_url:window.location.href}),this.isIdle=!1),this.idleTimer&&clearTimeout(this.idleTimer),this.idleTimer=window.setTimeout(()=>{this.isIdle=!0,this.trackEvent({event_type:"idle_start",timestamp:Date.now(),page_url:window.location.href})},this.config.idleTimeout)}getEntryType(){const e=document.referrer;return window.location.search.includes("utm_")?"campaign":e?e.includes("google")||e.includes("bing")?"search":e.includes("facebook")||e.includes("twitter")||e.includes("linkedin")?"social":"referral":"direct"}getSelector(e){return e.id?`#${e.id}`:e.className&&typeof e.className=="string"?`.${e.className.split(" ")[0]}`:e.tagName.toLowerCase()}trackEvent(e,t=!1){this.eventBuffer.length>=this.config.maxEventsPerSession||(this.eventBuffer.push(e),this.sequenceNumber++,this.lastEventTime=Date.now(),t||this.eventBuffer.length>=this.config.bufferSize?this.flush():this.bufferTimer||(this.bufferTimer=window.setTimeout(()=>this.flush(),this.config.bufferTimeout)))}async flush(){if(this.eventBuffer.length===0)return;const e={session_id:this.sessionId,visitor_id:this.visitorId,user_id:this.userId,events:[...this.eventBuffer],client_timestamp:Date.now()};this.eventBuffer=[],this.bufferTimer&&(clearTimeout(this.bufferTimer),this.bufferTimer=void 0);try{await fetch(this.config.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),keepalive:!0})}catch{this.storeFailedBatch(e)}}storeFailedBatch(e){try{const t=localStorage.getItem("behavior_failed_batches"),i=t?JSON.parse(t):[];i.push(e),localStorage.setItem("behavior_failed_batches",JSON.stringify(i.slice(-5)))}catch{}}setUserId(e){this.userId=e}destroy(){this.flush(),this.bufferTimer&&clearTimeout(this.bufferTimer),this.idleTimer&&clearTimeout(this.idleTimer)}}export{m as BehaviorTracker};
