var p=Object.defineProperty;var l=(a,s,t)=>s in a?p(a,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[s]=t;var o=(a,s,t)=>l(a,typeof s!="symbol"?s+"":s,t);import{ac as b}from"./C_QN0JMx.js";class f{constructor(s){o(this,"ws",null);o(this,"reconnectAttempts",0);o(this,"maxReconnectAttempts",5);o(this,"reconnectDelay",1e3);o(this,"subscriptions",new Map);o(this,"connected",b(!1));o(this,"error",b(null));this.url=s}connect(){if(this.ws?.readyState!==WebSocket.OPEN)try{this.ws=new WebSocket(this.url),this.ws.onopen=()=>{this.connected.set(!0),this.error.set(null),this.reconnectAttempts=0},this.ws.onmessage=s=>{try{const t=JSON.parse(s.data);this.handleMessage(t)}catch{}},this.ws.onerror=s=>{this.error.set("WebSocket connection error")},this.ws.onclose=()=>{this.connected.set(!1),this.attemptReconnect()}}catch{this.error.set("Failed to connect to WebSocket")}}disconnect(){this.ws&&(this.ws.close(),this.ws=null,this.connected.set(!1))}subscribeToWidget(s,t){const e=`widget:${s}`;return this.subscriptions.has(e)||this.subscriptions.set(e,new Set),this.subscriptions.get(e).add(t),this.send({action:"subscribe",channel:`dashboard:widget:${s}`}),()=>{this.subscriptions.get(e)?.delete(t),this.subscriptions.get(e)?.size===0&&this.send({action:"unsubscribe",channel:`dashboard:widget:${s}`})}}subscribeToDashboard(s,t){const e=`dashboard:${s}`;return this.subscriptions.has(e)||this.subscriptions.set(e,new Set),this.subscriptions.get(e).add(t),this.send({action:"subscribe",channel:`dashboard:dashboard:${s}`}),()=>{this.subscriptions.get(e)?.delete(t),this.subscriptions.get(e)?.size===0&&this.send({action:"unsubscribe",channel:`dashboard:dashboard:${s}`})}}subscribeToNotifications(s,t){const e=`user:${s}:notifications`;return this.subscriptions.has(e)||this.subscriptions.set(e,new Set),this.subscriptions.get(e).add(t),this.send({action:"subscribe",channel:`private-user.${s}`}),()=>{this.subscriptions.get(e)?.delete(t),this.subscriptions.get(e)?.size===0&&this.send({action:"unsubscribe",channel:`private-user.${s}`})}}subscribeToCart(s,t,e){const c=s?`user:${s}:cart`:`session:${t}:cart`,r=s?`private-user.${s}.cart`:`private-session.${t}.cart`;return this.subscriptions.has(c)||this.subscriptions.set(c,new Set),this.subscriptions.get(c).add(e),this.send({action:"subscribe",channel:r}),()=>{this.subscriptions.get(c)?.delete(e),this.subscriptions.get(c)?.size===0&&this.send({action:"unsubscribe",channel:r})}}handleMessage(s){const{event:t,widget_id:e,dashboard_id:c,user_id:r,cart_id:$,notification:u,data:h,changes:d}=s;if(t==="widget:update"&&e){const i=`widget:${e}`;this.subscriptions.get(i)?.forEach(n=>n(h))}if(t==="dashboard:update"&&c){const i=`dashboard:${c}`;this.subscriptions.get(i)?.forEach(n=>n(d))}if(t==="widget:refresh"&&e){const i=`widget:${e}`;this.subscriptions.get(i)?.forEach(n=>n({refresh:!0}))}if(t==="notification"&&r&&u){const i=`user:${r}:notifications`;this.subscriptions.get(i)?.forEach(n=>n(u))}if(t==="cart.updated"&&h){if(r){const i=`user:${r}:cart`;this.subscriptions.get(i)?.forEach(n=>n(h))}if(h.session_id){const i=`session:${h.session_id}:cart`;this.subscriptions.get(i)?.forEach(n=>n(h))}}}send(s){this.ws?.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(s))}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){this.error.set("Max reconnection attempts reached");return}this.reconnectAttempts++;const s=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);setTimeout(()=>{this.connect()},s)}isConnected(){return this.ws?.readyState===WebSocket.OPEN}}const w=`ws://${window.location.host}/ws`,g=new f(w);g.connect();export{g as w};
