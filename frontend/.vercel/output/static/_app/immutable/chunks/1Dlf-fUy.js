var S=Object.defineProperty;var v=(i,e,t)=>e in i?S(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var r=(i,e,t)=>v(i,typeof e!="symbol"?e+"":e,t);import{ac as d,ab as g}from"./C_QN0JMx.js";import{getAuthToken as R}from"./D3S43Cfl.js";const w="http://localhost:8000/api",C="ws://localhost:8000",E=3e4,q=3,M=1e3,P=3e5,A=10,_=100,D=100,I=5,U=3e4,p=class p{constructor(){r(this,"token",null);r(this,"refreshToken",null);r(this,"wsConnection");r(this,"sseConnection");r(this,"requestQueue",[]);r(this,"activeRequests",new Map);r(this,"requestCache",new Map);r(this,"rateLimiter",new O(D));r(this,"circuitBreaker",new $);r(this,"batchQueue",new Map);r(this,"batchTimer");r(this,"metrics",{totalRequests:0,successfulRequests:0,failedRequests:0,averageResponseTime:0,cacheHitRate:0,errorRate:0,requestsPerMinute:0});r(this,"loading",d(!1));r(this,"error",d(null));r(this,"online",d(!0));r(this,"performance",d(this.metrics));r(this,"user",d(null));r(this,"memberships",d([]));r(this,"products",d([]));r(this,"isAuthenticated",g(this.user,e=>e!==null));r(this,"activeMembership",g(this.memberships,e=>e.find(t=>t.status==="active")));r(this,"hasActiveSubscription",g(this.activeMembership,e=>e!==void 0));r(this,"sseReconnectAttempts",0);r(this,"MAX_SSE_RECONNECT_ATTEMPTS",5);this.initialize()}static getInstance(){return p.instance||(p.instance=new p),p.instance}async initialize(){this.loadTokens(),this.setupNetworkMonitoring(),this.setupWebSocket(),this.setupSSE(),this.startRequestProcessor(),this.token&&await this.loadUser(),this.startPerformanceMonitoring()}loadTokens(){if(typeof window<"u"){const e=R();e?this.token=e:this.token=localStorage.getItem("rtp_auth_token"),this.refreshToken=localStorage.getItem("rtp_refresh_token")}}setToken(e,t){this.token=e,this.refreshToken=t||null,typeof window<"u"&&(e?(localStorage.setItem("rtp_auth_token",e),t&&localStorage.setItem("rtp_refresh_token",t)):(localStorage.removeItem("rtp_auth_token"),localStorage.removeItem("rtp_refresh_token"))),this.wsConnection&&this.wsConnection.readyState===WebSocket.OPEN&&this.authenticateWebSocket()}getToken(){const e=R();return e&&(this.token=e),this.token}async request(e,t={}){const s=this.generateRequestId(),n=t.cache?.key||this.getCacheKey(e,t);if(t.cache?.enabled!==!1&&t.method==="GET"){const o=this.getFromCache(n);if(o)return this.updateMetrics({cached:!0}),o}const h=this.activeRequests.get(n);if(h)return h;if(this.circuitBreaker.isOpen())throw{message:"Service temporarily unavailable",status:503,retryAfter:this.circuitBreaker.getTimeUntilReset()};await this.rateLimiter.acquire();const c=this.executeRequest(e,t,s);this.activeRequests.set(n,c);try{const o=await c;return this.activeRequests.delete(n),(t.method==="GET"||!t.method)&&this.setCache(n,o,t.cache?.ttl),t.cache?.invalidate&&this.invalidateCaches(t.cache.invalidate),o}catch(o){throw this.activeRequests.delete(n),o}}async executeRequest(e,t,s){const n=Date.now(),h=this.buildUrl(e,t.params),c={"Content-Type":"application/json",Accept:"application/json","X-Request-ID":s,...t.headers};this.token&&(c.Authorization=`Bearer ${this.token}`);const o={method:t.method||"GET",headers:c,signal:this.createAbortSignal(t.timeout)};t.body&&["POST","PUT","PATCH"].includes(o.method)&&(o.body=JSON.stringify(t.body));let f;const m=t.retry?.attempts||q;for(let u=0;u<m;u++)try{this.loading.set(!0),this.error.set(null);const l=await fetch(h,o);if(!l.ok){const y=await this.handleErrorResponse(l,s);if(this.shouldRetry(y,t.retry)){f=y,await this.delay(this.getRetryDelay(u,t.retry));continue}throw y}const T=await l.json();this.updateMetrics({responseTime:Date.now()-n,success:!0});const b=t.transform?t.transform(T):T;return this.circuitBreaker.recordSuccess(),b}catch(l){if(f=l,!navigator.onLine&&(this.online.set(!1),t.method==="GET"))return this.getOfflineData(e);this.circuitBreaker.recordFailure(),this.updateMetrics({responseTime:Date.now()-n,success:!1})}finally{this.loading.set(!1)}throw f}async handleErrorResponse(e,t){let s={};try{s=await e.json()}catch{}const n={message:s.message||this.getDefaultErrorMessage(e.status),errors:s.errors,status:e.status,code:s.code,timestamp:new Date().toISOString(),requestId:t};switch(e.status){case 401:this.refreshToken?await this.refreshAccessToken():this.handleUnauthenticated();break;case 429:n.retryAfter=parseInt(e.headers.get("Retry-After")||"60");break;case 503:n.retryAfter=30;break}return this.error.set(n),n}async get(e,t){return this.request(e,{...t,method:"GET"})}async post(e,t,s){return this.request(e,{...s,method:"POST",body:t})}async put(e,t,s){return this.request(e,{...s,method:"PUT",body:t})}async patch(e,t,s){return this.request(e,{...s,method:"PATCH",body:t})}async delete(e,t){return this.request(e,{...t,method:"DELETE"})}async register(e){const t=await this.post("/register",e);return this.setToken(t.token,t.refresh_token),this.user.set(t.user),await this.loadUserData(),t}async login(e){const t=this.getDeviceInfo(),s=await this.post("/login",{...e,device_name:e.device_name||t.name});return this.setToken(s.token,s.refresh_token),this.user.set(s.user),await this.loadUserData(),this.setupWebSocket(),s}async logout(){try{await this.post("/logout")}finally{this.setToken(null),this.user.set(null),this.memberships.set([]),this.products.set([]),this.clearCache(),this.wsConnection?.close(),this.sseConnection?.close()}}async refreshAccessToken(){if(!this.refreshToken)throw new Error("No refresh token available");try{const e=await this.post("/auth/refresh",{refresh_token:this.refreshToken});this.setToken(e.token,e.refresh_token)}catch(e){throw this.handleUnauthenticated(),e}}async getMe(){const e=await this.get("/me",{cache:{ttl:6e4}});return this.user.set(e),e}async updateProfile(e){const t=await this.patch("/me",e,{cache:{invalidate:["/me"]}});return this.user.set(t),t}async getMyMemberships(){const e=await this.get("/me/memberships",{cache:{ttl:3e5}});return this.memberships.set(e),e}async getMyProducts(){const e=await this.get("/me/products",{cache:{ttl:3e5}});return this.products.set(e),e}async getIndicators(e){return this.get("/indicators",{params:e,cache:{ttl:6e5}})}async getIndicator(e){return this.get(`/indicators/${e}`,{cache:{ttl:6e5}})}async purchaseProduct(e,t){return this.post("/products/purchase",{product_id:e,payment_method:t},{cache:{invalidate:["/me/products","/me/memberships"]}})}async getPosts(e){return this.get("/posts",{params:e,cache:{ttl:3e5}})}async getPost(e){return this.get(`/posts/${e}`,{cache:{ttl:6e5}})}async createPost(e){return this.post("/posts",e,{cache:{invalidate:["/posts"]}})}async updatePost(e,t){return this.patch(`/posts/${e}`,t,{cache:{invalidate:["/posts",`/posts/${e}`]}})}async uploadFile(e,t){const s=new FormData;s.append("file",e),s.append("type",t);const n=await fetch(`${w}/upload`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`},body:s});if(!n.ok)throw new Error("Upload failed");return n.json()}async batch(e){return this.post("/batch",{operations:e})}async download(e,t){const s=await fetch(`${w}${e}`,{headers:{Authorization:`Bearer ${this.token}`}});if(!s.ok)throw new Error("Download failed");const n=s.body?.getReader(),h=+(s.headers.get("Content-Length")??"0");if(!n)return s.blob();let c=0;const o=[];for(;;){const{done:u,value:l}=await n.read();if(u)break;o.push(l),c+=l.length,t&&h&&t(c/h*100)}const f=new Uint8Array(c);let m=0;for(const u of o)f.set(u,m),m+=u.length;return new Blob([f])}setupWebSocket(){if(!(!this.token||this.wsConnection))try{this.wsConnection=new WebSocket(`${C}/ws`),this.wsConnection.onopen=()=>{this.authenticateWebSocket()},this.wsConnection.onmessage=e=>{this.handleWebSocketMessage(e)},this.wsConnection.onerror=e=>{},this.wsConnection.onclose=()=>{this.wsConnection=void 0,this.token&&setTimeout(()=>this.setupWebSocket(),5e3)}}catch{}}authenticateWebSocket(){this.wsConnection&&this.token&&this.wsConnection.send(JSON.stringify({type:"auth",token:this.token}))}handleWebSocketMessage(e){try{const t=JSON.parse(e.data);switch(t.type){case"user_update":this.user.set(t.data);break;case"membership_update":this.handleMembershipUpdate(t.data);break;case"product_update":this.handleProductUpdate(t.data);break;case"notification":this.handleNotification(t.data);break;case"cache_invalidate":this.invalidateCaches(t.data);break}}catch{}}handleMembershipUpdate(e){this.memberships.update(t=>{const s=t.findIndex(n=>n.id===e.id);return s>=0?t[s]=e:t.push(e),t})}handleProductUpdate(e){this.products.update(t=>{const s=t.findIndex(n=>n.id===e.id);return s>=0?t[s]=e:t.push(e),t})}handleNotification(e){typeof window<"u"&&window.dispatchEvent(new CustomEvent("api:notification",{detail:e}))}setupSSE(){if(this.token)try{this.sseConnection=new EventSource(`${w}/sse`,{withCredentials:!0}),this.sseConnection.onmessage=e=>{this.handleSSEMessage(e)},this.sseConnection.onerror=e=>{this.sseConnection?.close(),this.sseConnection=void 0,this.scheduleSSEReconnect()},this.sseConnection.onopen=()=>{this.sseReconnectAttempts=0}}catch{}}scheduleSSEReconnect(){if(this.sseReconnectAttempts>=this.MAX_SSE_RECONNECT_ATTEMPTS)return;const t=1e3*Math.pow(2,this.sseReconnectAttempts)+Math.random()*1e3;this.sseReconnectAttempts++,setTimeout(()=>{this.token&&this.setupSSE()},t)}handleSSEMessage(e){try{const t=JSON.parse(e.data)}catch{}}buildUrl(e,t){const s=`${w}${e}`;if(!t||Object.keys(t).length===0)return s;const n=new URLSearchParams(Object.entries(t).filter(([h,c])=>c!=null)).toString();return`${s}?${n}`}getCacheKey(e,t){const s=t.params?JSON.stringify(t.params):"";return`${t.method||"GET"}_${e}_${s}`}getFromCache(e){const t=this.requestCache.get(e);return t&&Date.now()<t.expiry?t.data:null}setCache(e,t,s=P){this.requestCache.set(e,{data:t,expiry:Date.now()+s})}invalidateCaches(e){e.forEach(t=>{const s=new RegExp(t);for(const[n]of this.requestCache)s.test(n)&&this.requestCache.delete(n)})}clearCache(){this.requestCache.clear()}createAbortSignal(e=E){const t=new AbortController;return setTimeout(()=>t.abort(),e),t.signal}shouldRetry(e,t){return e.status>=400&&e.status<500&&e.status!==429?!1:t?.condition?t.condition(e):e.status===0||e.status>=500}getRetryDelay(e,t){const s=t?.delay||M;return t?.backoff==="exponential"?s*Math.pow(2,e):s}delay(e){return new Promise(t=>setTimeout(t,e))}generateRequestId(){return`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getDefaultErrorMessage(e){return{400:"Bad request",401:"Unauthorized",403:"Forbidden",404:"Not found",429:"Too many requests",500:"Internal server error",502:"Bad gateway",503:"Service unavailable"}[e]||"An error occurred"}getDeviceInfo(){if(typeof window>"u")return{name:"Server",type:"server"};const e=navigator.userAgent;let t="Unknown Device",s="desktop";return/iPhone|iPad|iPod/.test(e)?(t="iOS Device",s="mobile"):/Android/.test(e)?(t="Android Device",s="mobile"):/Windows/.test(e)?t="Windows PC":/Mac/.test(e)?t="Mac":/Linux/.test(e)&&(t="Linux PC"),{name:t,type:s}}handleUnauthenticated(){this.setToken(null),this.user.set(null),this.memberships.set([]),this.products.set([]),typeof window<"u"&&window.dispatchEvent(new CustomEvent("auth:required"))}async loadUser(){try{await this.getMe()}catch{}}async loadUserData(){try{await Promise.all([this.getMyMemberships(),this.getMyProducts()])}catch{}}async getOfflineData(e){throw new Error("Offline data not available")}setupNetworkMonitoring(){typeof window>"u"||(window.addEventListener("online",()=>{this.online.set(!0),this.processQueuedRequests()}),window.addEventListener("offline",()=>{this.online.set(!1)}))}async processQueuedRequests(){for(;this.requestQueue.length>0;){const e=this.requestQueue.shift();if(e)try{const t=await this.request(e.endpoint,e.config);e.resolve(t)}catch(t){e.reject(t)}}}startRequestProcessor(){setInterval(()=>{this.processBatchRequests()},_)}async processBatchRequests(){if(this.batchQueue.size===0)return;const e=Array.from(this.batchQueue.entries());this.batchQueue.clear();for(const[t,s]of e)s.length>=A&&await this.batch(s)}updateMetrics(e){if(e.responseTime!==void 0){const t=this.metrics.totalRequests+1;this.metrics.averageResponseTime=(this.metrics.averageResponseTime*this.metrics.totalRequests+e.responseTime)/t,this.metrics.totalRequests=t}if(e.success!==void 0&&(e.success?this.metrics.successfulRequests++:this.metrics.failedRequests++,this.metrics.errorRate=this.metrics.failedRequests/this.metrics.totalRequests),e.cached){const t=this.metrics.cacheHitRate*this.metrics.totalRequests;this.metrics.cacheHitRate=(t+1)/(this.metrics.totalRequests+1)}this.performance.set(this.metrics)}startPerformanceMonitoring(){setInterval(()=>{const e=Date.now(),t=this.requestQueue.filter(s=>e-s.timestamp<6e4).length;this.metrics.requestsPerMinute=t,this.performance.set(this.metrics)},1e4)}};r(p,"instance");let k=p;class O{constructor(e){r(this,"tokens");r(this,"lastRefill");r(this,"maxTokens");r(this,"refillRate");this.maxTokens=e,this.tokens=e,this.lastRefill=Date.now(),this.refillRate=6e4/e}async acquire(){if(this.refill(),this.tokens<=0){const e=this.refillRate-(Date.now()-this.lastRefill);return await new Promise(t=>setTimeout(t,e)),this.acquire()}this.tokens--}refill(){const e=Date.now(),t=e-this.lastRefill,s=Math.floor(t/this.refillRate);s>0&&(this.tokens=Math.min(this.tokens+s,this.maxTokens),this.lastRefill=e)}}class ${constructor(){r(this,"failures",0);r(this,"lastFailureTime");r(this,"state","closed");r(this,"threshold",I);r(this,"timeout",U)}isOpen(){return this.checkState(),this.state==="open"}recordSuccess(){this.state==="half-open"&&this.reset()}recordFailure(){this.failures++,this.lastFailureTime=Date.now(),this.failures>=this.threshold&&(this.state="open")}getTimeUntilReset(){return this.lastFailureTime?Math.max(0,this.timeout-(Date.now()-this.lastFailureTime)):0}checkState(){this.state==="open"&&this.lastFailureTime&&Date.now()-this.lastFailureTime>=this.timeout&&(this.state="half-open")}reset(){this.failures=0,this.lastFailureTime=void 0,this.state="closed"}}const a=k.getInstance();a.loading;a.error;a.online;a.performance;a.user;a.memberships;a.products;a.isAuthenticated;a.activeMembership;a.hasActiveSubscription;const F={get:(i,e)=>a.get(i,e),post:(i,e,t)=>a.post(i,e,t),put:(i,e,t)=>a.put(i,e,t),patch:(i,e,t)=>a.patch(i,e,t),delete:(i,e)=>a.delete(i,e),register:i=>a.register(i),login:i=>a.login(i),logout:()=>a.logout(),refreshToken:()=>a.refreshAccessToken(),getMe:()=>a.getMe(),updateProfile:i=>a.updateProfile(i),getMyMemberships:()=>a.getMyMemberships(),getMyProducts:()=>a.getMyProducts(),getIndicators:i=>a.getIndicators(i),getIndicator:i=>a.getIndicator(i),purchaseProduct:(i,e)=>a.purchaseProduct(i,e),getPosts:i=>a.getPosts(i),getPost:i=>a.getPost(i),createPost:i=>a.createPost(i),updatePost:(i,e)=>a.updatePost(i,e),uploadFile:(i,e)=>a.uploadFile(i,e),download:(i,e)=>a.download(i,e),batch:i=>a.batch(i),setToken:(i,e)=>a.setToken(i,e),getToken:()=>a.getToken()};export{a,F as b};
