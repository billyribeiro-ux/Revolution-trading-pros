import{ab as c,ac as m,ad as p,F as P}from"./C_QN0JMx.js";import"./ByEkyPua.js";const M=Object.freeze(["welberribeirodrums@gmail.com"]),S=Object.freeze({SUPERADMIN:"super-admin",ADMIN:"admin",MEMBER:"member",USER:"user"}),A=Object.freeze([S.USER,S.MEMBER,S.ADMIN,S.SUPERADMIN]),s=Object.freeze({DASHBOARD_VIEW:"dashboard.view",DASHBOARD_ANALYTICS:"dashboard.analytics",USERS_VIEW:"users.view",USERS_CREATE:"users.create",USERS_EDIT:"users.edit",USERS_DELETE:"users.delete",USERS_IMPERSONATE:"users.impersonate",POSTS_VIEW:"posts.view",POSTS_CREATE:"posts.create",POSTS_EDIT:"posts.edit",POSTS_DELETE:"posts.delete",POSTS_PUBLISH:"posts.publish",PRODUCTS_VIEW:"products.view",PRODUCTS_CREATE:"products.create",PRODUCTS_EDIT:"products.edit",PRODUCTS_DELETE:"products.delete",ORDERS_VIEW:"orders.view",ORDERS_MANAGE:"orders.manage",ORDERS_REFUND:"orders.refund",COUPONS_VIEW:"coupons.view",COUPONS_CREATE:"coupons.create",COUPONS_EDIT:"coupons.edit",COUPONS_DELETE:"coupons.delete",POPUPS_VIEW:"popups.view",POPUPS_CREATE:"popups.create",POPUPS_EDIT:"popups.edit",POPUPS_DELETE:"popups.delete",FORMS_VIEW:"forms.view",FORMS_CREATE:"forms.create",FORMS_EDIT:"forms.edit",FORMS_DELETE:"forms.delete",FORMS_SUBMISSIONS:"forms.submissions",SETTINGS_VIEW:"settings.view",SETTINGS_EDIT:"settings.edit",SETTINGS_SYSTEM:"settings.system",MEMBERSHIPS_VIEW:"memberships.view",MEMBERSHIPS_MANAGE:"memberships.manage",TRADING_ROOMS_ACCESS:"trading_rooms.access",TRADING_ROOMS_MODERATE:"trading_rooms.moderate",TRADING_ROOMS_ADMIN:"trading_rooms.admin",MEDIA_VIEW:"media.view",MEDIA_UPLOAD:"media.upload",MEDIA_DELETE:"media.delete",SYSTEM_LOGS:"system.logs",SYSTEM_CACHE:"system.cache",SYSTEM_MAINTENANCE:"system.maintenance"}),O=Object.freeze({[S.SUPERADMIN]:Object.values(s),[S.ADMIN]:[s.DASHBOARD_VIEW,s.DASHBOARD_ANALYTICS,s.USERS_VIEW,s.USERS_CREATE,s.USERS_EDIT,s.POSTS_VIEW,s.POSTS_CREATE,s.POSTS_EDIT,s.POSTS_DELETE,s.POSTS_PUBLISH,s.PRODUCTS_VIEW,s.PRODUCTS_CREATE,s.PRODUCTS_EDIT,s.ORDERS_VIEW,s.ORDERS_MANAGE,s.COUPONS_VIEW,s.COUPONS_CREATE,s.COUPONS_EDIT,s.POPUPS_VIEW,s.POPUPS_CREATE,s.POPUPS_EDIT,s.FORMS_VIEW,s.FORMS_CREATE,s.FORMS_EDIT,s.FORMS_SUBMISSIONS,s.SETTINGS_VIEW,s.MEMBERSHIPS_VIEW,s.MEMBERSHIPS_MANAGE,s.TRADING_ROOMS_ACCESS,s.TRADING_ROOMS_MODERATE,s.MEDIA_VIEW,s.MEDIA_UPLOAD],[S.MEMBER]:[s.DASHBOARD_VIEW,s.TRADING_ROOMS_ACCESS,s.MEDIA_VIEW],[S.USER]:[s.DASHBOARD_VIEW]});function D(e){return e?M.includes(e.toLowerCase()):!1}function R(e){return e?!!(D(e.email)||e.roles?.some(n=>n.toLowerCase()===S.SUPERADMIN||n.toLowerCase()==="super_admin"||n.toLowerCase()==="superadmin")):!1}function g(e){return e?!!(R(e)||e.is_admin||e.roles?.some(n=>["admin","administrator","super-admin","super_admin","superadmin"].includes(n.toLowerCase()))):!1}function k(e,n){if(!e)return!1;if(R(e)||e.permissions?.includes(n))return!0;if(e.roles)for(const o of e.roles){const r=o.toLowerCase();if(O[r]?.includes(n))return!0}return!1}function U(e){if(!e)return[];if(R(e))return Object.values(s);const n=new Set;if(e.permissions&&e.permissions.forEach(o=>n.add(o)),e.roles)for(const o of e.roles){const r=o.toLowerCase(),t=O[r];t&&t.forEach(i=>n.add(i))}return Array.from(n)}function h(e){if(!e)return S.USER;if(D(e.email))return S.SUPERADMIN;if(!e.roles||e.roles.length===0)return S.USER;let n=0;for(const o of e.roles){const r=o.toLowerCase().replace("_","-"),t=A.indexOf(r);t>n&&(n=t)}return A[n]??S.USER}const C=()=>{let e=null;return{setAccessToken:n=>{e=n},getAccessToken:()=>e,clearTokens:()=>{e=null}}},d=C(),I="rtp_session_id",_="rtp_token_expiry";function a(e,n,o){try{switch(e){case"get":return localStorage.getItem(n);case"set":return o!=null&&localStorage.setItem(n,String(o)),null;case"remove":return localStorage.removeItem(n),null}}catch{return null}}function N(){const e=a("get",I),n=a("get",_),o=n?parseInt(n,10):null;return{user:null,sessionId:e,tokenExpiry:o,isAuthenticated:!1,isInitializing:!!e,isLoading:!1,sessionInvalidated:!1,invalidationReason:null}}function w(){const{subscribe:e,set:n,update:o}=m(N());let r=null;return{subscribe:e,setAuth:(t,i,E,u)=>{d.setAccessToken(i);let f=null;u&&(f=Date.now()+u*1e3,a("set",_,f.toString())),E&&a("set",I,E),o(T=>({...T,user:t,sessionId:E??T.sessionId,tokenExpiry:f,isAuthenticated:!0,isInitializing:!1,isLoading:!1,sessionInvalidated:!1,invalidationReason:null}))},updateToken:(t,i)=>{d.setAccessToken(t);let E=null;i&&(E=Date.now()+i*1e3,a("set",_,E.toString())),o(u=>({...u,tokenExpiry:E}))},setUser:t=>{o(i=>({...i,user:t,isAuthenticated:!0,isInitializing:!1}))},setSessionInvalidated:t=>{o(i=>({...i,sessionInvalidated:!0,invalidationReason:t||"Your session was ended because you signed in from another device."}))},clearSessionInvalidated:()=>{o(t=>({...t,sessionInvalidated:!1,invalidationReason:null}))},clearAuth:()=>{d.clearTokens(),a("remove",I),a("remove",_),n({user:null,sessionId:null,tokenExpiry:null,isAuthenticated:!1,isInitializing:!1,isLoading:!1,sessionInvalidated:!1,invalidationReason:null})},setLoading:t=>{o(i=>({...i,isLoading:t}))},completeInitialization:t=>{o(i=>({...i,isInitializing:!1,isAuthenticated:t}))},getToken:()=>d.getAccessToken(),getSessionId:()=>a("get",I),isTokenExpired:()=>{const t=a("get",_);if(!t)return!0;const i=parseInt(t,10);return Date.now()>=i-3e4},refreshToken:async()=>{if(r)return await r,!!d.getAccessToken();r=(async()=>{try{const t=await fetch("/api/auth/refresh",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json","X-Session-ID":a("get",I)||""}});if(!t.ok)throw new Error("Token refresh failed");const i=await t.json();if(i.token&&(d.setAccessToken(i.token),i.expires_in)){const E=Date.now()+i.expires_in*1e3;a("set",_,E.toString()),o(u=>({...u,tokenExpiry:E}))}}catch(t){throw t}finally{r=null}})();try{return await r,!0}catch{return!1}},logout:async(t="/login")=>{const i=d.getAccessToken(),E=a("get",I);if(d.clearTokens(),a("remove",I),a("remove",_),n({user:null,sessionId:null,tokenExpiry:null,isAuthenticated:!1,isInitializing:!1,isLoading:!1,sessionInvalidated:!1,invalidationReason:null}),i&&p)try{const u={Authorization:`Bearer ${i}`,"Content-Type":"application/json"};E&&(u["X-Session-ID"]=E),await fetch("/api/logout",{method:"POST",headers:u,credentials:"include"})}catch{}t&&await P(t,{replaceState:!0})}}}const l=w(),y=c(l,e=>e.user),V=c(l,e=>e.isAuthenticated);c(l,e=>e.isLoading);c(l,e=>e.isInitializing);c(l,e=>e.sessionId);const W=c(l,e=>e.sessionInvalidated);c(l,e=>e.invalidationReason);c(l,e=>R(e.user));const b=c(l,e=>g(e.user));c(l,e=>h(e.user));c(l,e=>U(e.user));const B=()=>l.getToken();export{s as PERMISSIONS,S as ROLES,M as SUPERADMIN_EMAILS,l as authStore,g as checkIsAdmin,B as getAuthToken,k as hasPermission,b as isAdminUser,V as isAuthenticated,R as isSuperadmin,W as sessionInvalidated,y as user};
