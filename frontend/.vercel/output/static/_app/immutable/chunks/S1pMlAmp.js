var C=Object.defineProperty;var R=(a,e,s)=>e in a?C(a,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[e]=s;var c=(a,e,s)=>R(a,typeof e!="symbol"?e+"":e,s);import{ac as p,ab as m,d1 as b}from"./C_QN0JMx.js";import{b as i}from"./1Dlf-fUy.js";const A="ws://localhost:8000",S="http://localhost:8001/api",v=3e5,x=2e3,I=36e5,B=3e5,g=class g{constructor(){c(this,"cache",new Map);c(this,"wsConnection");c(this,"analysisDebounceTimers",new Map);c(this,"rankCheckInterval");c(this,"alertCheckInterval");c(this,"pendingAnalyses",new Map);c(this,"analyses",p([]));c(this,"currentAnalysis",p(null));c(this,"redirects",p([]));c(this,"errors404",p([]));c(this,"rankings",p([]));c(this,"backlinks",p(null));c(this,"competitors",p([]));c(this,"alerts",p([]));c(this,"isLoading",p(!1));c(this,"error",p(null));c(this,"criticalIssues",m(this.currentAnalysis,e=>e?.technical_issues?.filter(s=>s.severity==="critical")||[]));c(this,"topOpportunities",m(this.currentAnalysis,e=>e?.keyword_opportunities?.sort((s,t)=>t.opportunity_score-s.opportunity_score).slice(0,10)||[]));c(this,"overallScore",m(this.currentAnalysis,e=>e?.overall_score||0));this.initialize()}static getInstance(){return g.instance||(g.instance=new g),g.instance}initialize(){this.setupWebSocket(),this.startRankTracking(),this.startAlertMonitoring(),this.loadInitialData()}setupWebSocket(){try{this.wsConnection=new WebSocket(`${A}/seo`),this.wsConnection.onopen=()=>{this.subscribeToUpdates()},this.wsConnection.onmessage=e=>{this.handleWebSocketMessage(e)},this.wsConnection.onerror=e=>{},this.wsConnection.onclose=()=>{setTimeout(()=>this.setupWebSocket(),5e3)}}catch{}}subscribeToUpdates(){this.wsConnection?.send(JSON.stringify({type:"subscribe",channels:["rankings","crawl","alerts","competitors"]}))}handleWebSocketMessage(e){try{const s=JSON.parse(e.data);switch(s.type){case"ranking_update":this.handleRankingUpdate(s.data);break;case"crawl_complete":this.handleCrawlComplete(s.data);break;case"new_404":this.handleNew404(s.data);break;case"competitor_update":this.handleCompetitorUpdate(s.data);break;case"seo_alert":this.handleSeoAlert(s.data);break}}catch{}}handleRankingUpdate(e){this.rankings.update(s=>{const t=s.findIndex(r=>r.keyword===e.keyword);return t>=0?s[t]=e:s.push(e),s}),Math.abs(e.change)>=5&&this.showNotification(`Ranking ${e.change>0?"improved":"dropped"} for "${e.keyword}": ${e.change>0?"+":""}${e.change}`,e.change>0?"success":"warning")}handleCrawlComplete(e){this.loadTechnicalIssues()}handleNew404(e){this.errors404.update(s=>[...s,e]),this.showNotification(`New 404 error detected: ${e.url}`,"warning")}handleCompetitorUpdate(e){this.competitors.update(s=>{const t=s.findIndex(r=>r.domain===e.domain);return t>=0?s[t]=e:s.push(e),s})}handleSeoAlert(e){this.alerts.update(s=>[e,...s]),this.showNotification(e.message,e.severity)}async loadInitialData(){try{await Promise.all([this.loadRedirects(),this.load404Errors(),this.loadRankings(),this.loadBacklinks()])}catch{}}startRankTracking(){this.checkRankings(),this.rankCheckInterval=window.setInterval(()=>{this.checkRankings()},I)}async checkRankings(){try{const e=await i.get("/seo/rankings/check");this.rankings.set(e.rankings)}catch{}}startAlertMonitoring(){this.alertCheckInterval=window.setInterval(()=>{this.checkAlerts()},B)}async checkAlerts(){try{(await i.get("/seo/alerts/check")).alerts.forEach(s=>{s.is_new&&this.handleSeoAlert(s)})}catch{}}async analyze(e,s,t,r={}){this.isLoading.set(!0),this.error.set(null);const o=`${e}_${s}`;return this.analysisDebounceTimers.has(o)&&clearTimeout(this.analysisDebounceTimers.get(o)),new Promise((u,y)=>{const k=window.setTimeout(async()=>{try{if(this.pendingAnalyses.has(o)){const h=await this.pendingAnalyses.get(o);u(h);return}const l=this.performAnalysis(e,s,t,r);this.pendingAnalyses.set(o,l);const d=await l;this.currentAnalysis.set(d),this.analyses.update(h=>{const w=h.findIndex(_=>_.analyzable_type===e&&_.analyzable_id===s);return w>=0?h[w]=d:h.push(d),h}),u(d)}catch(l){this.error.set(l.message),y(l)}finally{this.pendingAnalyses.delete(o),this.isLoading.set(!1)}},r.immediate?0:x);this.analysisDebounceTimers.set(o,k)})}async performAnalysis(e,s,t,r={}){const[o,u,y,k,l,d]=await Promise.all([this.getBasicAnalysis(e,s,t),r.includeCompetitors?this.analyzeCompetitors(t):null,r.includeKeywords?this.findKeywordOpportunities(t):null,r.includeContentGaps?this.analyzeContentGaps(t):null,r.includeTechnical?this.performTechnicalAudit(e,s):null,r.includePerformance?this.getPerformanceMetrics(e,s):null]),h=this.calculateOverallScore({basicAnalysis:o,technicalAudit:l,performanceMetrics:d}),w=await this.generateAISuggestions({basicAnalysis:o,competitorAnalysis:u,keywordOpportunities:y,contentGaps:k});return{...o,overall_score:h,technical_score:l?100-l.issues.length*5:100,content_score:o.seo_score,user_experience_score:d?.pageSpeed.score||100,competitor_comparison:u,keyword_opportunities:y,content_gaps:k,technical_issues:l?.issues,page_speed:d?.pageSpeed,core_web_vitals:d?.coreWebVitals,suggestions:[...o.suggestions,...w]}}async getBasicAnalysis(e,s,t){return(await i.post("/seo/analyze",{content_type:e,content_id:s,focus_keyword:t})).analysis}async analyzeCompetitors(e){return e?(await i.post("/seo/competitors/analyze",{keyword:e})).analysis:null}async findKeywordOpportunities(e){return(await i.post("/seo/keywords/opportunities",{seed_keyword:e})).opportunities}async analyzeContentGaps(e){return e?(await i.post("/seo/content/gaps",{keyword:e})).gaps:null}async performTechnicalAudit(e,s){return{issues:(await i.post("/seo/technical/audit",{content_type:e,content_id:s})).issues}}async getPerformanceMetrics(e,s){return await i.post("/seo/performance/analyze",{content_type:e,content_id:s})}calculateOverallScore(e){const s={technical:.3,content:.3,performance:.2};let t=0;if(e.basicAnalysis&&(t+=e.basicAnalysis.seo_score*s.content),e.technicalAudit){const r=100-e.technicalAudit.issues.length*5;t+=Math.max(0,r)*s.technical}return e.performanceMetrics&&(t+=e.performanceMetrics.pageSpeed.score*s.performance),Math.round(t)}async generateAISuggestions(e){try{return(await i.post(`${S}/seo/suggestions`,e)).suggestions}catch{return[]}}async getAnalysis(e,s){const t=`analysis_${e}_${s}`,r=this.getFromCache(t);if(r)return r;const o=await i.get(`/seo/analyze/${e}/${s}`);return this.setCache(t,o.analysis),o.analysis}async getRecommendations(e,s){return(await i.get(`/seo/analyze/${e}/${s}/recommendations`)).recommendations}async autoFix(e,s,t){const r=await i.post("/seo/auto-fix",{content_type:e,content_id:s,issues:t});return await this.analyze(e,s,void 0,{immediate:!0}),r}async loadRedirects(e){const s=await i.get("/redirects",{params:e});return this.redirects.set(s.data),s.data}async createRedirect(e){const s=await i.post("/redirects",e);return this.redirects.update(t=>[...t,s.redirect]),this.trackEvent("redirect_created",{from:e.from_path,to:e.to_path}),s.redirect}async updateRedirect(e,s){const t=await i.put(`/redirects/${e}`,s);return this.redirects.update(r=>{const o=r.findIndex(u=>u.id===e);return o>=0&&(r[o]=t.redirect),r}),t.redirect}async deleteRedirect(e){await i.delete(`/redirects/${e}`),this.redirects.update(s=>s.filter(t=>t.id!==e))}async detectRedirectChains(){return(await i.get("/redirects/chains")).chains}async importRedirects(e){const s=new FormData;s.append("file",e);const t=await i.post("/redirects/import",s,{headers:{"Content-Type":"multipart/form-data"}});return await this.loadRedirects(),t}async exportRedirects(){return await i.get("/redirects/export")}async load404Errors(e){const s=await i.get("/404-errors",{params:e});return this.errors404.set(s.data),s.data}async resolve404(e,s){s&&await this.createRedirect({from_path:(await this.get404(e)).url,to_path:s,status_code:301,type:"automatic"}),await i.put(`/404-errors/${e}/resolve`),this.errors404.update(t=>t.map(r=>r.id===e?{...r,is_resolved:!0}:r))}async get404(e){const t=b(this.errors404).find(o=>o.id===e);return t||(await i.get(`/404-errors/${e}`)).error}async bulkDelete404s(e,s){const t=await i.post("/404-errors/bulk-delete",{resolved_only:e,older_than_days:s});return await this.load404Errors(),t}async findSimilarPages(e){return(await i.post("/404-errors/find-similar",{url:e})).suggestions}async loadRankings(e){const s=await i.get("/seo/rankings",{params:{keywords:e}});return this.rankings.set(s.rankings),s.rankings}async trackKeyword(e,s,t){const r=await i.post("/seo/rankings/track",{keyword:e,url:s,...t});return this.rankings.update(o=>[...o,r.tracking]),r.tracking}async updateRankings(){const e=await i.post("/seo/rankings/update");return this.rankings.set(e.rankings),e.rankings}async getRankingHistory(e,s=30){return(await i.get(`/seo/rankings/${encodeURIComponent(e)}/history`,{params:{days:s}})).history}async loadBacklinks(){const e=await i.get("/seo/backlinks");return this.backlinks.set(e.profile),e.profile}async checkNewBacklinks(){return(await i.get("/seo/backlinks/new")).backlinks}async analyzeToxicBacklinks(){return(await i.get("/seo/backlinks/toxic")).toxic}async disavowBacklinks(e){await i.post("/seo/backlinks/disavow",{domains:e})}async getSettings(){return await i.get("/seo-settings")}async updateSetting(e,s){await i.put(`/seo-settings/${e}`,{value:s})}async getSitemapConfigs(){return(await i.get("/seo-settings/sitemap-configs")).configs}async updateSitemapConfig(e){await i.put(`/seo-settings/sitemap-configs/${e.id}`,e)}async generateSitemap(){return(await i.post("/seo/sitemap/generate")).url}async getLocalBusiness(){return await i.get("/seo-settings/local-business")}async updateLocalBusiness(e){await i.post("/seo-settings/local-business",e)}async generateSchema(e,s){return(await i.post("/seo/schema/generate",{type:e,data:s})).schema}getFromCache(e){const s=this.cache.get(e);return s&&Date.now()<s.expiry?s.data:null}setCache(e,s,t=v){this.cache.set(e,{data:s,expiry:Date.now()+t})}clearCache(e){if(e)for(const s of this.cache.keys())s.includes(e)&&this.cache.delete(s);else this.cache.clear()}async loadTechnicalIssues(){try{const e=await i.get("/seo/technical/issues");this.currentAnalysis.update(s=>(s&&(s.technical_issues=e.issues),s))}catch{}}showNotification(e,s="info"){}trackEvent(e,s){"gtag"in window&&window.gtag("event",e,s)}destroy(){this.rankCheckInterval&&clearInterval(this.rankCheckInterval),this.alertCheckInterval&&clearInterval(this.alertCheckInterval),this.wsConnection?.close(),this.analysisDebounceTimers.forEach(e=>clearTimeout(e)),this.analysisDebounceTimers.clear()}};c(g,"instance");let f=g;const n=f.getInstance();n.analyses;n.currentAnalysis;n.redirects;n.errors404;n.rankings;n.backlinks;n.competitors;n.alerts;n.criticalIssues;n.topOpportunities;n.overallScore;n.isLoading;n.error;const E={analyze:(a,e,s,t)=>n.analyze(a,e,s,t),getAnalysis:(a,e)=>n.getAnalysis(a,e),getRecommendations:(a,e)=>n.getRecommendations(a,e),autoFix:(a,e,s)=>n.autoFix(a,e,s),listRedirects:a=>n.loadRedirects(a),createRedirect:a=>n.createRedirect(a),updateRedirect:(a,e)=>n.updateRedirect(a,e),deleteRedirect:a=>n.deleteRedirect(a),detectRedirectChains:()=>n.detectRedirectChains(),importRedirects:a=>n.importRedirects(a),exportRedirects:()=>n.exportRedirects(),getRedirectStats:()=>i.get("/redirects/statistics"),list404s:a=>n.load404Errors(a),resolve404:(a,e)=>n.resolve404(a,e),bulkDelete404s:(a,e)=>n.bulkDelete404s(a,e),findSimilarPages:a=>n.findSimilarPages(a),get404Stats:()=>i.get("/404-errors/statistics"),loadRankings:a=>n.loadRankings(a),trackKeyword:(a,e,s)=>n.trackKeyword(a,e,s),updateRankings:()=>n.updateRankings(),getRankingHistory:(a,e)=>n.getRankingHistory(a,e),loadBacklinks:()=>n.loadBacklinks(),checkNewBacklinks:()=>n.checkNewBacklinks(),analyzeToxicBacklinks:()=>n.analyzeToxicBacklinks(),disavowBacklinks:a=>n.disavowBacklinks(a),getSettings:()=>n.getSettings(),updateSetting:(a,e)=>n.updateSetting(a,e),getSitemapConfigs:()=>n.getSitemapConfigs(),updateSitemapConfig:a=>n.updateSitemapConfig(a),generateSitemap:()=>n.generateSitemap(),getLocalBusiness:()=>n.getLocalBusiness(),updateLocalBusiness:a=>n.updateLocalBusiness(a),generateSchema:(a,e)=>n.generateSchema(a,e)};export{E as s};
