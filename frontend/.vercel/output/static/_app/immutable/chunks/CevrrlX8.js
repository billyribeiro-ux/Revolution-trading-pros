var d=Object.defineProperty;var u=(c,t,e)=>t in c?d(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var l=(c,t,e)=>u(c,typeof t!="symbol"?t+"":t,e);const n="api_cache_";class m{constructor(){l(this,"cache",new Map);l(this,"pendingRequests",new Map);l(this,"accessOrder",[])}async getOrFetch(t,e,s={}){const{ttl:a=3e5,staleTime:o=6e4,persist:r=!1}=s,h=this.get(t);if(h!==null){const i=this.cache.get(t),g=Date.now()-i.timestamp;if(g<o)return h;if(g<a)return this.revalidateInBackground(t,e,{ttl:a,persist:r}),h}if(r){const i=this.getFromStorage(t);if(i!==null)return this.set(t,i,{ttl:a,persist:!1}),this.revalidateInBackground(t,e,{ttl:a,persist:r}),i}return this.fetchWithDedup(t,e,{ttl:a,persist:r})}get(t){const e=this.cache.get(t);return e?Date.now()-e.timestamp>e.ttl?(this.delete(t),null):(this.updateAccessOrder(t),e.data):null}set(t,e,s={}){const{ttl:a=3e5,persist:o=!1,etag:r}=s;for(;this.cache.size>=100;){const i=this.accessOrder.shift();i&&this.cache.delete(i)}const h={data:e,timestamp:Date.now(),ttl:a,etag:r};this.cache.set(t,h),this.updateAccessOrder(t),o&&this.setInStorage(t,h)}delete(t){this.cache.delete(t),this.accessOrder=this.accessOrder.filter(e=>e!==t);try{localStorage.removeItem(n+t)}catch{}}clear(){this.cache.clear(),this.accessOrder=[],this.pendingRequests.clear();try{Object.keys(localStorage).filter(t=>t.startsWith(n)).forEach(t=>localStorage.removeItem(t))}catch{}}invalidate(t){const e=typeof t=="string"?new RegExp(t):t;for(const s of this.cache.keys())e.test(s)&&this.delete(s)}has(t){return this.get(t)!==null}getStats(){return{size:this.cache.size,keys:[...this.cache.keys()]}}async fetchWithDedup(t,e,s){const a=this.pendingRequests.get(t);if(a&&Date.now()-a.timestamp<3e4)return a.promise;const o=e().then(r=>(this.set(t,r,s),this.pendingRequests.delete(t),r)).catch(r=>{throw this.pendingRequests.delete(t),r});return this.pendingRequests.set(t,{promise:o,timestamp:Date.now()}),o}revalidateInBackground(t,e,s){this.fetchWithDedup(t,e,s).catch(()=>{})}updateAccessOrder(t){this.accessOrder=this.accessOrder.filter(e=>e!==t),this.accessOrder.push(t)}getFromStorage(t){try{const e=localStorage.getItem(n+t);if(!e)return null;const s=JSON.parse(e);return Date.now()-s.timestamp>s.ttl?(localStorage.removeItem(n+t),null):s.data}catch{return null}}setInStorage(t,e){try{localStorage.setItem(n+t,JSON.stringify(e))}catch{this.clearOldStorageEntries();try{localStorage.setItem(n+t,JSON.stringify(e))}catch{}}}clearOldStorageEntries(){try{const t=Object.keys(localStorage).filter(s=>s.startsWith(n)).map(s=>{try{const a=JSON.parse(localStorage.getItem(s)||"{}");return{key:s,timestamp:a.timestamp||0}}catch{return{key:s,timestamp:0}}}).sort((s,a)=>s.timestamp-a.timestamp);t.slice(0,Math.floor(t.length/2)).forEach(({key:s})=>localStorage.removeItem(s))}catch{}}}const p=new m;function S(c,t){return c}function E(c){p.invalidate(c)}export{p as a,S as b,E as i};
