const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./D3S43Cfl.js","./C_QN0JMx.js","./ByEkyPua.js"])))=>i.map(i=>d[i]);
var S=Object.defineProperty;var k=(i,t,e)=>t in i?S(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var u=(i,t,e)=>k(i,typeof t!="symbol"?t+"":t,e);import{_ as y}from"./PPVm8Dsz.js";import{ac as f,d1 as w}from"./C_QN0JMx.js";import{getAuthToken as $}from"./D3S43Cfl.js";import"./1Dlf-fUy.js";const n="http://localhost:8000/api",_="ws://localhost:8000",p="http://localhost:8001/api",T=3e5,E=3,A=1e3,b="forms_offline_queue",C=10,O=3e4,m=class m{constructor(){u(this,"cache",new Map);u(this,"offlineQueue",[]);u(this,"wsConnection");u(this,"analyticsQueue",[]);u(this,"pendingRequests",new Map);u(this,"forms",f([]));u(this,"currentForm",f(null));u(this,"submissions",f([]));u(this,"isLoading",f(!1));u(this,"error",f(null));u(this,"offlineMode",f(!1));this.initialize()}static getInstance(){return m.instance||(m.instance=new m),m.instance}initialize(){this.loadOfflineQueue(),this.setupWebSocket(),this.setupOfflineDetection(),this.setupAutosave(),this.processAnalyticsQueue()}getAuthToken(){return $()||""}async authFetch(t,e={}){const{skipCache:s=!1,cacheTTL:r=T,retries:a=E,...o}=e,h=`${o.method||"GET"}:${t}`;if(!s&&!o.method||o.method==="GET"){const d=this.getFromCache(h);if(d)return d}if(this.pendingRequests.has(h))return this.pendingRequests.get(h);const l=this.executeRequest(t,o,a);this.pendingRequests.set(h,l);try{const d=await l;return(!o.method||o.method==="GET")&&this.setCache(h,d,r),d}finally{this.pendingRequests.delete(h)}}async executeRequest(t,e,s){const r=this.getAuthToken(),a={"Content-Type":"application/json",Accept:"application/json",...r?{Authorization:`Bearer ${r}`}:{},...e.headers};try{const o=await fetch(t,{...e,headers:a});if(!o.ok){if(o.status===401)try{const{authStore:l}=await y(async()=>{const{authStore:F}=await import("./D3S43Cfl.js");return{authStore:F}},__vite__mapDeps([0,1,2]),import.meta.url);if(await l.refreshToken()&&s>0)return this.executeRequest(t,e,s-1)}catch{await this.clearAuth()}const h=await o.json().catch(()=>({message:"Request failed"}));throw new Error(h.message||`HTTP ${o.status}`)}return o.json()}catch(o){if(s>0&&this.shouldRetry(o))return await new Promise(h=>setTimeout(h,A)),this.executeRequest(t,e,s-1);throw this.isNetworkError(o)?(this.queueOfflineRequest({url:t,options:e}),new Error("Request queued for offline processing")):o}}getFromCache(t){const e=this.cache.get(t);return e&&Date.now()<e.expiry?e.data:null}setCache(t,e,s){this.cache.set(t,{data:e,expiry:Date.now()+s})}clearCache(t){if(t)for(const e of this.cache.keys())e.includes(t)&&this.cache.delete(e);else this.cache.clear()}setupWebSocket(){if(this.getAuthToken())try{this.wsConnection=new WebSocket(`${_}/forms`),this.wsConnection.onopen=()=>{this.authenticate()},this.wsConnection.onmessage=t=>{this.handleWebSocketMessage(t)},this.wsConnection.onerror=t=>{},this.wsConnection.onclose=()=>{setTimeout(()=>this.setupWebSocket(),5e3)}}catch{}}authenticate(){this.wsConnection&&this.wsConnection.send(JSON.stringify({type:"auth",token:this.getAuthToken()}))}handleWebSocketMessage(t){try{const e=JSON.parse(t.data);switch(e.type){case"form_updated":this.handleFormUpdate(e.data);break;case"new_submission":this.handleNewSubmission(e.data);break;case"collaboration":this.handleCollaboration(e.data);break}}catch{}}handleFormUpdate(t){this.forms.update(s=>{const r=s.findIndex(a=>a.id===t.id);return r>=0?s[r]=t:s.push(t),s}),w(this.currentForm)?.id===t.id&&this.currentForm.set(t)}handleNewSubmission(t){this.submissions.update(e=>[...e,t]),this.showNotification(`New submission for form ${t.form_id}`)}handleCollaboration(t){}setupOfflineDetection(){window.addEventListener("online",()=>{this.offlineMode.set(!1),this.processOfflineQueue()}),window.addEventListener("offline",()=>{this.offlineMode.set(!0)})}loadOfflineQueue(){const t=localStorage.getItem(b);t&&(this.offlineQueue=JSON.parse(t))}saveOfflineQueue(){localStorage.setItem(b,JSON.stringify(this.offlineQueue))}queueOfflineRequest(t){this.offlineQueue.push({...t,timestamp:Date.now()}),this.saveOfflineQueue()}async processOfflineQueue(){if(this.offlineQueue.length!==0){for(const t of this.offlineQueue)try{await this.executeRequest(t.url,t.options,0)}catch{}this.offlineQueue=[],this.saveOfflineQueue()}}setupAutosave(){setInterval(()=>{const t=w(this.currentForm);t&&t.status==="draft"&&this.saveDraft(t)},O)}async saveDraft(t){try{await this.updateForm(t.id,{...t,status:"draft"})}catch{}}trackEvent(t,e){this.analyticsQueue.push({event:t,data:e,timestamp:Date.now()}),this.analyticsQueue.length>=C&&this.flushAnalytics()}async flushAnalytics(){if(this.analyticsQueue.length===0)return;const t=[...this.analyticsQueue];this.analyticsQueue=[];try{await this.authFetch(`${n}/forms/analytics/track`,{method:"POST",body:JSON.stringify({events:t}),skipCache:!0})}catch{this.analyticsQueue.unshift(...t)}}processAnalyticsQueue(){setInterval(()=>this.flushAnalytics(),6e4)}shouldRetry(t){return t?.message?.includes("Network")||t?.message?.includes("fetch")}isNetworkError(t){return!navigator.onLine||t?.message?.includes("Network")}async clearAuth(){const{authStore:t}=await y(async()=>{const{authStore:e}=await import("./D3S43Cfl.js");return{authStore:e}},__vite__mapDeps([0,1,2]),import.meta.url);await t.logout("/login")}showNotification(t){}async getForms(t=1,e=20,s){this.isLoading.set(!0),this.error.set(null);try{const r=new URLSearchParams({page:t.toString(),per_page:e.toString()});s?.status&&r.set("status",s.status);const a=await this.authFetch(`${n}/forms?${r}`);let o=[],h=0,l=e;return a?.data?.data?(o=a.data.data,h=a.data.total||o.length,l=a.data.per_page||e):a?.data&&Array.isArray(a.data)?(o=a.data,h=o.length):a?.forms?(o=a.forms,h=a.total??o.length,l=a.perPage??e):Array.isArray(a)&&(o=a,h=o.length),this.forms.set(o),{forms:o,total:h,perPage:l}}catch(r){throw this.error.set(r.message),r}finally{this.isLoading.set(!1)}}async getForm(t){this.isLoading.set(!0),this.error.set(null);try{const e=await this.authFetch(`${n}/forms/${t}`);return this.currentForm.set(e),this.trackEvent("form_viewed",{form_id:t}),e}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async createForm(t){this.isLoading.set(!0),this.error.set(null);try{const e=await this.authFetch(`${n}/forms`,{method:"POST",body:JSON.stringify(t),skipCache:!0});return this.forms.update(s=>[...s,e]),this.clearCache("/forms"),this.trackEvent("form_created",{form_id:e.id}),e}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async updateForm(t,e){this.isLoading.set(!0),this.error.set(null);try{this.forms.update(r=>{const a=r.findIndex(o=>o.id===t);return a>=0&&(r[a]={...r[a],...e}),r});const s=await this.authFetch(`${n}/forms/${t}`,{method:"PUT",body:JSON.stringify(e),skipCache:!0});return this.clearCache(`/forms/${t}`),this.trackEvent("form_updated",{form_id:t}),s}catch(s){throw await this.getForms(),this.error.set(s.message),s}finally{this.isLoading.set(!1)}}async deleteForm(t){this.isLoading.set(!0),this.error.set(null);try{this.forms.update(e=>e.filter(s=>s.id!==t)),await this.authFetch(`${n}/forms/${t}`,{method:"DELETE",skipCache:!0}),this.clearCache("/forms"),this.trackEvent("form_deleted",{form_id:t})}catch(e){throw await this.getForms(),this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async duplicateForm(t){this.isLoading.set(!0),this.error.set(null);try{const e=await this.authFetch(`${n}/forms/${t}/duplicate`,{method:"POST",skipCache:!0});return this.forms.update(s=>[...s,e]),this.trackEvent("form_duplicated",{original_id:t,new_id:e.id}),e}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async generateFormWithAI(t){this.isLoading.set(!0),this.error.set(null);try{const e=await this.authFetch(`${p}/generate-form`,{method:"POST",body:JSON.stringify({prompt:t}),skipCache:!0});return this.trackEvent("ai_form_generated",{prompt:t}),e.form}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async suggestFields(t){try{return(await this.authFetch(`${p}/suggest-fields`,{method:"POST",body:JSON.stringify({context:t}),skipCache:!0})).fields}catch{return[]}}async optimizeForm(t){this.isLoading.set(!0),this.error.set(null);try{const e=await this.authFetch(`${p}/optimize-form/${t}`,{method:"POST",skipCache:!0});return this.trackEvent("form_optimized",{form_id:t}),e.form}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async submitForm(t,e){try{const r=await(await fetch(`${n}/forms/${t}/submit`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)})).json();return this.trackEvent("form_submitted",{form_slug:t,success:r.success}),r}catch(s){if(this.isNetworkError(s))return this.queueOfflineRequest({url:`${n}/forms/${t}/submit`,options:{method:"POST",body:JSON.stringify(e)}}),{success:!1,message:"Your submission has been queued and will be sent when you're back online."};throw s}}async getSubmissions(t,e=1,s=20,r){this.isLoading.set(!0),this.error.set(null);try{const a=new URLSearchParams({page:e.toString(),perPage:s.toString(),...r}),o=await this.authFetch(`${n}/forms/${t}/submissions?${a}`);return this.submissions.set(o.submissions),o}catch(a){throw this.error.set(a.message),a}finally{this.isLoading.set(!1)}}async exportSubmissions(t,e="csv"){const s=this.getAuthToken(),r=await fetch(`${n}/forms/${t}/submissions/export?format=${e}`,{headers:{Accept:e==="csv"?"text/csv":"application/octet-stream",...s?{Authorization:`Bearer ${s}`}:{}}});if(!r.ok)throw new Error("Export failed");return r.blob()}async getFormAnalytics(t){return this.authFetch(`${n}/forms/${t}/analytics`)}async getConversionFunnel(t){return this.authFetch(`${n}/forms/${t}/analytics/funnel`)}async getFieldHeatmap(t){return this.authFetch(`${n}/forms/${t}/analytics/heatmap`)}async getUserRecording(t){return this.authFetch(`${n}/submissions/${t}/recording`)}async createABTest(t,e){return this.authFetch(`${n}/forms/${t}/ab-test`,{method:"POST",body:JSON.stringify(e),skipCache:!0})}async getABTestResults(t,e){return this.authFetch(`${n}/forms/${t}/ab-test/${e}/results`)}joinCollaboration(t){this.wsConnection&&this.wsConnection.send(JSON.stringify({type:"join_collaboration",form_id:t}))}leaveCollaboration(t){this.wsConnection&&this.wsConnection.send(JSON.stringify({type:"leave_collaboration",form_id:t}))}sendCollaborationUpdate(t,e){this.wsConnection&&this.wsConnection.send(JSON.stringify({type:"collaboration_update",form_id:t,update:e}))}async validateField(t,e){const s=[];if(t.required&&!e&&s.push(`${t.label} is required`),t.validation&&(typeof e=="string"&&(t.validation.min_length&&e.length<t.validation.min_length&&s.push(`${t.label} must be at least ${t.validation.min_length} characters`),t.validation.max_length&&e.length>t.validation.max_length&&s.push(`${t.label} must be no more than ${t.validation.max_length} characters`)),t.validation.pattern&&(new RegExp(t.validation.pattern).test(e)||s.push(t.validation.pattern_message||`${t.label} format is invalid`)),t.validation.async))try{const r=await this.authFetch(`${n}/validate`,{method:"POST",body:JSON.stringify({field:t,value:e}),skipCache:!0});!r.valid&&r.message&&s.push(r.message)}catch{}return{valid:s.length===0,errors:s}}async getFormTemplates(t){const e=t?`?category=${t}`:"";return this.authFetch(`${n}/forms/templates${e}`)}async createFromTemplate(t){const e=await this.authFetch(`${n}/forms/templates/${t}/use`,{method:"POST",skipCache:!0});return this.forms.update(s=>[...s,e]),this.trackEvent("template_used",{template_id:t}),e}};u(m,"instance");let g=m;const c=g.getInstance();c.forms;c.currentForm;c.submissions;c.isLoading;c.error;c.offlineMode;const q=(i,t,e)=>c.getForms(i,t,e),P=i=>c.getForm(i),Q=i=>c.createForm(i),I=(i,t)=>c.updateForm(i,t),J=i=>c.deleteForm(i),j=i=>c.duplicateForm(i),D=(i,t)=>c.submitForm(i,t),U=async i=>{const t=await fetch(`${n}/forms/preview/${i}`);if(!t.ok)throw new Error("Form not found");return t.json()},B=(i,t,e,s)=>c.getSubmissions(i,t,e,s),z=(i,t)=>c.exportSubmissions(i,t),M=i=>c.updateForm(i,{status:"published"}),W=i=>c.updateForm(i,{status:"draft"}),Y=i=>c.updateForm(i,{status:"archived"}),H=async(i,t,e)=>{const s=localStorage.getItem("access_token"),r=await fetch(`${n}/forms/${i}/submissions/${t}/status`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({status:e})});if(!r.ok)throw new Error("Failed to update submission status");return r.json()},V=async(i,t)=>{const e=localStorage.getItem("access_token"),s=await fetch(`${n}/forms/${i}/submissions/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}});if(!s.ok)throw new Error("Failed to delete submission");return s.json()},G=async(i,t,e)=>{const s=localStorage.getItem("access_token"),r=await fetch(`${n}/forms/${i}/submissions/bulk-update-status`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({submission_ids:t,status:e})});if(!r.ok)throw new Error("Failed to bulk update submissions");return r.json()},K=async(i,t)=>{const e=localStorage.getItem("access_token"),s=await fetch(`${n}/forms/${i}/submissions/bulk-delete`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({submission_ids:t})});if(!s.ok)throw new Error("Failed to bulk delete submissions");return s.json()},X=i=>c.getFormAnalytics(i),Z=()=>[{type:"text",label:"Text Input",icon:"text"},{type:"email",label:"Email",icon:"mail"},{type:"number",label:"Number",icon:"hash"},{type:"textarea",label:"Text Area",icon:"align-left"},{type:"select",label:"Dropdown",icon:"chevron-down"},{type:"radio",label:"Radio Buttons",icon:"circle-dot"},{type:"checkbox",label:"Checkboxes",icon:"square-check"},{type:"date",label:"Date",icon:"calendar"},{type:"file",label:"File Upload",icon:"upload"}];export{J as a,Y as b,X as c,j as d,B as e,P as f,q as g,Z as h,I as i,Q as j,z as k,G as l,K as m,H as n,V as o,M as p,U as q,D as s,W as u};
