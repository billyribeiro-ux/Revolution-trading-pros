var $=Object.defineProperty;var P=(e,t,s)=>t in e?$(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var l=(e,t,s)=>P(e,typeof t!="symbol"?t+"":t,s);import{authStore as f}from"./D3S43Cfl.js";const C={},T=C.VITE_API_BASE_URL||"http://localhost:8000/api",S="v1",g=3e4,w=3,R=1e3,O=300*1e3,A=6,k=5,N=6e4;class u extends Error{constructor(t,s,n,i){super(t),this.status=s,this.response=n,this.request=i,this.name="AdminApiError",Object.setPrototypeOf(this,u.prototype)}get isNetworkError(){return this.status===0}get isAuthError(){return this.status===401||this.status===403}get isValidationError(){return this.status===422}get isServerError(){return this.status>=500}get validationErrors(){return this.response?.errors}get isClientError(){return this.status>=400&&this.status<500}get shouldRetry(){return this.isNetworkError||this.isServerError||this.status===429}}class q extends u{constructor(t="Request timeout",s){super(t,0,void 0,s),this.name="ApiTimeoutError"}}class J extends u{constructor(t,s){super("Rate limit exceeded",429,void 0,s),this.retryAfter=t,this.name="ApiRateLimitError"}}class _{constructor(){l(this,"cache",new Map);l(this,"pendingRequests",new Map);l(this,"requestQueue",[]);l(this,"activeRequests",0);l(this,"circuitBreaker",{failures:0,lastFailure:0,isOpen:!1})}getCacheKey(t,s){const n=s?.method||"GET",i=s?.body||"";return`${n}:${t}:${i}`}isCacheValid(t){const s=this.cache.get(t);return s?Date.now()<s.expiry:!1}getCached(t,s){const n=this.getCacheKey(t,s);return this.isCacheValid(n)&&this.cache.get(n)?.data||null}setCached(t,s,n,i=O){const d=this.getCacheKey(t,n);this.cache.set(d,{data:s,expiry:Date.now()+i})}clearCache(t){if(t)for(const s of this.cache.keys())s.includes(t)&&this.cache.delete(s);else this.cache.clear()}async deduplicateRequest(t,s){if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const n=s().finally(()=>{this.pendingRequests.delete(t)});return this.pendingRequests.set(t,n),n}async queueRequest(t){if(this.circuitBreaker.isOpen){if(Date.now()-this.circuitBreaker.lastFailure<N)throw new u("Circuit breaker is open",503);this.circuitBreaker.isOpen=!1,this.circuitBreaker.failures=0}for(;this.activeRequests>=A;)await new Promise(s=>setTimeout(s,100));this.activeRequests++;try{const s=await t();return this.circuitBreaker.failures=0,s}catch(s){throw this.circuitBreaker.failures++,this.circuitBreaker.lastFailure=Date.now(),this.circuitBreaker.failures>=k&&(this.circuitBreaker.isOpen=!0),s}finally{this.activeRequests--}}}const a=new _;async function r(e,t={}){const s=f.getToken();if(!s)throw new u("Not authenticated",401);const n=`${T}${e}`,{skipCache:i=!1,cacheTTL:d=O,retries:p=w,...o}=t;if(!i&&o.method==="GET"){const y=a.getCached(e,o);if(y)return y}const c=`${o.method||"GET"}:${e}`;return a.deduplicateRequest(c,async()=>a.queueRequest(async()=>E(n,{...o,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${s}`,"X-API-Version":S,"X-Request-ID":v(),...o.headers}},p,e,d)))}async function E(e,t,s,n,i){const d=new AbortController,p=setTimeout(()=>d.abort(),g);try{const o=performance.now(),c=await fetch(e,{...t,signal:d.signal}),y=performance.now()-o;if(U(n,t.method||"GET",y,c.status),c.status===429){const b=parseInt(c.headers.get("Retry-After")||"60",10);throw new J(b,e)}let h;if(c.headers.get("content-type")?.includes("application/json")?h=await c.json():h={data:await c.text()},!c.ok)throw new u(h.message||`Request failed with status ${c.status}`,c.status,h,e);return(t.method==="GET"||!t.method)&&a.setCached(n,h,t,i),h}catch(o){if(clearTimeout(p),o instanceof Error&&o.name==="AbortError")throw new q(`Request timeout after ${g}ms`,e);if(o instanceof u&&o.shouldRetry&&s>0){const c=R*Math.pow(2,w-s);return await new Promise(y=>setTimeout(y,c)),E(e,t,s-1,n,i)}throw I(n,o),o}finally{clearTimeout(p)}}function v(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}function U(e,t,s,n){typeof window<"u"&&"gtag"in window&&window.gtag("event","api_request",{event_category:"api",event_label:e,value:Math.round(s),custom_parameters:{method:t,status:n,duration:s}})}function I(e,t){typeof window<"u"&&"Sentry"in window&&window.Sentry.captureException(t,{tags:{api_endpoint:e}})}function m(e){const t=new URLSearchParams;for(const[n,i]of Object.entries(e))i!=null&&i!==""&&(Array.isArray(i)?i.forEach(d=>t.append(`${n}[]`,String(d))):t.append(n,String(i)));const s=t.toString();return s?`?${s}`:""}const x={async list(e){const t=e?m(e):"";return r(`/admin/coupons${t}`)},async get(e){return r(`/admin/coupons/${e}`)},async create(e){const t=await r("/admin/coupons",{method:"POST",body:JSON.stringify(e)});return a.clearCache("/admin/coupons"),t},async update(e,t){const s=await r(`/admin/coupons/${e}`,{method:"PUT",body:JSON.stringify(t)});return a.clearCache("/admin/coupons"),s},async delete(e){const t=await r(`/admin/coupons/${e}`,{method:"DELETE"});return a.clearCache("/admin/coupons"),t},async validate(e){return r("/admin/coupons/validate",{method:"POST",body:JSON.stringify({code:e})})},async checkCode(e){return r("/admin/coupons/check-code",{method:"POST",body:JSON.stringify({code:e})})},async generateCode(e){return r("/admin/coupons/generate-code",{method:"POST",body:JSON.stringify(e)})},async import(e){const t=f.getToken(),s=await fetch(`${T}/admin/coupons/import`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"X-API-Version":S},body:e});if(!s.ok){const i=await s.json();throw new u(i.message||"Import failed",s.status,i)}const n=await s.json();return a.clearCache("/admin/coupons"),n},async test(e){return r("/admin/coupons/test",{method:"POST",body:JSON.stringify(e),skipCache:!0})},async preview(e){return r("/admin/coupons/preview",{method:"POST",body:JSON.stringify(e),skipCache:!0})}},M={async list(e){const t=e?m(e):"";return r(`/admin/users${t}`)},async get(e){return r(`/admin/users/${e}`)},async create(e){const t=await r("/admin/users",{method:"POST",body:JSON.stringify(e)});return a.clearCache("/admin/users"),t},async update(e,t){const s=await r(`/admin/users/${e}`,{method:"PUT",body:JSON.stringify(t)});return a.clearCache("/admin/users"),s},async delete(e){const t=await r(`/admin/users/${e}`,{method:"DELETE"});return a.clearCache("/admin/users"),t},async stats(){return r("/admin/users/stats",{cacheTTL:6e4})},async impersonate(e){return r(`/admin/users/${e}/impersonate`,{method:"POST"})}},V={async list(e){const t=e?m(e):"";return r(`/admin/email/templates${t}`)},async get(e){return r(`/admin/email/templates/${e}`)},async create(e){const t=await r("/admin/email/templates",{method:"POST",body:JSON.stringify(e)});return a.clearCache("/admin/email/templates"),t},async update(e,t){const s=await r(`/admin/email/templates/${e}`,{method:"PUT",body:JSON.stringify(t)});return a.clearCache("/admin/email/templates"),s},async delete(e){const t=await r(`/admin/email/templates/${e}`,{method:"DELETE"});return a.clearCache("/admin/email/templates"),t},async preview(e,t){return r(`/admin/email/templates/${e}/preview`,{method:"POST",body:JSON.stringify(t),skipCache:!0})},async sendTest(e,t){return r(`/admin/email/templates/${e}/test`,{method:"POST",body:JSON.stringify({email:t})})}},j={async list(e){const t=e?m(e):"";return r(`/admin/products${t}`)},async get(e){return r(`/admin/products/${e}`)},async create(e){const t=await r("/admin/products",{method:"POST",body:JSON.stringify(e)});return a.clearCache("/admin/products"),t},async update(e,t){const s=await r(`/admin/products/${e}`,{method:"PUT",body:JSON.stringify(t)});return a.clearCache("/admin/products"),s},async delete(e){const t=await r(`/admin/products/${e}`,{method:"DELETE"});return a.clearCache("/admin/products"),t},async byType(e){return r(`/admin/products/type/${e}`)},async stats(){return r("/admin/products/stats",{cacheTTL:6e4})},async assignToUser(e,t,s){const n=await r(`/admin/products/${e}/assign-user`,{method:"POST",body:JSON.stringify({user_id:t,order_id:s})});return a.clearCache(`/admin/products/${e}/users`),n},async removeFromUser(e,t){const s=await r(`/admin/products/${e}/remove-user`,{method:"POST",body:JSON.stringify({user_id:t})});return a.clearCache(`/admin/products/${e}/users`),s},async productUsers(e){return r(`/admin/products/${e}/users`)},async bulkUpdate(e,t){const s=await r("/admin/products/bulk-update",{method:"POST",body:JSON.stringify({ids:e,data:t})});return a.clearCache("/admin/products"),s}},F={async list(e){const t=e?m(e):"";return r(`/admin/categories${t}`)},async get(e){return r(`/admin/categories/${e}`)},async create(e){return r("/admin/categories",{method:"POST",body:JSON.stringify(e)})},async update(e,t){return r(`/admin/categories/${e}`,{method:"PUT",body:JSON.stringify(t)})},async delete(e){return r(`/admin/categories/${e}`,{method:"DELETE"})},async bulkDelete(e){return r("/admin/categories/bulk-delete",{method:"POST",body:JSON.stringify({ids:e})})},async bulkUpdateVisibility(e,t){return r("/admin/categories/bulk-update-visibility",{method:"POST",body:JSON.stringify({ids:e,is_visible:t})})},async reorder(e){return r("/admin/categories/reorder",{method:"POST",body:JSON.stringify({orders:e})})},async merge(e,t){return r("/admin/categories/merge",{method:"POST",body:JSON.stringify({source_ids:e,target_id:t})})},async export(){return r("/admin/categories/export",{method:"POST"})},async stats(){return r("/admin/categories/stats")}},K={async list(e){const t=e?m(e):"";return r(`/admin/tags${t}`)},async get(e){return r(`/admin/tags/${e}`)},async create(e){return r("/admin/tags",{method:"POST",body:JSON.stringify(e)})},async update(e,t){return r(`/admin/tags/${e}`,{method:"PUT",body:JSON.stringify(t)})},async delete(e){return r(`/admin/tags/${e}`,{method:"DELETE"})},async bulkDelete(e){return r("/admin/tags/bulk-delete",{method:"POST",body:JSON.stringify({ids:e})})},async bulkUpdateVisibility(e,t){return r("/admin/tags/bulk-update-visibility",{method:"POST",body:JSON.stringify({ids:e,is_visible:t})})},async reorder(e){return r("/admin/tags/reorder",{method:"POST",body:JSON.stringify({orders:e})})},async merge(e,t){return r("/admin/tags/merge",{method:"POST",body:JSON.stringify({source_ids:e,target_id:t})})},async export(){return r("/admin/tags/export",{method:"POST"})},async stats(){return r("/admin/tags/stats")}},G={async list(e){const t=e?m(e):"";return r(`/admin/segments${t}`)},async get(e){return r(`/admin/segments/${e}`)},async create(e){const t=await r("/admin/segments",{method:"POST",body:JSON.stringify(e)});return a.clearCache("/admin/segments"),t},async update(e,t){const s=await r(`/admin/segments/${e}`,{method:"PUT",body:JSON.stringify(t)});return a.clearCache("/admin/segments"),s},async delete(e){const t=await r(`/admin/segments/${e}`,{method:"DELETE"});return a.clearCache("/admin/segments"),t},async calculate(e){return r(`/admin/segments/${e}/calculate`,{method:"POST",skipCache:!0})},async stats(){return r("/admin/segments/stats",{cacheTTL:6e4})}};export{u as A,x as a,F as c,V as e,j as p,G as s,K as t,M as u};
