var k=Object.defineProperty;var $=(u,t,e)=>t in u?k(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e;var o=(u,t,e)=>$(u,typeof t!="symbol"?t+"":t,e);import{ac as h,ab as f,d1 as v}from"./C_QN0JMx.js";import{getAuthToken as T}from"./D3S43Cfl.js";const i="http://localhost:8000/api",l="http://localhost:8001/api",C=3e5,b=6e4,S=3e3,F=6e4,p=class p{constructor(){o(this,"cache",new Map);o(this,"wsConnection");o(this,"analyticsInterval");o(this,"pendingValidations",new Map);o(this,"fraudCheckCache",new Map);o(this,"coupons",h([]));o(this,"campaigns",h([]));o(this,"activeCoupons",h([]));o(this,"metrics",h({}));o(this,"currentCoupon",h(null));o(this,"validationResult",h(null));o(this,"isLoading",h(!1));o(this,"error",h(null));o(this,"activeCampaigns",f(this.campaigns,t=>t.filter(e=>e.status==="active")));o(this,"topPerformingCoupons",f([this.coupons,this.metrics],([t,e])=>t.filter(s=>e[s.id]).sort((s,a)=>(e[a.id]?.roi||0)-(e[s.id]?.roi||0)).slice(0,10)));o(this,"expiringCoupons",f(this.coupons,t=>{const e=new Date;return e.setDate(e.getDate()+7),t.filter(s=>{if(!s.expiryDate)return!1;const a=new Date(s.expiryDate);return a<=e&&a>=new Date})}));this.initialize()}static getInstance(){return p.instance||(p.instance=new p),p.instance}initialize(){this.setupWebSocket(),this.startAnalyticsCollection(),this.loadInitialData(),this.setupFraudDetection()}getAuthToken(){return T()||""}async authFetch(t,e={}){const{skipCache:s=!1,cacheTTL:a=C,...n}=e,r=`${n.method||"GET"}:${t}`;if(!s&&(!n.method||n.method==="GET")){const d=this.getFromCache(r);if(d)return d}try{const d=this.getAuthToken(),m=await fetch(t,{...n,headers:{"Content-Type":"application/json",Accept:"application/json",...d&&{Authorization:`Bearer ${d}`},...n.headers}});if(!m.ok){const w=await m.json();throw new Error(w.message||`HTTP ${m.status}`)}const g=await m.json();return(!n.method||n.method==="GET")&&this.setCache(r,g,a),g}catch(d){throw d}}setupWebSocket(){}subscribeToUpdates(){this.wsConnection?.send(JSON.stringify({type:"subscribe",channels:["coupons","campaigns","redemptions","metrics"]}))}handleWebSocketMessage(t){try{const e=JSON.parse(t.data);switch(e.type){case"coupon_updated":this.handleCouponUpdate(e.data);break;case"redemption":this.handleRedemption(e.data);break;case"campaign_update":this.handleCampaignUpdate(e.data);break;case"metrics_update":this.handleMetricsUpdate(e.data);break;case"fraud_alert":this.handleFraudAlert(e.data);break}}catch{}}handleCouponUpdate(t){this.coupons.update(e=>{const s=e.findIndex(a=>a.id===t.id);return s>=0?e[s]=t:e.push(t),e})}handleRedemption(t){this.metrics.update(e=>{const s=e[t.couponId]||this.createEmptyMetrics();return s.totalRedemptions++,s.totalRevenue+=t.orderTotal,e[t.couponId]=s,e}),this.coupons.update(e=>{const s=e.find(a=>a.id===t.couponId);return s&&s.currentUses++,e}),this.showNotification(`Coupon ${t.code} redeemed!`,"success")}handleCampaignUpdate(t){this.campaigns.update(e=>{const s=e.findIndex(a=>a.id===t.id);return s>=0?e[s]=t:e.push(t),e})}handleMetricsUpdate(t){this.metrics.update(e=>(e[t.couponId]=t.metrics,e))}handleFraudAlert(t){this.showNotification(`Fraud detected: ${t.message}`,"error")}async loadInitialData(){try{let t=[];try{t=await this.getAllCoupons()}catch{}try{await this.getCampaigns()}catch{}const e=t.filter(s=>s.isActive);for(const s of e.slice(0,10))try{await this.getCouponMetrics(s.id)}catch{}}catch{}}startAnalyticsCollection(){this.analyticsInterval=window.setInterval(()=>{this.updateAnalytics()},F)}async updateAnalytics(){const t=v(this.activeCoupons);for(const e of t)try{const s=await this.getCouponMetrics(e.id);this.metrics.update(a=>(a[e.id]=s,a))}catch{}}setupFraudDetection(){}async validateCoupon(t,e){this.isLoading.set(!0),this.error.set(null);const s=`validate_${t}_${e.cartTotal}`,a=this.getFromCache(s);if(a)return this.validationResult.set(a),this.isLoading.set(!1),a;if(this.pendingValidations.has(s))return this.pendingValidations.get(s);const n=this.performValidation(t,e);this.pendingValidations.set(s,n);try{const r=await n;return r.valid&&this.setCache(s,r,b),this.validationResult.set(r),this.trackEvent("coupon_validated",{code:t,valid:r.valid,discount:r.discount}),r}catch(r){throw this.error.set(r.message),r}finally{this.pendingValidations.delete(s),this.isLoading.set(!1)}}async performValidation(t,e){const s=await this.checkFraud(t,e);if(s.status==="blocked")return{valid:!1,discount:0,message:"Coupon validation failed",fraudScore:s.score};const a=await this.authFetch(`${i}/coupons/validate`,{method:"POST",body:JSON.stringify({code:t,...e}),skipCache:!0});if(a.fraudScore=s.score,a.valid&&a.coupon?.stackable){const n=await this.findStackableDiscounts(a.coupon,e);n.length>0&&(a.stackedDiscounts=n,a.discount=this.calculateStackedDiscount(a.discount,n))}return a}async checkFraud(t,e){const s=`fraud_${e.sessionId||e.ipAddress}`,a=this.fraudCheckCache.get(s);if(a)return a;try{const n=await Promise.race([this.authFetch(`${l}/fraud/check`,{method:"POST",body:JSON.stringify({code:t,...e}),skipCache:!0}),new Promise(r=>setTimeout(()=>r({score:0,status:"safe",reasons:[],recommendations:[]}),S))]);return this.fraudCheckCache.set(s,n),n}catch{return{score:0,status:"safe",reasons:[],recommendations:[]}}}async findStackableDiscounts(t,e){try{return(await this.authFetch(`${i}/coupons/stackable`,{method:"POST",body:JSON.stringify({couponId:t.id,...e})})).discounts}catch{return[]}}calculateStackedDiscount(t,e){let s=t;for(const a of e)a.type==="percentage"?s=s*(1+a.discount/100):s+=a.discount;return Math.min(s,100)}async getAllCoupons(t){this.isLoading.set(!0),this.error.set(null);try{const e=new URLSearchParams(t),s=await this.authFetch(`${i}/admin/coupons?${e}`);this.coupons.set(s.coupons||[]);const a=s.coupons.filter(n=>n.isActive);return this.activeCoupons.set(a),s.coupons}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async createCoupon(t,e){this.isLoading.set(!0),this.error.set(null);try{e?.generateCode&&(t.code=await this.generateCouponCode(t)),e?.optimize&&(t=await this.optimizeCoupon(t));const s=await this.authFetch(`${i}/admin/coupons`,{method:"POST",body:JSON.stringify(t),skipCache:!0});return this.coupons.update(a=>[...a,s]),this.trackEvent("coupon_created",{id:s.id,code:s.code,type:s.type}),s}catch(s){throw this.error.set(s.message),s}finally{this.isLoading.set(!1)}}async updateCoupon(t,e){this.isLoading.set(!0),this.error.set(null);try{const s=await this.authFetch(`${i}/admin/coupons/${t}`,{method:"PUT",body:JSON.stringify(e),skipCache:!0});return this.handleCouponUpdate(s),this.clearCache(`/coupons/${t}`),s}catch(s){throw this.error.set(s.message),s}finally{this.isLoading.set(!1)}}async deleteCoupon(t){this.isLoading.set(!0),this.error.set(null);try{await this.authFetch(`${i}/admin/coupons/${t}`,{method:"DELETE",skipCache:!0}),this.coupons.update(e=>e.filter(s=>s.id!==t)),this.clearCache("/coupons"),this.trackEvent("coupon_deleted",{id:t})}catch(e){throw this.error.set(e.message),e}finally{this.isLoading.set(!1)}}async bulkCreateCoupons(t){const e=await this.authFetch(`${i}/admin/coupons/bulk-create`,{method:"POST",body:JSON.stringify({coupons:t}),skipCache:!0});return this.monitorBulkOperation(e.id),e}async bulkUpdateCoupons(t){return this.authFetch(`${i}/admin/coupons/bulk-update`,{method:"POST",body:JSON.stringify({updates:t}),skipCache:!0})}async monitorBulkOperation(t){const e=async()=>{const s=await this.authFetch(`${i}/admin/operations/${t}`);s.status==="completed"||s.status==="failed"?(await this.getAllCoupons(),this.showNotification(`Bulk operation ${s.status}: ${s.processedItems}/${s.totalItems} items`,s.status==="completed"?"success":"error")):setTimeout(e,2e3)};e()}async getCampaigns(){try{const t=await this.authFetch(`${i}/admin/campaigns`);return this.campaigns.set(t.campaigns||[]),t.campaigns||[]}catch{return this.campaigns.set([]),[]}}async createCampaign(t){const e=await this.authFetch(`${i}/admin/campaigns`,{method:"POST",body:JSON.stringify(t),skipCache:!0});return this.campaigns.update(s=>[...s,e]),e}async launchCampaign(t){await this.authFetch(`${i}/admin/campaigns/${t}/launch`,{method:"POST",skipCache:!0}),this.campaigns.update(e=>{const s=e.find(a=>a.id===t);return s&&(s.status="active"),e})}async pauseCampaign(t){await this.authFetch(`${i}/admin/campaigns/${t}/pause`,{method:"POST",skipCache:!0})}async getCouponMetrics(t){const e=await this.authFetch(`${i}/admin/coupons/${t}/metrics`);return this.metrics.update(s=>(s[t]=e.metrics,s)),e.metrics}async getCouponAnalytics(t){return this.authFetch(`${i}/admin/coupons/${t}/analytics`)}async getRedemptionReport(t){return this.authFetch(`${i}/admin/reports/redemptions`,{method:"POST",body:JSON.stringify(t)})}async getROIReport(t){const e=t?`?campaign=${t}`:"";return this.authFetch(`${i}/admin/reports/roi${e}`)}async exportCoupons(t="csv"){const e=await fetch(`${i}/admin/coupons/export?format=${t}`,{headers:{Authorization:`Bearer ${this.getAuthToken()}`}});if(!e.ok)throw new Error("Export failed");return e.blob()}async generateCouponCode(t){return(await this.authFetch(`${l}/coupons/generate-code`,{method:"POST",body:JSON.stringify(t),skipCache:!0})).code}async optimizeCoupon(t){return(await this.authFetch(`${l}/coupons/optimize`,{method:"POST",body:JSON.stringify(t)})).optimized}async predictRedemptions(t){return(await this.authFetch(`${l}/coupons/${t}/predict-redemptions`)).predictions}async recommendSegments(t){return(await this.authFetch(`${l}/coupons/${t}/recommend-segments`)).segments}async getPersonalizedOffers(t){return(await this.authFetch(`${l}/customers/${t}/personalized-offers`)).offers}async createABTest(t){return(await this.authFetch(`${i}/admin/ab-tests`,{method:"POST",body:JSON.stringify(t),skipCache:!0})).testId}async getABTestResults(t){return this.authFetch(`${i}/admin/ab-tests/${t}/results`)}async concludeABTest(t,e){await this.authFetch(`${i}/admin/ab-tests/${t}/conclude`,{method:"POST",body:JSON.stringify({winnerId:e}),skipCache:!0})}getFromCache(t){const e=this.cache.get(t);return e&&Date.now()<e.expiry?e.data:null}setCache(t,e,s=C){this.cache.set(t,{data:e,expiry:Date.now()+s})}clearCache(t){if(t)for(const e of this.cache.keys())e.includes(t)&&this.cache.delete(e);else this.cache.clear()}createEmptyMetrics(){return{totalRedemptions:0,uniqueCustomers:0,totalRevenue:0,totalDiscount:0,averageOrderValue:0,conversionRate:0,roi:0}}showNotification(t,e="info"){}trackEvent(t,e){"gtag"in window&&window.gtag("event",t,e)}destroy(){this.wsConnection&&this.wsConnection.close(),this.analyticsInterval&&clearInterval(this.analyticsInterval),this.cache.clear(),this.fraudCheckCache.clear()}};o(p,"instance");let y=p;const c=y.getInstance();c.coupons;c.campaigns;c.activeCoupons;c.activeCampaigns;c.topPerformingCoupons;c.expiringCoupons;c.metrics;c.currentCoupon;c.validationResult;c.isLoading;c.error;const P=(u,t,e)=>c.validateCoupon(u,{cartTotal:t,...e});export{P as v};
