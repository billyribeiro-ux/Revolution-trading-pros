import{authStore as u}from"./D3S43Cfl.js";import{a as l,b as g,i as d}from"./CevrrlX8.js";const f="http://localhost:8000/api",w={memberships:180*1e3,membershipDetails:300*1e3,tradingRooms:120*1e3};async function y(){const t=u.getToken(),r={"Content-Type":"application/json",Accept:"application/json"};return t&&(r.Authorization=`Bearer ${t}`),r}class x extends Error{constructor(r,e){super(r),this.status=e,this.name="ApiError"}}async function A(t){if(!t.ok){const e=await t.json().catch(()=>({message:"Request failed"}));throw new x(e.message||"Request failed",t.status)}const r=await t.json();return r.data??r}function k(t){const r=t.filter(a=>a.type==="trading-room"),e=t.filter(a=>a.type==="alert-service"),s=t.filter(a=>a.type==="course"),i=t.filter(a=>a.type==="indicator"),n=t.filter(a=>a.type==="weekly-watchlist"),o=t.filter(a=>a.status==="active"||a.status==="expiring"),c=t.filter(a=>a.status==="expiring"),h=o.reduce((a,p)=>a+(p.price||0),0);return{memberships:t,tradingRooms:r,alertServices:e,courses:s,indicators:i,weeklyWatchlist:n,stats:{totalActive:o.length,totalValue:h,expiringCount:c.length}}}function m(t){const r=new Date;return t.map(e=>{const s={...e};if(e.nextBillingDate||e.expiresAt){const i=new Date(e.nextBillingDate||e.expiresAt),n=Math.ceil((i.getTime()-r.getTime())/(1e3*60*60*24));s.daysUntilExpiry=n,n<=7&&n>0&&e.status==="active"&&(s.status="expiring")}return s.accessUrl=v(e.type,e.slug),s})}function v(t,r){return`${{"trading-room":"/dashboard/trading-rooms","alert-service":"/dashboard/alerts",course:"/dashboard/courses",indicator:"/dashboard/indicators","weekly-watchlist":"/dashboard/weekly-watchlist"}[t]}/${r}`}async function C(t){if(!u.getToken())throw new Error("Not authenticated");const e=new URLSearchParams;t?.includeExpired&&e.append("include_expired","true");const s=`${f}/user/memberships${e.toString()?"?"+e:""}`,i=g(s);t?.skipCache&&l.delete(i);try{return await l.getOrFetch(i,async()=>{const n=await fetch(s,{method:"GET",headers:await y(),credentials:"include"}),o=await A(n),c=m(o.memberships||[]);return k(c)},{ttl:w.memberships,persist:!0})}catch(n){throw n}}function M(){d(/user\/memberships/),d(/trading-rooms/)}async function T(){await Promise.allSettled([C()])}export{C as g,M as i,T as p};
