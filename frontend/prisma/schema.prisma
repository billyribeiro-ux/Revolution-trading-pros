// ════════════════════════════════════════════════════════════════════════════
// Database Schema - Revolution Trading Pros CMS
// ════════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ════════════════════════════════════════════════════════════════════════════
// User Management
// ════════════════════════════════════════════════════════════════════════════

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  avatar        String?
  role          UserRole  @default(VIEWER)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  posts         Post[]
  sessions      Session[]
  activities    Activity[]

  @@index([email])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  EDITOR
  AUTHOR
  VIEWER
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// ════════════════════════════════════════════════════════════════════════════
// Content Management
// ════════════════════════════════════════════════════════════════════════════

model Post {
  id            String       @id @default(cuid())
  title         String
  slug          String       @unique
  excerpt       String?
  content       Json         // Array of Block objects
  featuredImage String?

  status        PostStatus   @default(DRAFT)
  visibility    Visibility   @default(PUBLIC)

  publishedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  authorId      String
  author        User         @relation(fields: [authorId], references: [id])

  // SEO
  metaTitle     String?
  metaDescription String?
  ogImage       String?

  // Relations
  categories    Category[]
  tags          Tag[]
  versions      PostVersion[]

  @@index([slug])
  @@index([status])
  @@index([authorId])
  @@index([publishedAt])
  @@map("posts")
}

enum PostStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

enum Visibility {
  PUBLIC
  PRIVATE
  PASSWORD_PROTECTED
}

model PostVersion {
  id        String   @id @default(cuid())
  postId    String
  content   Json
  createdAt DateTime @default(now())
  createdBy String

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("post_versions")
}

// ════════════════════════════════════════════════════════════════════════════
// Taxonomy
// ════════════════════════════════════════════════════════════════════════════

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?

  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  posts       Post[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@map("categories")
}

model Tag {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique

  posts     Post[]

  createdAt DateTime @default(now())

  @@index([slug])
  @@map("tags")
}

// ════════════════════════════════════════════════════════════════════════════
// Media Library
// ════════════════════════════════════════════════════════════════════════════

model Media {
  id          String     @id @default(cuid())
  filename    String
  url         String
  mimeType    String
  size        Int
  width       Int?
  height      Int?
  alt         String?
  caption     String?

  uploadedBy  String

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([mimeType])
  @@index([uploadedBy])
  @@map("media")
}

// ════════════════════════════════════════════════════════════════════════════
// Newsletter
// ════════════════════════════════════════════════════════════════════════════

model Subscriber {
  id            String            @id @default(cuid())
  email         String            @unique
  status        SubscriberStatus  @default(PENDING)

  subscribedAt  DateTime          @default(now())
  confirmedAt   DateTime?
  unsubscribedAt DateTime?

  @@index([email])
  @@index([status])
  @@map("subscribers")
}

enum SubscriberStatus {
  PENDING
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
}

// ════════════════════════════════════════════════════════════════════════════
// Activity Logging
// ════════════════════════════════════════════════════════════════════════════

model Activity {
  id          String   @id @default(cuid())
  userId      String
  action      String   // "post.created", "post.updated", "media.uploaded", etc.
  entityType  String?  // "post", "media", "user", etc.
  entityId    String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("activities")
}
