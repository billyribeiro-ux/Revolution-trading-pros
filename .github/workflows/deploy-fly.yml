# ===============================================================================
# Revolution Trading Pros - Fly.io API Deployment
# ===============================================================================
#
# Apple Principal Engineer ICT11+ CI/CD Pipeline
#
# Triggers:
# - Push to main: Deploy to production
# - Manual workflow dispatch
#
# ===============================================================================

name: Deploy API (Fly.io)

on:
  push:
    branches:
      - main
    paths:
      - 'api/**'
      - '.github/workflows/deploy-fly.yml'
  workflow_dispatch:

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        working-directory: api
        run: flyctl deploy --remote-only

      - name: Health check
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App:** revolution-trading-pros-api" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** iad" >> $GITHUB_STEP_SUMMARY

          # Wait for deployment to stabilize
          sleep 10

          # Health check
          HEALTH_URL="https://revolution-trading-pros-api.fly.dev/health"
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")

          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "**Health Check:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Health Check:** Failed (status: $HEALTH_STATUS)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Verify logs (no queue errors)
        run: |
          # Give the app time to start
          sleep 15

          # Check recent logs for the run_at error
          LOGS=$(flyctl logs --app revolution-trading-pros-api -n 20 2>&1 || echo "")

          if echo "$LOGS" | grep -q "column \"run_at\" does not exist"; then
            echo "ERROR: run_at column error still present in logs"
            echo "$LOGS"
            exit 1
          else
            echo "No run_at errors found in recent logs"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Queue Status:** No schema errors detected" >> $GITHUB_STEP_SUMMARY
          fi
